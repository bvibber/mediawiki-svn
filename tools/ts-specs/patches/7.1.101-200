To: vim-dev@vim.org
Subject: patch 7.1.101
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.101
Problem:    Ruby: The Buffer.line= method does not work.
Solution:   Add the "self" argument to set_current_line(). (Jonathan Hankins)
Files:	    src/if_ruby.c


*** ../vim-7.1.100/src/if_ruby.c	Sat May 12 15:01:49 2007
--- src/if_ruby.c	Mon Sep 10 10:40:38 2007
***************
*** 789,795 ****
      return get_buffer_line(curbuf, curwin->w_cursor.lnum);
  }
  
! static VALUE set_current_line(VALUE str)
  {
      return set_buffer_line(curbuf, curwin->w_cursor.lnum, str);
  }
--- 789,795 ----
      return get_buffer_line(curbuf, curwin->w_cursor.lnum);
  }
  
! static VALUE set_current_line(VALUE self, VALUE str)
  {
      return set_buffer_line(curbuf, curwin->w_cursor.lnum, str);
  }
*** ../vim-7.1.100/src/version.c	Thu Sep  6 17:38:06 2007
--- src/version.c	Thu Sep 13 14:59:47 2007
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     101,
  /**/

-- 
The question is:  What do you do with your life?
The wrong answer is: Become the richest guy in the graveyard.
				(billionaire and Oracle founder Larry Ellison)

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: patch 7.1.102
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.102
Problem:    Perl interface doesn't compile with new version of Perl.
Solution:   Add two variables to the dynamic library loading. (Suresh
	    Govindachar)
Files:	    src/if_perl.xs


*** ../vim-7.1.101/src/if_perl.xs	Wed Aug 16 19:33:57 2006
--- src/if_perl.xs	Wed Sep  5 22:00:36 2007
***************
*** 40,45 ****
--- 40,65 ----
  #    define PERL_SUBVERSION SUBVERSION
  #endif
  
+ /*
+  * Quoting Jan Dubois of Active State:
+  *    ActivePerl build 822 still identifies itself as 5.8.8 but already
+  *    contains many of the changes from the upcoming Perl 5.8.9 release.
+  *
+  * The changes include addition of two symbols (Perl_sv_2iv_flags,
+  * Perl_newXS_flags) not present in earlier releases.
+  *
+  * Jan Dubois suggested the following guarding scheme:
+  */
+ #if (ACTIVEPERL_VERSION >= 822)
+ # define PERL589_OR_LATER
+ #endif
+ #if (PERL_REVISION == 5) && (PERL_VERSION == 8) && (PERL_SUBVERSION >= 9)
+ # define PERL589_OR_LATER
+ #endif
+ #if (PERL_REVISION == 5) && (PERL_VERSION >= 9)
+ # define PERL589_OR_LATER
+ #endif
+ 
  #ifndef pTHX
  #    define pTHX void
  #    define pTHX_
***************
*** 109,114 ****
--- 129,138 ----
  # else
  #  define Perl_sv_catpvn dll_Perl_sv_catpvn
  # endif
+ #ifdef PERL589_OR_LATER
+ #  define Perl_sv_2iv_flags dll_Perl_sv_2iv_flags
+ #  define Perl_newXS_flags dll_Perl_newXS_flags
+ #endif
  # define Perl_sv_free dll_Perl_sv_free
  # define Perl_sv_isa dll_Perl_sv_isa
  # define Perl_sv_magic dll_Perl_sv_magic
***************
*** 192,197 ****
--- 216,225 ----
  #else
  static void (*Perl_sv_catpvn)(pTHX_ SV*, const char*, STRLEN);
  #endif
+ #ifdef PERL589_OR_LATER
+ static IV (*Perl_sv_2iv_flags)(pTHX_ SV* sv, I32 flags);
+ static CV * (*Perl_newXS_flags)(pTHX_ const char *name, XSUBADDR_t subaddr, const char *const filename, const char *const proto, U32 flags);
+ #endif
  static void (*Perl_sv_free)(pTHX_ SV*);
  static int (*Perl_sv_isa)(pTHX_ SV*, const char*);
  static void (*Perl_sv_magic)(pTHX_ SV*, SV*, int, const char*, I32);
***************
*** 266,271 ****
--- 294,303 ----
      {"Perl_sv_2pv_nolen", (PERL_PROC*)&Perl_sv_2pv_nolen},
  #else
      {"Perl_sv_2pv", (PERL_PROC*)&Perl_sv_2pv},
+ #endif
+ #ifdef PERL589_OR_LATER
+     {"Perl_sv_2iv_flags", (PERL_PROC*)&Perl_sv_2iv_flags},
+     {"Perl_newXS_flags", (PERL_PROC*)&Perl_newXS_flags},
  #endif
      {"Perl_sv_bless", (PERL_PROC*)&Perl_sv_bless},
  #if (PERL_REVISION == 5) && (PERL_VERSION >= 8)
*** ../vim-7.1.101/src/version.c	Thu Sep 13 15:00:28 2007
--- src/version.c	Thu Sep 13 15:18:36 2007
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     102,
  /**/

-- 
Witches prefer brooms: vacuum-cleaners need extension cords!

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: patch 7.1.103
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.103
Problem:    Using "dw" with the cursor past the end of the last line (using
            CTRL-\ CTRL-O from Insert mode) deletes a character. (Tim Chase)
Solution:   Don't move the cursor back when the movement failed.
Files:      src/normal.c


*** ../vim-7.1.102/src/normal.c	Tue Aug 14 22:54:00 2007
--- src/normal.c	Tue Sep 11 19:32:42 2007
***************
*** 8364,8370 ****
  	n = fwd_word(cap->count1, cap->arg, cap->oap->op_type != OP_NOP);
  
      /* Don't leave the cursor on the NUL past a line */
!     if (curwin->w_cursor.col && gchar_cursor() == NUL)
      {
  	--curwin->w_cursor.col;
  	cap->oap->inclusive = TRUE;
--- 8364,8370 ----
  	n = fwd_word(cap->count1, cap->arg, cap->oap->op_type != OP_NOP);
  
      /* Don't leave the cursor on the NUL past a line */
!     if (n != FAIL && curwin->w_cursor.col > 0 && gchar_cursor() == NUL)
      {
  	--curwin->w_cursor.col;
  	cap->oap->inclusive = TRUE;
*** ../vim-7.1.102/src/version.c	Thu Sep 13 15:19:32 2007
--- src/version.c	Thu Sep 13 15:32:05 2007
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     103,
  /**/

-- 
ARTHUR:  Then who is your lord?
WOMAN:   We don't have a lord.
ARTHUR:  What?
DENNIS:  I told you.  We're an anarcho-syndicalist commune.  We take it in
         turns to act as a sort of executive officer for the week.
                                  The Quest for the Holy Grail (Monty Python)

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: patch 7.1.104
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.104 (after 7.1.095)
Problem:    When 'lazyredraw' is set a focus event causes redraw to be
	    postponed until a key is pressed.
Solution:   Instead of not returning from vgetc() when a focus event is
	    encountered return K_IGNORE.  Add plain_vgetc() for when the
	    caller doesn't want to get K_IGNORE.
Files:	    src/digraph.c, src/edit.c, src/ex_cmds.c, src/ex_getln.c,
	    src/getchar.c, src/normal.c, src/proto/getchar.pro, src/window.c


*** ../vim-7.1.103/src/digraph.c	Sat Jul  7 13:57:39 2007
--- src/digraph.c	Thu Sep 13 16:11:54 2007
***************
*** 2028,2034 ****
  
      ++no_mapping;
      ++allow_keys;
!     c = safe_vgetc();
      --no_mapping;
      --allow_keys;
      if (c != ESC)		/* ESC cancels CTRL-K */
--- 2028,2034 ----
  
      ++no_mapping;
      ++allow_keys;
!     c = plain_vgetc();
      --no_mapping;
      --allow_keys;
      if (c != ESC)		/* ESC cancels CTRL-K */
***************
*** 2050,2056 ****
  #endif
  	++no_mapping;
  	++allow_keys;
! 	cc = safe_vgetc();
  	--no_mapping;
  	--allow_keys;
  	if (cc != ESC)	    /* ESC cancels CTRL-K */
--- 2050,2056 ----
  #endif
  	++no_mapping;
  	++allow_keys;
! 	cc = plain_vgetc();
  	--no_mapping;
  	--allow_keys;
  	if (cc != ESC)	    /* ESC cancels CTRL-K */
***************
*** 2350,2356 ****
      if (*curbuf->b_p_keymap == NUL)
      {
  	/* Stop any active keymap and clear the table.  Also remove
! 	 * b:keymap_unload, as no keymap is active now. */
  	keymap_unload();
  	do_cmdline_cmd((char_u *)"unlet! b:keymap_name");
      }
--- 2350,2356 ----
      if (*curbuf->b_p_keymap == NUL)
      {
  	/* Stop any active keymap and clear the table.  Also remove
! 	 * b:keymap_name, as no keymap is active now. */
  	keymap_unload();
  	do_cmdline_cmd((char_u *)"unlet! b:keymap_name");
      }
*** ../vim-7.1.103/src/edit.c	Sun Aug 12 16:38:03 2007
--- src/edit.c	Thu Sep 13 16:17:54 2007
***************
*** 788,794 ****
  	    ins_redraw(FALSE);
  	    ++no_mapping;
  	    ++allow_keys;
! 	    c = safe_vgetc();
  	    --no_mapping;
  	    --allow_keys;
  	    if (c != Ctrl_N && c != Ctrl_G && c != Ctrl_O)
--- 788,794 ----
  	    ins_redraw(FALSE);
  	    ++no_mapping;
  	    ++allow_keys;
! 	    c = plain_vgetc();
  	    --no_mapping;
  	    --allow_keys;
  	    if (c != Ctrl_N && c != Ctrl_G && c != Ctrl_O)
***************
*** 981,987 ****
  #ifdef FEAT_NETBEANS_INTG
  	case K_F21:	/* NetBeans command */
  	    ++no_mapping;		/* don't map the next key hits */
! 	    i = safe_vgetc();
  	    --no_mapping;
  	    netbeans_keycommand(i);
  	    break;
--- 981,987 ----
  #ifdef FEAT_NETBEANS_INTG
  	case K_F21:	/* NetBeans command */
  	    ++no_mapping;		/* don't map the next key hits */
! 	    i = plain_vgetc();
  	    --no_mapping;
  	    netbeans_keycommand(i);
  	    break;
***************
*** 5224,5233 ****
      i = 0;
      for (;;)
      {
! 	do
! 	    nc = safe_vgetc();
! 	while (nc == K_IGNORE || nc == K_VER_SCROLLBAR
! 						    || nc == K_HOR_SCROLLBAR);
  #ifdef FEAT_CMDL_INFO
  	if (!(State & CMDLINE)
  # ifdef FEAT_MBYTE
--- 5224,5230 ----
      i = 0;
      for (;;)
      {
! 	nc = plain_vgetc();
  #ifdef FEAT_CMDL_INFO
  	if (!(State & CMDLINE)
  # ifdef FEAT_MBYTE
***************
*** 7575,7581 ****
       * deleted when ESC is hit.
       */
      ++no_mapping;
!     regname = safe_vgetc();
  #ifdef FEAT_LANGMAP
      LANGMAP_ADJUST(regname, TRUE);
  #endif
--- 7572,7578 ----
       * deleted when ESC is hit.
       */
      ++no_mapping;
!     regname = plain_vgetc();
  #ifdef FEAT_LANGMAP
      LANGMAP_ADJUST(regname, TRUE);
  #endif
***************
*** 7586,7592 ****
  #ifdef FEAT_CMDL_INFO
  	add_to_showcmd_c(literally);
  #endif
! 	regname = safe_vgetc();
  #ifdef FEAT_LANGMAP
  	LANGMAP_ADJUST(regname, TRUE);
  #endif
--- 7583,7589 ----
  #ifdef FEAT_CMDL_INFO
  	add_to_showcmd_c(literally);
  #endif
! 	regname = plain_vgetc();
  #ifdef FEAT_LANGMAP
  	LANGMAP_ADJUST(regname, TRUE);
  #endif
***************
*** 7677,7683 ****
       * deleted when ESC is hit.
       */
      ++no_mapping;
!     c = safe_vgetc();
      --no_mapping;
      switch (c)
      {
--- 7674,7680 ----
       * deleted when ESC is hit.
       */
      ++no_mapping;
!     c = plain_vgetc();
      --no_mapping;
      switch (c)
      {
***************
*** 9356,9362 ****
       * mode message to be deleted when ESC is hit */
      ++no_mapping;
      ++allow_keys;
!     c = safe_vgetc();
      --no_mapping;
      --allow_keys;
      if (IS_SPECIAL(c) || mod_mask)	    /* special key */
--- 9353,9359 ----
       * mode message to be deleted when ESC is hit */
      ++no_mapping;
      ++allow_keys;
!     c = plain_vgetc();
      --no_mapping;
      --allow_keys;
      if (IS_SPECIAL(c) || mod_mask)	    /* special key */
***************
*** 9388,9394 ****
  	}
  	++no_mapping;
  	++allow_keys;
! 	cc = safe_vgetc();
  	--no_mapping;
  	--allow_keys;
  	if (cc != ESC)
--- 9385,9391 ----
  	}
  	++no_mapping;
  	++allow_keys;
! 	cc = plain_vgetc();
  	--no_mapping;
  	--allow_keys;
  	if (cc != ESC)
*** ../vim-7.1.103/src/ex_cmds.c	Tue Aug 21 15:28:32 2007
--- src/ex_cmds.c	Thu Sep 13 16:19:40 2007
***************
*** 4498,4504 ****
  	     *
  	     * The new text is built up in new_start[].  It has some extra
  	     * room to avoid using alloc()/free() too often.  new_start_len is
! 	     * the lenght of the allocated memory at new_start.
  	     *
  	     * Make a copy of the old line, so it won't be taken away when
  	     * updating the screen or handling a multi-line match.  The "old_"
--- 4499,4505 ----
  	     *
  	     * The new text is built up in new_start[].  It has some extra
  	     * room to avoid using alloc()/free() too often.  new_start_len is
! 	     * the length of the allocated memory at new_start.
  	     *
  	     * Make a copy of the old line, so it won't be taken away when
  	     * updating the screen or handling a multi-line match.  The "old_"
***************
*** 4669,4675 ****
  #endif
  			    ++no_mapping;	/* don't map this key */
  			    ++allow_keys;	/* allow special keys */
! 			    i = safe_vgetc();
  			    --allow_keys;
  			    --no_mapping;
  
--- 4670,4676 ----
  #endif
  			    ++no_mapping;	/* don't map this key */
  			    ++allow_keys;	/* allow special keys */
! 			    i = plain_vgetc();
  			    --allow_keys;
  			    --no_mapping;
  
*** ../vim-7.1.103/src/ex_getln.c	Mon Aug  6 22:27:12 2007
--- src/ex_getln.c	Thu Sep 13 16:20:49 2007
***************
*** 641,647 ****
  	{
  	    ++no_mapping;
  	    ++allow_keys;
! 	    c = safe_vgetc();
  	    --no_mapping;
  	    --allow_keys;
  	    /* CTRL-\ e doesn't work when obtaining an expression. */
--- 641,647 ----
  	{
  	    ++no_mapping;
  	    ++allow_keys;
! 	    c = plain_vgetc();
  	    --no_mapping;
  	    --allow_keys;
  	    /* CTRL-\ e doesn't work when obtaining an expression. */
***************
*** 1091,1101 ****
  #endif
  		putcmdline('"', TRUE);
  		++no_mapping;
! 		i = c = safe_vgetc();	/* CTRL-R <char> */
  		if (i == Ctrl_O)
  		    i = Ctrl_R;		/* CTRL-R CTRL-O == CTRL-R CTRL-R */
  		if (i == Ctrl_R)
! 		    c = safe_vgetc();	/* CTRL-R CTRL-R <char> */
  		--no_mapping;
  #ifdef FEAT_EVAL
  		/*
--- 1091,1101 ----
  #endif
  		putcmdline('"', TRUE);
  		++no_mapping;
! 		i = c = plain_vgetc();	/* CTRL-R <char> */
  		if (i == Ctrl_O)
  		    i = Ctrl_R;		/* CTRL-R CTRL-O == CTRL-R CTRL-R */
  		if (i == Ctrl_R)
! 		    c = plain_vgetc();	/* CTRL-R CTRL-R <char> */
  		--no_mapping;
  #ifdef FEAT_EVAL
  		/*
*** ../vim-7.1.103/src/getchar.c	Wed Sep  5 21:45:54 2007
--- src/getchar.c	Thu Sep 13 16:16:53 2007
***************
*** 1597,1608 ****
  	    }
  #endif
  #ifdef FEAT_GUI
! 	    /* The caller doesn't need to know that the focus event is delayed
! 	     * until getting a character. */
  	    if (c == K_FOCUSGAINED || c == K_FOCUSLOST)
  	    {
  		ui_focus_change(c == K_FOCUSGAINED);
! 		continue;
  	    }
  
  	    /* Translate K_CSI to CSI.  The special key is only used to avoid
--- 1597,1609 ----
  	    }
  #endif
  #ifdef FEAT_GUI
! 	    /* Handle focus event here, so that the caller doesn't need to
! 	     * know about it.  Return K_IGNORE so that we loop once (needed if
! 	     * 'lazyredraw' is set). */
  	    if (c == K_FOCUSGAINED || c == K_FOCUSLOST)
  	    {
  		ui_focus_change(c == K_FOCUSGAINED);
! 		c = K_IGNORE;
  	    }
  
  	    /* Translate K_CSI to CSI.  The special key is only used to avoid
***************
*** 1744,1749 ****
--- 1745,1766 ----
      c = vgetc();
      if (c == NUL)
  	c = get_keystroke();
+     return c;
+ }
+ 
+ /*
+  * Like safe_vgetc(), but loop to handle K_IGNORE.
+  * Also ignore scrollbar events.
+  */
+     int
+ plain_vgetc()
+ {
+     int c;
+ 
+     do
+     {
+ 	c = safe_vgetc();
+     } while (c == K_IGNORE || c == K_VER_SCROLLBAR || c == K_HOR_SCROLLBAR);
      return c;
  }
  
*** ../vim-7.1.103/src/normal.c	Thu Sep 13 15:33:18 2007
--- src/normal.c	Thu Sep 13 16:24:51 2007
***************
*** 696,702 ****
  		++allow_keys;		/* no mapping for nchar, but keys */
  	    }
  	    ++no_zero_mapping;		/* don't map zero here */
! 	    c = safe_vgetc();
  #ifdef FEAT_LANGMAP
  	    LANGMAP_ADJUST(c, TRUE);
  #endif
--- 696,702 ----
  		++allow_keys;		/* no mapping for nchar, but keys */
  	    }
  	    ++no_zero_mapping;		/* don't map zero here */
! 	    c = plain_vgetc();
  #ifdef FEAT_LANGMAP
  	    LANGMAP_ADJUST(c, TRUE);
  #endif
***************
*** 721,727 ****
  	    ca.count0 = 0;
  	    ++no_mapping;
  	    ++allow_keys;		/* no mapping for nchar, but keys */
! 	    c = safe_vgetc();		/* get next character */
  #ifdef FEAT_LANGMAP
  	    LANGMAP_ADJUST(c, TRUE);
  #endif
--- 721,727 ----
  	    ca.count0 = 0;
  	    ++no_mapping;
  	    ++allow_keys;		/* no mapping for nchar, but keys */
! 	    c = plain_vgetc();		/* get next character */
  #ifdef FEAT_LANGMAP
  	    LANGMAP_ADJUST(c, TRUE);
  #endif
***************
*** 900,906 ****
  	     * For 'g' get the next character now, so that we can check for
  	     * "gr", "g'" and "g`".
  	     */
! 	    ca.nchar = safe_vgetc();
  #ifdef FEAT_LANGMAP
  	    LANGMAP_ADJUST(ca.nchar, TRUE);
  #endif
--- 900,906 ----
  	     * For 'g' get the next character now, so that we can check for
  	     * "gr", "g'" and "g`".
  	     */
! 	    ca.nchar = plain_vgetc();
  #ifdef FEAT_LANGMAP
  	    LANGMAP_ADJUST(ca.nchar, TRUE);
  #endif
***************
*** 957,963 ****
  		im_set_active(TRUE);
  #endif
  
! 	    *cp = safe_vgetc();
  
  	    if (langmap_active)
  	    {
--- 957,963 ----
  		im_set_active(TRUE);
  #endif
  
! 	    *cp = plain_vgetc();
  
  	    if (langmap_active)
  	    {
***************
*** 1045,1051 ****
  		}
  		if (c > 0)
  		{
! 		    c = safe_vgetc();
  		    if (c != Ctrl_N && c != Ctrl_G)
  			vungetc(c);
  		    else
--- 1045,1051 ----
  		}
  		if (c > 0)
  		{
! 		    c = plain_vgetc();
  		    if (c != Ctrl_N && c != Ctrl_G)
  			vungetc(c);
  		    else
***************
*** 1064,1070 ****
  	    while (enc_utf8 && lang && (c = vpeekc()) > 0
  				 && (c >= 0x100 || MB_BYTE2LEN(vpeekc()) > 1))
  	    {
! 		c = safe_vgetc();
  		if (!utf_iscomposing(c))
  		{
  		    vungetc(c);		/* it wasn't, put it back */
--- 1064,1070 ----
  	    while (enc_utf8 && lang && (c = vpeekc()) > 0
  				 && (c >= 0x100 || MB_BYTE2LEN(vpeekc()) > 1))
  	    {
! 		c = plain_vgetc();
  		if (!utf_iscomposing(c))
  		{
  		    vungetc(c);		/* it wasn't, put it back */
***************
*** 4564,4570 ****
  #endif
  	    ++no_mapping;
  	    ++allow_keys;   /* no mapping for nchar, but allow key codes */
! 	    nchar = safe_vgetc();
  #ifdef FEAT_LANGMAP
  	    LANGMAP_ADJUST(nchar, TRUE);
  #endif
--- 4564,4570 ----
  #endif
  	    ++no_mapping;
  	    ++allow_keys;   /* no mapping for nchar, but allow key codes */
! 	    nchar = plain_vgetc();
  #ifdef FEAT_LANGMAP
  	    LANGMAP_ADJUST(nchar, TRUE);
  #endif
***************
*** 4922,4928 ****
      case 'u':	/* "zug" and "zuw": undo "zg" and "zw" */
  		++no_mapping;
  		++allow_keys;   /* no mapping for nchar, but allow key codes */
! 		nchar = safe_vgetc();
  #ifdef FEAT_LANGMAP
  		LANGMAP_ADJUST(nchar, TRUE);
  #endif
--- 4922,4928 ----
      case 'u':	/* "zug" and "zuw": undo "zg" and "zw" */
  		++no_mapping;
  		++allow_keys;   /* no mapping for nchar, but allow key codes */
! 		nchar = plain_vgetc();
  #ifdef FEAT_LANGMAP
  		LANGMAP_ADJUST(nchar, TRUE);
  #endif
*** ../vim-7.1.103/src/proto/getchar.pro	Sun May  6 15:04:24 2007
--- src/proto/getchar.pro	Thu Sep 13 16:13:19 2007
***************
*** 38,43 ****
--- 38,44 ----
  void updatescript __ARGS((int c));
  int vgetc __ARGS((void));
  int safe_vgetc __ARGS((void));
+ int plain_vgetc __ARGS((void));
  int vpeekc __ARGS((void));
  int vpeekc_nomap __ARGS((void));
  int vpeekc_any __ARGS((void));
*** ../vim-7.1.103/src/window.c	Sun Aug 12 16:55:01 2007
--- src/window.c	Thu Sep 13 16:25:01 2007
***************
*** 584,590 ****
  		++no_mapping;
  		++allow_keys;   /* no mapping for xchar, but allow key codes */
  		if (xchar == NUL)
! 		    xchar = safe_vgetc();
  #ifdef FEAT_LANGMAP
  		LANGMAP_ADJUST(xchar, TRUE);
  #endif
--- 584,590 ----
  		++no_mapping;
  		++allow_keys;   /* no mapping for xchar, but allow key codes */
  		if (xchar == NUL)
! 		    xchar = plain_vgetc();
  #ifdef FEAT_LANGMAP
  		LANGMAP_ADJUST(xchar, TRUE);
  #endif
*** ../vim-7.1.103/src/version.c	Thu Sep 13 15:33:18 2007
--- src/version.c	Thu Sep 13 18:22:59 2007
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     104,
  /**/

-- 
ARTHUR:  I am your king!
WOMAN:   Well, I didn't vote for you.
ARTHUR:  You don't vote for kings.
WOMAN:   Well, 'ow did you become king then?
                                  The Quest for the Holy Grail (Monty Python)

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: patch 7.1.105
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.105
Problem:    Internal error when using "0 ? {'a': 1} : {}". (A.Politz)
Solution:   When parsing a dictionary value without using the value, don't try
	    obtaining the key name.
Files:	    src/eval.c


*** ../vim-7.1.104/src/eval.c	Thu Sep  6 14:25:50 2007
--- src/eval.c	Thu Sep 13 20:29:31 2007
***************
*** 6746,6765 ****
  	    clear_tv(&tvkey);
  	    goto failret;
  	}
! 	key = get_tv_string_buf_chk(&tvkey, buf);
! 	if (key == NULL || *key == NUL)
  	{
! 	    /* "key" is NULL when get_tv_string_buf_chk() gave an errmsg */
! 	    if (key != NULL)
! 		EMSG(_(e_emptykey));
! 	    clear_tv(&tvkey);
! 	    goto failret;
  	}
  
  	*arg = skipwhite(*arg + 1);
  	if (eval1(arg, &tv, evaluate) == FAIL)	/* recursive! */
  	{
! 	    clear_tv(&tvkey);
  	    goto failret;
  	}
  	if (evaluate)
--- 6746,6769 ----
  	    clear_tv(&tvkey);
  	    goto failret;
  	}
! 	if (evaluate)
  	{
! 	    key = get_tv_string_buf_chk(&tvkey, buf);
! 	    if (key == NULL || *key == NUL)
! 	    {
! 		/* "key" is NULL when get_tv_string_buf_chk() gave an errmsg */
! 		if (key != NULL)
! 		    EMSG(_(e_emptykey));
! 		clear_tv(&tvkey);
! 		goto failret;
! 	    }
  	}
  
  	*arg = skipwhite(*arg + 1);
  	if (eval1(arg, &tv, evaluate) == FAIL)	/* recursive! */
  	{
! 	    if (evaluate)
! 		clear_tv(&tvkey);
  	    goto failret;
  	}
  	if (evaluate)
*** ../vim-7.1.104/src/version.c	Thu Sep 13 18:25:08 2007
--- src/version.c	Thu Sep 13 20:36:38 2007
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     105,
  /**/

-- 
DENNIS:  Listen -- strange women lying in ponds distributing swords is no
         basis for a system of government.  Supreme executive power derives
         from a mandate from the masses, not from some farcical aquatic
         ceremony.
                                  The Quest for the Holy Grail (Monty Python)

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: patch 7.1.106
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.106
Problem:    ":messages" doesn't quit listing on ":".
Solution:   Break the loop when "got_int" is set.
Files:	    src/message.c


*** ../vim-7.1.105/src/message.c	Thu Sep  6 12:53:59 2007
--- src/message.c	Thu Sep 13 21:45:57 2007
***************
*** 828,834 ****
  		_("Messages maintainer: Bram Moolenaar <Bram@vim.org>"),
  		hl_attr(HLF_T));
  
!     for (p = first_msg_hist; p != NULL; p = p->next)
  	if (p->msg != NULL)
  	    msg_attr(p->msg, p->attr);
  
--- 828,834 ----
  		_("Messages maintainer: Bram Moolenaar <Bram@vim.org>"),
  		hl_attr(HLF_T));
  
!     for (p = first_msg_hist; p != NULL && !got_int; p = p->next)
  	if (p->msg != NULL)
  	    msg_attr(p->msg, p->attr);
  
*** ../vim-7.1.105/src/version.c	Thu Sep 13 20:39:58 2007
--- src/version.c	Thu Sep 13 21:57:40 2007
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     106,
  /**/

-- 
I'm sure that I asked CBuilder to do a "full" install.  Looks like I got
a "fool" install, instead.		Charles E Campbell, Jr, PhD


 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: patch 7.1.107
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.107
Problem:    When doing a block selection and using "s" to change the text,
	    while triggering auto-indenting, causes the wrong text to be
	    repeated in other lines. (Adri Verhoef)
Solution:   Compute the change of indent and compensate for that.
Files:	    src/ops.c


*** ../vim-7.1.106/src/ops.c	Thu Jun 28 22:14:28 2007
--- src/ops.c	Thu Aug 30 11:41:10 2007
***************
*** 2477,2483 ****
  
  	/*
  	 * Spaces and tabs in the indent may have changed to other spaces and
! 	 * tabs.  Get the starting column again and correct the lenght.
  	 * Don't do this when "$" used, end-of-line will have changed.
  	 */
  	block_prep(oap, &bd2, oap->start.lnum, TRUE);
--- 2477,2483 ----
  
  	/*
  	 * Spaces and tabs in the indent may have changed to other spaces and
! 	 * tabs.  Get the starting column again and correct the length.
  	 * Don't do this when "$" used, end-of-line will have changed.
  	 */
  	block_prep(oap, &bd2, oap->start.lnum, TRUE);
***************
*** 2534,2540 ****
  #ifdef FEAT_VISUALEXTRA
      long		offset;
      linenr_T		linenr;
!     long		ins_len, pre_textlen = 0;
      char_u		*firstline;
      char_u		*ins_text, *newp, *oldp;
      struct block_def	bd;
--- 2534,2542 ----
  #ifdef FEAT_VISUALEXTRA
      long		offset;
      linenr_T		linenr;
!     long		ins_len;
!     long		pre_textlen = 0;
!     long		pre_indent = 0;
      char_u		*firstline;
      char_u		*ins_text, *newp, *oldp;
      struct block_def	bd;
***************
*** 2579,2585 ****
  						    || gchar_cursor() == NUL))
  	    coladvance_force(getviscol());
  # endif
! 	pre_textlen = (long)STRLEN(ml_get(oap->start.lnum));
  	bd.textcol = curwin->w_cursor.col;
      }
  #endif
--- 2581,2589 ----
  						    || gchar_cursor() == NUL))
  	    coladvance_force(getviscol());
  # endif
! 	firstline = ml_get(oap->start.lnum);
! 	pre_textlen = (long)STRLEN(firstline);
! 	pre_indent = (long)(skipwhite(firstline) - firstline);
  	bd.textcol = curwin->w_cursor.col;
      }
  #endif
***************
*** 2598,2610 ****
       */
      if (oap->block_mode && oap->start.lnum != oap->end.lnum)
      {
  	firstline = ml_get(oap->start.lnum);
! 	/*
! 	 * Subsequent calls to ml_get() flush the firstline data - take a
! 	 * copy of the required bit.
! 	 */
! 	if ((ins_len = (long)STRLEN(firstline) - pre_textlen) > 0)
  	{
  	    if ((ins_text = alloc_check((unsigned)(ins_len + 1))) != NULL)
  	    {
  		vim_strncpy(ins_text, firstline + bd.textcol, (size_t)ins_len);
--- 2602,2623 ----
       */
      if (oap->block_mode && oap->start.lnum != oap->end.lnum)
      {
+ 	/* Auto-indenting may have changed the indent.  If the cursor was past
+ 	 * the indent, exclude that indent change from the inserted text. */
  	firstline = ml_get(oap->start.lnum);
! 	if (bd.textcol > pre_indent)
! 	{
! 	    long new_indent = (long)(skipwhite(firstline) - firstline);
! 
! 	    pre_textlen += new_indent - pre_indent;
! 	    bd.textcol += new_indent - pre_indent;
! 	}
! 
! 	ins_len = (long)STRLEN(firstline) - pre_textlen;
! 	if (ins_len > 0)
  	{
+ 	    /* Subsequent calls to ml_get() flush the firstline data - take a
+ 	     * copy of the inserted text.  */
  	    if ((ins_text = alloc_check((unsigned)(ins_len + 1))) != NULL)
  	    {
  		vim_strncpy(ins_text, firstline + bd.textcol, (size_t)ins_len);
*** ../vim-7.1.106/src/version.c	Thu Sep 13 22:04:30 2007
--- src/version.c	Thu Sep 13 22:38:28 2007
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     107,
  /**/

-- 
Windows
M!uqoms

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: patch 7.1.108
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.108 (after 7.1.100)
Problem:    Win32: Compilation problems in Cscope code. (Jeff Lanzarotta)
Solution:   Use (long) instead of (intptr_t) when it's not defined.
Files:	    src/if_cscope.c


*** ../vim-7.1.107/src/if_cscope.c	Thu Sep  6 17:38:06 2007
--- src/if_cscope.c	Wed Sep 12 20:32:17 2007
***************
*** 726,731 ****
--- 726,740 ----
      HANDLE	stdin_rd, stdout_rd;
      HANDLE	stdout_wr, stdin_wr;
      BOOL	created;
+ # ifdef __BORLANDC__
+ #  define OPEN_OH_ARGTYPE long
+ # else
+ #  if (_MSC_VER >= 1300)
+ #   define OPEN_OH_ARGTYPE intptr_t
+ #  else
+ #   define OPEN_OH_ARGTYPE long
+ #  endif
+ # endif
  #endif
  
  #if defined(UNIX)
***************
*** 909,918 ****
      CloseHandle(pi.hThread);
  
      /* TODO - tidy up after failure to create files on pipe handles. */
!     if (((fd = _open_osfhandle((intptr_t)stdin_wr, _O_TEXT|_O_APPEND)) < 0)
  	    || ((csinfo[i].to_fp = _fdopen(fd, "w")) == NULL))
  	PERROR(_("cs_create_connection: fdopen for to_fp failed"));
!     if (((fd = _open_osfhandle((intptr_t)stdout_rd, _O_TEXT|_O_RDONLY)) < 0)
  	    || ((csinfo[i].fr_fp = _fdopen(fd, "r")) == NULL))
  	PERROR(_("cs_create_connection: fdopen for fr_fp failed"));
  
--- 918,929 ----
      CloseHandle(pi.hThread);
  
      /* TODO - tidy up after failure to create files on pipe handles. */
!     if (((fd = _open_osfhandle((OPEN_OH_ARGTYPE)stdin_wr,
! 						      _O_TEXT|_O_APPEND)) < 0)
  	    || ((csinfo[i].to_fp = _fdopen(fd, "w")) == NULL))
  	PERROR(_("cs_create_connection: fdopen for to_fp failed"));
!     if (((fd = _open_osfhandle((OPEN_OH_ARGTYPE)stdout_rd,
! 						      _O_TEXT|_O_RDONLY)) < 0)
  	    || ((csinfo[i].fr_fp = _fdopen(fd, "r")) == NULL))
  	PERROR(_("cs_create_connection: fdopen for fr_fp failed"));
  
*** ../vim-7.1.107/src/version.c	Thu Sep 13 22:40:47 2007
--- src/version.c	Fri Sep 14 19:55:12 2007
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     108,
  /**/

-- 
Q:   How many hardware engineers does it take to change a lightbulb?
A:   None.  We'll fix it in software.

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: patch 7.1.109
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.109
Problem:    GTK: when there are many tab pages, clicking on the arrow left of
	    the labels moves to the next tab page on the right. (Simeon Bird)
Solution:   Check the X coordinate of the click and pass -1 as value for the
	    left arrow.
Files:	    src/gui_gtk_x11.c, src/term.c


*** ../vim-7.1.108/src/gui_gtk_x11.c	Wed Sep  5 21:45:54 2007
--- src/gui_gtk_x11.c	Fri Sep 14 20:59:55 2007
***************
*** 3223,3230 ****
  	{
  	    if (clicked_page == 0)
  	    {
! 		/* Click after all tabs moves to next tab page. */
! 		if (send_tabline_event(0) && gtk_main_level() > 0)
  		    gtk_main_quit();
  	    }
  #ifndef HAVE_GTK2
--- 3223,3231 ----
  	{
  	    if (clicked_page == 0)
  	    {
! 		/* Click after all tabs moves to next tab page.  When "x" is
! 		 * small guess it's the left button. */
! 		if (send_tabline_event(x < 50 ? -1 : 0) && gtk_main_level() > 0)
  		    gtk_main_quit();
  	    }
  #ifndef HAVE_GTK2
*** ../vim-7.1.108/src/term.c	Thu May 10 20:48:32 2007
--- src/term.c	Fri Sep 14 20:56:40 2007
***************
*** 4809,4814 ****
--- 4809,4816 ----
  	    if (num_bytes == -1)
  		return -1;
  	    current_tab = (int)bytes[0];
+ 	    if (current_tab == 255)	/* -1 in a byte gives 255 */
+ 		current_tab = -1;
  	    slen += num_bytes;
  	}
  	else if (key_name[0] == (int)KS_TABMENU)
*** ../vim-7.1.108/src/version.c	Fri Sep 14 19:56:18 2007
--- src/version.c	Sat Sep 15 14:05:25 2007
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     109,
  /**/

-- 
No letters of the alphabet were harmed in the creation of this message.

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: patch 7.1.110
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.110 (after 7.1.102)
Problem:    Win32: Still compilation problems with Perl.
Solution:   Change the #ifdefs. (Suresh Govindachar)
Files:	    src/if_perl.xs


*** ../vim-7.1.109/src/if_perl.xs	Thu Sep 13 15:19:32 2007
--- src/if_perl.xs	Fri Sep 14 21:23:38 2007
***************
*** 48,60 ****
   * The changes include addition of two symbols (Perl_sv_2iv_flags,
   * Perl_newXS_flags) not present in earlier releases.
   *
!  * Jan Dubois suggested the following guarding scheme:
   */
! #if (ACTIVEPERL_VERSION >= 822)
! # define PERL589_OR_LATER
! #endif
! #if (PERL_REVISION == 5) && (PERL_VERSION == 8) && (PERL_SUBVERSION >= 9)
! # define PERL589_OR_LATER
  #endif
  #if (PERL_REVISION == 5) && (PERL_VERSION >= 9)
  # define PERL589_OR_LATER
--- 48,62 ----
   * The changes include addition of two symbols (Perl_sv_2iv_flags,
   * Perl_newXS_flags) not present in earlier releases.
   *
!  * Jan Dubois suggested the following guarding scheme.
!  *
!  * Active State defined ACTIVEPERL_VERSION as a string in versions before
!  * 5.8.8; and so the comparison to 822 below needs to be guarded.
   */
! #if (PERL_REVISION == 5) && (PERL_VERSION == 8) && (PERL_SUBVERSION >= 8)
! # if (ACTIVEPERL_VERSION >= 822) || (PERL_SUBVERSION >= 9)
! #  define PERL589_OR_LATER
! # endif
  #endif
  #if (PERL_REVISION == 5) && (PERL_VERSION >= 9)
  # define PERL589_OR_LATER
*** ../vim-7.1.109/src/version.c	Sat Sep 15 14:06:41 2007
--- src/version.c	Sat Sep 15 14:48:05 2007
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     110,
  /**/

-- 
"It's so simple to be wise.  Just think of something stupid to say
and then don't say it."        -- Sam Levenson

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: patch 7.1.111
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.111
Problem:    When using ":vimgrep" with the "j" flag folds from another buffer
	    may be displayed. (A.Politz)
Solution:   When not jumping to another buffer update the folds.
Files:	    src/quickfix.c


*** ../vim-7.1.110/src/quickfix.c	Thu Jun 28 21:23:52 2007
--- src/quickfix.c	Fri Sep 14 22:16:23 2007
***************
*** 1612,1619 ****
  	}
  
  	/*
! 	 * If there is only one window and is the quickfix window, create a new
! 	 * one above the quickfix window.
  	 */
  	if (((firstwin == lastwin) && bt_quickfix(curbuf)) || !usable_win)
  	{
--- 1612,1619 ----
  	}
  
  	/*
! 	 * If there is only one window and it is the quickfix window, create a
! 	 * new one above the quickfix window.
  	 */
  	if (((firstwin == lastwin) && bt_quickfix(curbuf)) || !usable_win)
  	{
***************
*** 2981,2986 ****
--- 2981,2987 ----
      buf_T	*buf;
      int		duplicate_name = FALSE;
      int		using_dummy;
+     int		redraw_for_dummy = FALSE;
      int		found_match;
      buf_T	*first_match_buf = NULL;
      time_t	seconds = 0;
***************
*** 3097,3102 ****
--- 3098,3104 ----
  	    /* Remember that a buffer with this name already exists. */
  	    duplicate_name = (buf != NULL);
  	    using_dummy = TRUE;
+ 	    redraw_for_dummy = TRUE;
  
  #if defined(FEAT_AUTOCMD) && defined(FEAT_SYN_HL)
  	    /* Don't do Filetype autocommands to avoid loading syntax and
***************
*** 3243,3252 ****
--- 3245,3272 ----
      if (qi->qf_lists[qi->qf_curlist].qf_count > 0)
      {
  	if ((flags & VGR_NOJUMP) == 0)
+ 	{
+ 	    buf = curbuf;
  	    qf_jump(qi, 0, 0, eap->forceit);
+ 	    if (buf != curbuf)
+ 		/* If we jumped to another buffer redrawing will already be
+ 		 * taken care of. */
+ 		redraw_for_dummy = FALSE;
+ 	}
      }
      else
  	EMSG2(_(e_nomatch2), s);
+ 
+     /* If we loaded a dummy buffer into the current window, the autocommands
+      * may have messed up things, need to redraw and recompute folds. */
+     if (redraw_for_dummy)
+     {
+ #ifdef FEAT_FOLDING
+ 	foldUpdateAll(curwin);
+ #else
+ 	redraw_later(NOT_VALID);
+ #endif
+     }
  
  theend:
      vim_free(regmatch.regprog);
*** ../vim-7.1.110/src/version.c	Sat Sep 15 14:48:57 2007
--- src/version.c	Sun Sep 16 13:23:48 2007
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     111,
  /**/

-- 
Trees moving back and forth is what makes the wind blow.

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: patch 7.1.112
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.112
Problem:    Using input() with a wrong argument may crash Vim. (A.Politz)
Solution:   Init the input() return value to NULL.
Files:	    src/eval.c


*** ../vim-7.1.111/src/eval.c	Thu Sep 13 20:39:58 2007
--- src/eval.c	Sat Sep 15 19:04:51 2007
***************
*** 11565,11578 ****
      char_u	*xp_arg = NULL;
  
      rettv->v_type = VAR_STRING;
  
  #ifdef NO_CONSOLE_INPUT
      /* While starting up, there is no place to enter text. */
      if (no_console_input())
-     {
- 	rettv->vval.v_string = NULL;
  	return;
-     }
  #endif
  
      cmd_silent = FALSE;		/* Want to see the prompt. */
--- 11566,11577 ----
      char_u	*xp_arg = NULL;
  
      rettv->v_type = VAR_STRING;
+     rettv->vval.v_string = NULL;
  
  #ifdef NO_CONSOLE_INPUT
      /* While starting up, there is no place to enter text. */
      if (no_console_input())
  	return;
  #endif
  
      cmd_silent = FALSE;		/* Want to see the prompt. */
*** ../vim-7.1.111/src/version.c	Sun Sep 16 13:26:56 2007
--- src/version.c	Sun Sep 16 14:19:04 2007
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     112,
  /**/

-- 
The early bird gets the worm. If you want something else for
breakfast, get up later.

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: patch 7.1.113
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.113
Problem:    Using map() to go over an empty list causes memory to be freed
	    twice. (A.Politz)
Solution:   Don't clear the typeval in restore_vimvar().
Files:	    src/eval.c


*** ../vim-7.1.112/src/eval.c	Sun Sep 16 14:20:18 2007
--- src/eval.c	Sun Sep 16 19:24:49 2007
***************
*** 1318,1324 ****
  {
      hashitem_T	*hi;
  
-     clear_tv(&vimvars[idx].vv_tv);
      vimvars[idx].vv_tv = *save_tv;
      if (vimvars[idx].vv_type == VAR_UNKNOWN)
      {
--- 1318,1323 ----
***************
*** 1362,1368 ****
  
      if (p_verbose == 0)
  	--emsg_off;
-     vimvars[VV_VAL].vv_str = NULL;
      restore_vimvar(VV_VAL, &save_val);
  
      return list;
--- 1361,1366 ----
***************
*** 9387,9401 ****
  {
      typval_T	rettv;
      char_u	*s;
  
      copy_tv(tv, &vimvars[VV_VAL].vv_tv);
      s = expr;
      if (eval1(&s, &rettv, TRUE) == FAIL)
! 	return FAIL;
      if (*s != NUL)  /* check for trailing chars after expr */
      {
  	EMSG2(_(e_invexpr2), s);
! 	return FAIL;
      }
      if (map)
      {
--- 9386,9401 ----
  {
      typval_T	rettv;
      char_u	*s;
+     int		retval = FAIL;
  
      copy_tv(tv, &vimvars[VV_VAL].vv_tv);
      s = expr;
      if (eval1(&s, &rettv, TRUE) == FAIL)
! 	goto theend;
      if (*s != NUL)  /* check for trailing chars after expr */
      {
  	EMSG2(_(e_invexpr2), s);
! 	goto theend;
      }
      if (map)
      {
***************
*** 9414,9423 ****
  	/* On type error, nothing has been removed; return FAIL to stop the
  	 * loop.  The error message was given by get_tv_number_chk(). */
  	if (error)
! 	    return FAIL;
      }
      clear_tv(&vimvars[VV_VAL].vv_tv);
!     return OK;
  }
  
  /*
--- 9414,9425 ----
  	/* On type error, nothing has been removed; return FAIL to stop the
  	 * loop.  The error message was given by get_tv_number_chk(). */
  	if (error)
! 	    goto theend;
      }
+     retval = OK;
+ theend:
      clear_tv(&vimvars[VV_VAL].vv_tv);
!     return retval;
  }
  
  /*
*** ../vim-7.1.112/src/version.c	Sun Sep 16 14:20:18 2007
--- src/version.c	Mon Sep 17 21:33:52 2007
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     113,
  /**/

-- 
Mental Floss prevents moral decay!

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: patch 7.1.114
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.114
Problem:    Memory leak in getmatches().
Solution:   Don't increment the refcount twice.
Files:	    src/eval.c


*** ../vim-7.1.113/src/eval.c	Mon Sep 17 21:37:09 2007
--- src/eval.c	Sun Sep 16 19:24:49 2007
***************
*** 10351,10357 ****
  	    dict = dict_alloc();
  	    if (dict == NULL)
  		return;
- 	    ++dict->dv_refcount;
  	    dict_add_nr_str(dict, "group", 0L, syn_id2name(cur->hlg_id));
  	    dict_add_nr_str(dict, "pattern", 0L, cur->pattern);
  	    dict_add_nr_str(dict, "priority", (long)cur->priority, NULL);
--- 10355,10360 ----
*** ../vim-7.1.113/src/version.c	Mon Sep 17 21:37:09 2007
--- src/version.c	Mon Sep 17 21:54:08 2007
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     114,
  /**/

-- 
Be nice to your kids...  they'll be the ones choosing your nursing home.

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: patch 7.1.115
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.115 (after 7.1.105)
Problem:    Compiler warning for uninitialized variable. (Tony Mechelynck)
Solution:   Init variable to NULL.
Files:	    src/eval.c


*** ../vim-7.1.114/src/eval.c	Mon Sep 17 21:55:02 2007
--- src/eval.c	Sun Sep 16 19:24:49 2007
***************
*** 6704,6710 ****
      dict_T	*d = NULL;
      typval_T	tvkey;
      typval_T	tv;
!     char_u	*key;
      dictitem_T	*item;
      char_u	*start = skipwhite(*arg + 1);
      char_u	buf[NUMBUFLEN];
--- 6705,6711 ----
      dict_T	*d = NULL;
      typval_T	tvkey;
      typval_T	tv;
!     char_u	*key = NULL;
      dictitem_T	*item;
      char_u	*start = skipwhite(*arg + 1);
      char_u	buf[NUMBUFLEN];
*** ../vim-7.1.114/src/version.c	Mon Sep 17 21:55:02 2007
--- src/version.c	Mon Sep 17 22:18:42 2007
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     115,
  /**/

-- 
Proofread carefully to see if you any words out.

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: patch 7.1.116
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.116
Problem:    Cannot display Unicode characters above 0x10000.
Solution:   Remove the replacement with a question mark when UNICODE16 is not
	    defined. (partly by Nicolas Weber)
Files:	    src/screen.c


*** ../vim-7.1.115/src/screen.c	Thu Aug 30 13:51:52 2007
--- src/screen.c	Mon Sep 10 22:29:42 2007
***************
*** 2305,2313 ****
--- 2305,2315 ----
  			prev_c = u8c;
  #endif
  		    /* Non-BMP character: display as ? or fullwidth ?. */
+ #ifdef UNICODE16
  		    if (u8c >= 0x10000)
  			ScreenLinesUC[idx] = (cells == 2) ? 0xff1f : (int)'?';
  		    else
+ #endif
  			ScreenLinesUC[idx] = u8c;
  		    for (i = 0; i < Screen_mco; ++i)
  		    {
***************
*** 3678,3690 ****
  		    if ((mb_l == 1 && c >= 0x80)
  			    || (mb_l >= 1 && mb_c == 0)
  			    || (mb_l > 1 && (!vim_isprintc(mb_c)
! 							 || mb_c >= 0x10000)))
  		    {
  			/*
  			 * Illegal UTF-8 byte: display as <xx>.
  			 * Non-BMP character : display as ? or fullwidth ?.
  			 */
  			if (mb_c < 0x10000)
  			{
  			    transchar_hex(extra, mb_c);
  # ifdef FEAT_RIGHTLEFT
--- 3680,3697 ----
  		    if ((mb_l == 1 && c >= 0x80)
  			    || (mb_l >= 1 && mb_c == 0)
  			    || (mb_l > 1 && (!vim_isprintc(mb_c)
! # ifdef UNICODE16
! 							 || mb_c >= 0x10000
! # endif
! 							 )))
  		    {
  			/*
  			 * Illegal UTF-8 byte: display as <xx>.
  			 * Non-BMP character : display as ? or fullwidth ?.
  			 */
+ # ifdef UNICODE16
  			if (mb_c < 0x10000)
+ # endif
  			{
  			    transchar_hex(extra, mb_c);
  # ifdef FEAT_RIGHTLEFT
***************
*** 3692,3702 ****
--- 3699,3711 ----
  				rl_mirror(extra);
  # endif
  			}
+ # ifdef UNICODE16
  			else if (utf_char2cells(mb_c) != 2)
  			    STRCPY(extra, "?");
  			else
  			    /* 0xff1f in UTF-8: full-width '?' */
  			    STRCPY(extra, "\357\274\237");
+ # endif
  
  			p_extra = extra;
  			c = *p_extra;
***************
*** 6245,6250 ****
--- 6254,6260 ----
  		else
  		    u8c = utfc_ptr2char(ptr, u8cc);
  		mbyte_cells = utf_char2cells(u8c);
+ # ifdef UNICODE16
  		/* Non-BMP character: display as ? or fullwidth ?. */
  		if (u8c >= 0x10000)
  		{
***************
*** 6252,6257 ****
--- 6262,6268 ----
  		    if (attr == 0)
  			attr = hl_attr(HLF_8);
  		}
+ # endif
  # ifdef FEAT_ARABIC
  		if (p_arshape && !p_tbidi && ARABIC_CHAR(u8c))
  		{
*** ../vim-7.1.116/src/version.c	Mon Sep 17 22:19:43 2007
--- src/version.c	Mon Sep 17 22:37:31 2007
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     116,
  /**/

-- 
There can't be a crisis today, my schedule is already full.

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: patch 7.1.117
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.117
Problem:    Can't check wether Vim was compiled with Gnome. (Tony Mechelynck)
Solution:   Add gui_gnome to the has() list.
Files:	    src/eval.c


*** ../vim-7.1.116/src/eval.c	Mon Sep 17 22:19:43 2007
--- src/eval.c	Sun Sep 16 19:24:49 2007
***************
*** 10879,10884 ****
--- 10883,10891 ----
  	"gui_gtk2",
  # endif
  #endif
+ #ifdef FEAT_GUI_GNOME
+ 	"gui_gnome",
+ #endif
  #ifdef FEAT_GUI_MAC
  	"gui_mac",
  #endif
*** ../vim-7.1.116/src/version.c	Mon Sep 17 22:38:49 2007
--- src/version.c	Tue Sep 25 12:48:59 2007
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     117,
  /**/

-- 
ARTHUR:  No, hang on!  Just answer the five questions ...
GALAHAD: Three questions ...
ARTHUR:  Three questions ...  And we shall watch ... and pray.
                 "Monty Python and the Holy Grail" PYTHON (MONTY) PICTURES LTD

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: patch 7.1.118
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.118 (after 7.1.107)
Problem:    Compiler warning for Visual C compiler.
Solution:   Add typecast. (Mike Williams)
Files:	    src/ops.c


*** ../vim-7.1.117/src/ops.c	Thu Sep 13 22:40:47 2007
--- src/ops.c	Mon Sep 24 18:30:09 2007
***************
*** 2605,2611 ****
  	/* Auto-indenting may have changed the indent.  If the cursor was past
  	 * the indent, exclude that indent change from the inserted text. */
  	firstline = ml_get(oap->start.lnum);
! 	if (bd.textcol > pre_indent)
  	{
  	    long new_indent = (long)(skipwhite(firstline) - firstline);
  
--- 2605,2611 ----
  	/* Auto-indenting may have changed the indent.  If the cursor was past
  	 * the indent, exclude that indent change from the inserted text. */
  	firstline = ml_get(oap->start.lnum);
! 	if (bd.textcol > (colnr_T)pre_indent)
  	{
  	    long new_indent = (long)(skipwhite(firstline) - firstline);
  
*** ../vim-7.1.117/src/version.c	Tue Sep 25 12:50:00 2007
--- src/version.c	Tue Sep 25 14:18:37 2007
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     118,
  /**/

-- 
BRIDGEKEEPER: What is your favorite editor?
GAWAIN:       Emacs ...  No, Viiiiiiiiiiimmmmmmm!
           "Monty Python and the Holy editor wars" PYTHON (MONTY) SOFTWARE LTD

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: patch 7.1.119
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.119
Problem:    Crash when 'cmdheight' set to very large value. (A.Politz)
Solution:   Limit 'cmdheight' to 'lines' minus one.  Store right value of
	    'cmdheight' when running out of room.
Files:	    src/option.c, src/window.c


*** ../vim-7.1.118/src/option.c	Thu Sep  6 16:33:47 2007
--- src/option.c	Tue Sep 25 12:17:35 2007
***************
*** 7824,7829 ****
--- 7824,7831 ----
  	    errmsg = e_positive;
  	    p_ch = 1;
  	}
+ 	if (p_ch > Rows - min_rows() + 1)
+ 	    p_ch = Rows - min_rows() + 1;
  
  	/* Only compute the new window layout when startup has been
  	 * completed. Otherwise the frame sizes may be wrong. */
*** ../vim-7.1.118/src/window.c	Thu Sep 13 18:25:08 2007
--- src/window.c	Tue Sep 25 12:13:56 2007
***************
*** 5523,5528 ****
--- 5523,5529 ----
  		{
  		    EMSG(_(e_noroom));
  		    p_ch = old_p_ch;
+ 		    curtab->tp_ch_used = p_ch;
  		    cmdline_row = Rows - p_ch;
  		    break;
  		}
*** ../vim-7.1.118/src/version.c	Tue Sep 25 14:19:35 2007
--- src/version.c	Tue Sep 25 14:48:14 2007
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     119,
  /**/

-- 
Q: Why does /dev/null accept only integers?
A: You can't sink a float.

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: patch 7.1.120
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.120
Problem:    Can't properly check memory leaks while running tests.
Solution:   Add an argument to garbagecollect().  Delete functions and
	    variables in the test scripts.
Files:	    runtime/doc/eval.txt, src/eval.c, src/globals.h, src/main.c,
	    src/testdir/Makefile, src/testdir/test14.in,
	    src/testdir/test26.in, src/testdir/test34.in,
	    src/testdir/test45.in, src/testdir/test47.in,
	    src/testdir/test49.in, src/testdir/test55.in,
	    src/testdir/test56.in, src/testdir/test58.in,
	    src/testdir/test59.in, src/testdir/test60.in,
	    src/testdir/test60.vim, src/testdir/test62.in,
	    src/testdir/test63.in, src/testdir/test64.in


*** ../vim-7.1.119/runtime/doc/eval.txt	Thu Jul 26 22:55:11 2007
--- runtime/doc/eval.txt	Tue Sep 25 17:40:30 2007
***************
*** 1,4 ****
! *eval.txt*      For Vim version 7.1.  Last change: 2007 Jul 25
  
  
  		  VIM REFERENCE MANUAL    by Bram Moolenaar
--- 1,4 ----
! *eval.txt*      For Vim version 7.1.  Last change: 2007 Sep 25
  
  
  		  VIM REFERENCE MANUAL    by Bram Moolenaar
***************
*** 1603,1609 ****
  foldtextresult( {lnum})		String	text for closed fold at {lnum}
  foreground( )			Number	bring the Vim window to the foreground
  function( {name})		Funcref reference to function {name}
! garbagecollect()		none	free memory, breaking cyclic references
  get( {list}, {idx} [, {def}])	any	get item {idx} from {list} or {def}
  get( {dict}, {key} [, {def}])	any	get item {key} from {dict} or {def}
  getbufline( {expr}, {lnum} [, {end}])
--- 1603,1609 ----
  foldtextresult( {lnum})		String	text for closed fold at {lnum}
  foreground( )			Number	bring the Vim window to the foreground
  function( {name})		Funcref reference to function {name}
! garbagecollect( [at_exit])	none	free memory, breaking cyclic references
  get( {list}, {idx} [, {def}])	any	get item {idx} from {list} or {def}
  get( {dict}, {key} [, {def}])	any	get item {key} from {dict} or {def}
  getbufline( {expr}, {lnum} [, {end}])
***************
*** 2673,2679 ****
  		{name} can be a user defined function or an internal function.
  
  
! garbagecollect()					*garbagecollect()*
  		Cleanup unused |Lists| and |Dictionaries| that have circular
  		references.  There is hardly ever a need to invoke this
  		function, as it is automatically done when Vim runs out of
--- 2673,2679 ----
  		{name} can be a user defined function or an internal function.
  
  
! garbagecollect([at_exit])				*garbagecollect()*
  		Cleanup unused |Lists| and |Dictionaries| that have circular
  		references.  There is hardly ever a need to invoke this
  		function, as it is automatically done when Vim runs out of
***************
*** 2683,2688 ****
--- 2683,2691 ----
  		This is useful if you have deleted a very big |List| and/or
  		|Dictionary| with circular references in a script that runs
  		for a long time.
+ 		When the optional "at_exit" argument is one, garbage
+ 		collection will also be done when exiting Vim, if it wasn't
+ 		done before.  This is useful when checking for memory leaks.
  
  get({list}, {idx} [, {default}])			*get()*
  		Get item {idx} from |List| {list}.  When this item is not
*** ../vim-7.1.119/src/eval.c	Tue Sep 25 12:50:00 2007
--- src/eval.c	Sun Sep 16 19:24:49 2007
***************
*** 6128,6133 ****
--- 6128,6134 ----
      /* Only do this once. */
      want_garbage_collect = FALSE;
      may_garbage_collect = FALSE;
+     garbage_collect_at_exit = FALSE;
  
      /*
       * 1. Go through all accessible variables and mark all lists and dicts
***************
*** 7110,7116 ****
      {"foldtextresult",	1, 1, f_foldtextresult},
      {"foreground",	0, 0, f_foreground},
      {"function",	1, 1, f_function},
!     {"garbagecollect",	0, 0, f_garbagecollect},
      {"get",		2, 3, f_get},
      {"getbufline",	2, 3, f_getbufline},
      {"getbufvar",	2, 2, f_getbufvar},
--- 7111,7117 ----
      {"foldtextresult",	1, 1, f_foldtextresult},
      {"foreground",	0, 0, f_foreground},
      {"function",	1, 1, f_function},
!     {"garbagecollect",	0, 1, f_garbagecollect},
      {"get",		2, 3, f_get},
      {"getbufline",	2, 3, f_getbufline},
      {"getbufvar",	2, 2, f_getbufvar},
***************
*** 9719,9724 ****
--- 9720,9728 ----
      /* This is postponed until we are back at the toplevel, because we may be
       * using Lists and Dicts internally.  E.g.: ":echo [garbagecollect()]". */
      want_garbage_collect = TRUE;
+ 
+     if (argvars[0].v_type != VAR_UNKNOWN && get_tv_number(&argvars[0]) == 1)
+ 	garbage_collect_at_exit = TRUE;
  }
  
  /*
*** ../vim-7.1.119/src/globals.h	Thu Aug 30 13:51:52 2007
--- src/globals.h	Sun Sep 16 18:42:41 2007
***************
*** 301,313 ****
  #endif
  
  #ifdef FEAT_EVAL
! /* Garbage collection can only take place when we are sure there are no Lists
   * or Dictionaries being used internally.  This is flagged with
   * "may_garbage_collect" when we are at the toplevel.
   * "want_garbage_collect" is set by the garbagecollect() function, which means
!  * we do garbage collection before waiting for a char at the toplevel. */
  EXTERN int	may_garbage_collect INIT(= FALSE);
  EXTERN int	want_garbage_collect INIT(= FALSE);
  
  /* ID of script being sourced or was sourced to define the current function. */
  EXTERN scid_T	current_SID INIT(= 0);
--- 301,317 ----
  #endif
  
  #ifdef FEAT_EVAL
! /*
!  * Garbage collection can only take place when we are sure there are no Lists
   * or Dictionaries being used internally.  This is flagged with
   * "may_garbage_collect" when we are at the toplevel.
   * "want_garbage_collect" is set by the garbagecollect() function, which means
!  * we do garbage collection before waiting for a char at the toplevel.
!  * "garbage_collect_at_exit" indicates garbagecollect(1) was called.
!  */
  EXTERN int	may_garbage_collect INIT(= FALSE);
  EXTERN int	want_garbage_collect INIT(= FALSE);
+ EXTERN int	garbage_collect_at_exit INIT(= FALSE);
  
  /* ID of script being sourced or was sourced to define the current function. */
  EXTERN scid_T	current_SID INIT(= 0);
*** ../vim-7.1.119/src/main.c	Thu Sep  6 17:38:06 2007
--- src/main.c	Sun Sep 16 18:44:54 2007
***************
*** 1334,1339 ****
--- 1334,1343 ----
  #ifdef FEAT_CSCOPE
      cs_end();
  #endif
+ #ifdef FEAT_EVAL
+     if (garbage_collect_at_exit)
+ 	garbage_collect();
+ #endif
  
      mch_exit(exitval);
  }
*** ../vim-7.1.119/src/testdir/Makefile	Tue Aug 14 17:28:14 2007
--- src/testdir/Makefile	Mon Sep 17 20:04:13 2007
***************
*** 6,12 ****
  
  # Uncomment this line for using valgrind.
  # The output goes into a file "valgrind.$PID" (sorry, no test number).
! # VALGRIND = valgrind --tool=memcheck --num-callers=15 --logfile=valgrind
  
  SCRIPTS = test1.out test2.out test3.out test4.out test5.out test6.out \
  		test7.out test8.out test9.out test10.out test11.out \
--- 6,12 ----
  
  # Uncomment this line for using valgrind.
  # The output goes into a file "valgrind.$PID" (sorry, no test number).
! # VALGRIND = valgrind --tool=memcheck --leak-check=yes --num-callers=15 --logfile=valgrind
  
  SCRIPTS = test1.out test2.out test3.out test4.out test5.out test6.out \
  		test7.out test8.out test9.out test10.out test11.out \
***************
*** 39,45 ****
  $(SCRIPTS) $(SCRIPTS_GUI): $(VIMPROG)
  
  clean:
! 	-rm -rf *.out *.failed *.rej *.orig test.log tiny.vim small.vim mbyte.vim test.ok X* viminfo
  
  test1.out: test1.in
  	-rm -f $*.failed tiny.vim small.vim mbyte.vim test.ok X* viminfo
--- 39,45 ----
  $(SCRIPTS) $(SCRIPTS_GUI): $(VIMPROG)
  
  clean:
! 	-rm -rf *.out *.failed *.rej *.orig test.log tiny.vim small.vim mbyte.vim test.ok X* valgrind.pid* viminfo
  
  test1.out: test1.in
  	-rm -f $*.failed tiny.vim small.vim mbyte.vim test.ok X* viminfo
***************
*** 65,70 ****
--- 65,74 ----
  		else echo $* NO OUTPUT >>test.log; \
  		fi"
  	-rm -rf X* test.ok viminfo
+ 
+ test49.out: test49.vim
+ 
+ test60.out: test60.vim
  
  nolog:
  	-echo Test results: >test.log
*** ../vim-7.1.119/src/testdir/test14.in	Sun Jun 13 20:24:08 2004
--- src/testdir/test14.in	Sun Sep 16 15:57:54 2007
***************
*** 18,23 ****
--- 18,24 ----
  : let tt = "o\<C-V>65\<C-V>x42\<C-V>o103 \<C-V>33a\<C-V>xfg\<C-V>o78\<Esc>"
  :endif
  :exe "normal " . tt
+ :unlet tt
  :.w >>test.out
  :set vb
  /^Piece
*** ../vim-7.1.119/src/testdir/test26.in	Sun Jun 13 17:05:48 2004
--- src/testdir/test26.in	Sun Sep 16 16:54:19 2007
***************
*** 37,42 ****
--- 37,43 ----
  :    endif
  :  endif
  :endwhile
+ :unlet i j
  :'t,$w! test.out
  :qa!
  ENDTEST
*** ../vim-7.1.119/src/testdir/test34.in	Sun Apr 30 20:46:14 2006
--- src/testdir/test34.in	Sun Sep 16 21:25:47 2007
***************
*** 52,58 ****
  ---*---
  (one
  (two
! [(one again:$-5,$wq! test.out
  ENDTEST
  
  here
--- 52,66 ----
  ---*---
  (one
  (two
! [(one again:$-5,$w! test.out
! :delfunc Table
! :delfunc Compute
! :delfunc Expr1
! :delfunc Expr2
! :delfunc ListItem
! :delfunc ListReset
! :unlet retval counter
! :q!
  ENDTEST
  
  here
*** ../vim-7.1.119/src/testdir/test45.in	Sun Jun 13 19:57:02 2004
--- src/testdir/test45.in	Sun Sep 16 18:27:20 2007
***************
*** 55,60 ****
--- 55,61 ----
  /kk$
  :call append("$", foldlevel("."))
  :/^last/+1,$w! test.out
+ :delfun Flvl
  :qa!
  ENDTEST
  
*** ../vim-7.1.119/src/testdir/test47.in	Sun Jun 13 18:40:29 2004
--- src/testdir/test47.in	Sun Sep 16 18:32:03 2007
***************
*** 34,39 ****
--- 34,40 ----
  :call append("$", two)
  :call append("$", three)
  :$-2,$w! test.out
+ :unlet one two three
  :qa!
  ENDTEST
  
*** ../vim-7.1.119/src/testdir/test49.in	Sun Jun 13 18:10:00 2004
--- src/testdir/test49.in	Sun Sep 16 23:30:35 2007
***************
*** 1,13 ****
  This is a test of the script language.
  
  If after adding a new test, the test output doesn't appear properly in
! test49.failed, try to add one ore more "G"s at the line before ENDTEST.
  
  STARTTEST
  :so small.vim
  :se nocp nomore viminfo+=nviminfo
  :so test49.vim
! GGGGGGGGGG"rp:.-,$wq! test.out
  ENDTEST
  
  Results of test49.vim:
--- 1,29 ----
  This is a test of the script language.
  
  If after adding a new test, the test output doesn't appear properly in
! test49.failed, try to add one ore more "G"s at the line ending in "test.out"
  
  STARTTEST
  :so small.vim
  :se nocp nomore viminfo+=nviminfo
  :so test49.vim
! GGGGGGGGGGGGGG"rp:.-,$w! test.out
! :"
! :" make valgrind happy
! :redir => funclist
! :silent func
! :redir END
! :for line in split(funclist, "\n")
! :  let name = matchstr(line, 'function \zs[A-Z]\w*\ze(')
! :  if name != ''
! :    exe "delfunc " . name
! :  endif
! :endfor
! :for v in keys(g:)
! :  silent! exe "unlet " . v
! :endfor
! :unlet v
! :qa!
  ENDTEST
  
  Results of test49.vim:
*** ../vim-7.1.119/src/testdir/test55.in	Sat May  5 20:03:56 2007
--- src/testdir/test55.in	Mon Sep 17 19:53:48 2007
***************
*** 345,350 ****
--- 345,354 ----
  :endfun
  :call Test(1, 2, [3, 4], {5: 6})  " This may take a while
  :"
+ :delfunc Test
+ :unlet dict
+ :call garbagecollect(1)
+ :"
  :/^start:/,$wq! test.out
  ENDTEST
  
*** ../vim-7.1.119/src/testdir/test56.in	Tue Sep  5 13:36:02 2006
--- src/testdir/test56.in	Sun Sep 16 17:54:20 2007
***************
*** 17,21 ****
  fun s:DoNothing()
    call append(line('$'), "nothing line")
  endfun
! nnoremap <buffer> _x	:call <SID>DoNothing()<bar>call <SID>DoLast()<cr>
  end:
--- 17,21 ----
  fun s:DoNothing()
    call append(line('$'), "nothing line")
  endfun
! nnoremap <buffer> _x	:call <SID>DoNothing()<bar>call <SID>DoLast()<bar>delfunc <SID>DoNothing<bar>delfunc <SID>DoLast<cr>
  end:
*** ../vim-7.1.119/src/testdir/test58.in	Wed Apr  5 22:38:56 2006
--- src/testdir/test58.in	Sun Sep 16 18:17:03 2007
***************
*** 86,91 ****
--- 86,92 ----
  :$put =str
  `m]s:let [str, a] = spellbadword()
  :$put =str
+ :unlet str a
  :"
  :" Postponed prefixes
  :call TestOne('2', '1')
***************
*** 99,104 ****
--- 100,109 ----
  :"
  :" NOSLITSUGS
  :call TestOne('8', '8')
+ :"
+ :" clean up for valgrind
+ :delfunc TestOne
+ :set spl= enc=latin1
  :"
  gg:/^test output:/,$wq! test.out
  ENDTEST
*** ../vim-7.1.119/src/testdir/test59.in	Wed Apr  5 22:27:11 2006
--- src/testdir/test59.in	Sun Sep 16 18:17:23 2007
***************
*** 90,95 ****
--- 90,96 ----
  :$put =str
  `m]s:let [str, a] = spellbadword()
  :$put =str
+ :unlet str a
  :"
  :" Postponed prefixes
  :call TestOne('2', '1')
***************
*** 100,105 ****
--- 101,110 ----
  :call TestOne('5', '5')
  :call TestOne('6', '6')
  :call TestOne('7', '7')
+ :"
+ :" clean up for valgrind
+ :delfunc TestOne
+ :set spl= enc=latin1
  :"
  gg:/^test output:/,$wq! test.out
  ENDTEST
*** ../vim-7.1.119/src/testdir/test60.in	Fri May  5 23:11:11 2006
--- src/testdir/test60.in	Mon Sep 17 19:58:43 2007
***************
*** 569,574 ****
--- 569,577 ----
      redir END
  endfunction
  :call TestExists()
+ :delfunc TestExists
+ :delfunc RunTest
+ :delfunc TestFuncArg
  :edit! test.out
  :set ff=unix
  :w
*** ../vim-7.1.119/src/testdir/test60.vim	Fri Jan 13 00:14:55 2006
--- src/testdir/test60.vim	Mon Sep 17 19:56:02 2007
***************
*** 94,97 ****
--- 94,98 ----
  else
      echo "FAILED"
  endif
+ unlet str
  
*** ../vim-7.1.119/src/testdir/test62.in	Sun Apr 30 20:28:14 2006
--- src/testdir/test62.in	Sun Sep 16 17:24:04 2007
***************
*** 7,12 ****
--- 7,13 ----
  :let nr = tabpagenr()
  :q
  :call append(line('$'), 'tab page ' . nr)
+ :unlet nr
  :"
  :" Open three tab pages and use ":tabdo"
  :0tabnew
***************
*** 23,28 ****
--- 24,30 ----
  :q!
  :call append(line('$'), line1)
  :call append(line('$'), line2)
+ :unlet line1 line2
  :"
  :"
  :/^Results/,$w! test.out
*** ../vim-7.1.119/src/testdir/test63.in	Thu Jul 26 22:55:11 2007
--- src/testdir/test63.in	Sun Sep 16 17:11:07 2007
***************
*** 60,66 ****
  :else
  :  let @r .= "FAILED\n"
  :endif
! :" --- Check that "matchdelete()" returns 0 if succesfull and otherwise -1.
  :let @r .= "*** Test 6: "
  :let m = matchadd("MyGroup1", "TODO")
  :let r1 = matchdelete(m)
--- 60,66 ----
  :else
  :  let @r .= "FAILED\n"
  :endif
! :" --- Check that "matchdelete()" returns 0 if successful and otherwise -1.
  :let @r .= "*** Test 6: "
  :let m = matchadd("MyGroup1", "TODO")
  :let r1 = matchdelete(m)
***************
*** 117,123 ****
  :" --- Check that "setmatches()" will not add two matches with the same ID. The
  :" --- expected behaviour (for now) is to add the first match but not the
  :" --- second and to return 0 (even though it is a matter of debate whether
! :" --- this can be considered succesfull behaviour).
  :let @r .= "*** Test 9: "
  :let r1 = setmatches([{'group': 'MyGroup1', 'pattern': 'TODO', 'priority': 10, 'id': 1}, {'group': 'MyGroup2', 'pattern': 'FIXME', 'priority': 10, 'id': 1}])
  :if getmatches() == [{'group': 'MyGroup1', 'pattern': 'TODO', 'priority': 10, 'id': 1}] && r1 == 0
--- 117,123 ----
  :" --- Check that "setmatches()" will not add two matches with the same ID. The
  :" --- expected behaviour (for now) is to add the first match but not the
  :" --- second and to return 0 (even though it is a matter of debate whether
! :" --- this can be considered successful behaviour).
  :let @r .= "*** Test 9: "
  :let r1 = setmatches([{'group': 'MyGroup1', 'pattern': 'TODO', 'priority': 10, 'id': 1}, {'group': 'MyGroup2', 'pattern': 'FIXME', 'priority': 10, 'id': 1}])
  :if getmatches() == [{'group': 'MyGroup1', 'pattern': 'TODO', 'priority': 10, 'id': 1}] && r1 == 0
***************
*** 127,133 ****
  :endif
  :call clearmatches()
  :unlet r1
! :" --- Check that "setmatches()" returns 0 if succesfull and otherwise -1.
  :" --- (A range of valid and invalid input values are tried out to generate the
  :" --- return values.)
  :let @r .= "*** Test 10: "
--- 127,133 ----
  :endif
  :call clearmatches()
  :unlet r1
! :" --- Check that "setmatches()" returns 0 if successful and otherwise -1.
  :" --- (A range of valid and invalid input values are tried out to generate the
  :" --- return values.)
  :let @r .= "*** Test 10: "
*** ../vim-7.1.119/src/testdir/test64.in	Tue Aug 14 17:28:14 2007
--- src/testdir/test64.in	Sun Sep 16 17:43:03 2007
***************
*** 44,51 ****
--- 44,53 ----
  :        $put ='ERROR: pat: \"' . t[0] . '\", text: \"' . t[1] . '\", submatch ' . i . ': \"' . l[i] . '\", expected: \"' . e . '\"'
  :      endif
  :    endfor
+ :    unlet i
  :  endif
  :endfor
+ :unlet t tl e l
  :/^Results/,$wq! test.out
  ENDTEST
  
*** ../vim-7.1.119/src/version.c	Tue Sep 25 14:50:19 2007
--- src/version.c	Tue Sep 25 17:36:22 2007
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     120,
  /**/

-- 
BEDEVERE: How do you know so much about swallows?
ARTHUR:   Well you have to know these things when you're a king, you know.
                 "Monty Python and the Holy Grail" PYTHON (MONTY) PICTURES LTD

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: patch 7.1.121
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.121
Problem:    Using ":cd %:h" when editing a file in the current directory
	    results in an error message for using an empty string.
Solution:   When "%:h" results in an empty string use ".".
Files:	    src/eval.c


*** ../vim-7.1.120/src/eval.c	Tue Sep 25 17:54:41 2007
--- src/eval.c	Sun Sep 16 19:24:49 2007
***************
*** 21308,21321 ****
  	*usedlen += 2;
  	s = get_past_head(*fnamep);
  	while (tail > s && after_pathsep(s, tail))
! 	    --tail;
  	*fnamelen = (int)(tail - *fnamep);
  #ifdef VMS
  	if (*fnamelen > 0)
  	    *fnamelen += 1; /* the path separator is part of the path */
  #endif
! 	while (tail > s && !after_pathsep(s, tail))
! 	    mb_ptr_back(*fnamep, tail);
      }
  
      /* ":8" - shortname  */
--- 21308,21334 ----
  	*usedlen += 2;
  	s = get_past_head(*fnamep);
  	while (tail > s && after_pathsep(s, tail))
! 	    mb_ptr_back(*fnamep, tail);
  	*fnamelen = (int)(tail - *fnamep);
  #ifdef VMS
  	if (*fnamelen > 0)
  	    *fnamelen += 1; /* the path separator is part of the path */
  #endif
! 	if (*fnamelen == 0)
! 	{
! 	    /* Result is empty.  Turn it into "." to make ":cd %:h" work. */
! 	    p = vim_strsave((char_u *)".");
! 	    if (p == NULL)
! 		return -1;
! 	    vim_free(*bufp);
! 	    *bufp = *fnamep = tail = p;
! 	    *fnamelen = 1;
! 	}
! 	else
! 	{
! 	    while (tail > s && !after_pathsep(s, tail))
! 		mb_ptr_back(*fnamep, tail);
! 	}
      }
  
      /* ":8" - shortname  */
*** ../vim-7.1.120/src/version.c	Tue Sep 25 17:54:41 2007
--- src/version.c	Tue Sep 25 20:38:08 2007
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     121,
  /**/

-- 
It is illegal for anyone to try and stop a child from playfully jumping over
puddles of water.
		[real standing law in California, United States of America]

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: patch 7.1.122
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.122
Problem:    Mac: building Vim.app fails.  Using wrong architecture.
Solution:   Use line continuation for the gui_bundle dependency.  Detect the
	    system architecture with "uname -a".
Files:	    src/main.aap


*** ../vim-7.1.121/src/main.aap	Thu May 10 18:48:19 2007
--- src/main.aap	Tue Sep 25 21:26:03 2007
***************
*** 56,64 ****
      config {virtual} auto/config.h auto/config.aap :
                           auto/configure.aap configure.aap
                           config.arg config.h.in config.aap.in
          :sys CONFIG_STATUS=auto/config.status
                  ./configure.aap `file2string("config.arg")`
!                     --with-mac-arch=ppc
                      --cache-file=auto/config.cache
  
      # Configure arguments: create an empty "config.arg" file when its missing
--- 56,71 ----
      config {virtual} auto/config.h auto/config.aap :
                           auto/configure.aap configure.aap
                           config.arg config.h.in config.aap.in
+         # Use "uname -a" to detect the architecture of the system.
+         @ok, uname = redir_system('uname -a', 0)
+         @if string.find(uname, "i386") >= 0:
+         @   arch = "i386"
+         @else:
+         @   arch = "ppc"
+         :print Building for $arch system
          :sys CONFIG_STATUS=auto/config.status
                  ./configure.aap `file2string("config.arg")`
!                     --with-mac-arch=$arch
                      --cache-file=auto/config.cache
  
      # Configure arguments: create an empty "config.arg" file when its missing
***************
*** 1167,1173 ****
          :symlink `os.getcwd()`/../runtime $RESDIR/vim/runtime
  # TODO: Create the vimtutor application.
  
! gui_bundle {virtual}: $(RESDIR) bundle-dir bundle-executable bundle-info
                          bundle-resource bundle-language
  
  bundle-dir {virtual}: $(APPDIR)/Contents $(VIMTARGET)
--- 1174,1180 ----
          :symlink `os.getcwd()`/../runtime $RESDIR/vim/runtime
  # TODO: Create the vimtutor application.
  
! gui_bundle {virtual}: $(RESDIR) bundle-dir bundle-executable bundle-info \
                          bundle-resource bundle-language
  
  bundle-dir {virtual}: $(APPDIR)/Contents $(VIMTARGET)
***************
*** 1187,1193 ****
          :sys m4 $(M4FLAGSX) infplist.xml > $(APPDIR)/Contents/Info.plist
  
  bundle-resource {virtual}: bundle-dir bundle-rsrc
!     :copy {force} $(RSRC_DIR)/*.icns $(RESDIR)
  
  ### Classic resources
  # Resource fork (in the form of a .rsrc file) for Classic Vim (Mac OS 9)
--- 1194,1200 ----
          :sys m4 $(M4FLAGSX) infplist.xml > $(APPDIR)/Contents/Info.plist
  
  bundle-resource {virtual}: bundle-dir bundle-rsrc
!         :copy {force} $(RSRC_DIR)/*.icns $(RESDIR)
  
  ### Classic resources
  # Resource fork (in the form of a .rsrc file) for Classic Vim (Mac OS 9)
*** ../vim-7.1.121/src/version.c	Tue Sep 25 20:39:14 2007
--- src/version.c	Tue Sep 25 22:12:16 2007
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     122,
  /**/

-- 
Men may not be seen publicly in any kind of strapless gown.
		[real standing law in Florida, United States of America]

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: patch 7.1.123
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.123
Problem:    Win32: ":edit foo ~ foo" expands "~".
Solution:   Change the call to expand_env().
Files:	    src/ex_docmd.c, src/misc1.c, src/proto/misc1.pro, src/option.c


*** ../vim-7.1.122/src/ex_docmd.c	Sun Aug 19 22:42:27 2007
--- src/ex_docmd.c	Wed Sep 26 20:29:36 2007
***************
*** 4403,4409 ****
  			    || vim_strchr(eap->arg, '~') != NULL)
  		    {
  			expand_env_esc(eap->arg, NameBuff, MAXPATHL,
! 								 TRUE, NULL);
  			has_wildcards = mch_has_wildcard(NameBuff);
  			p = NameBuff;
  		    }
--- 4402,4408 ----
  			    || vim_strchr(eap->arg, '~') != NULL)
  		    {
  			expand_env_esc(eap->arg, NameBuff, MAXPATHL,
! 							    TRUE, TRUE, NULL);
  			has_wildcards = mch_has_wildcard(NameBuff);
  			p = NameBuff;
  		    }
*** ../vim-7.1.122/src/misc1.c	Tue Aug 14 22:15:53 2007
--- src/misc1.c	Tue Sep 25 17:30:01 2007
***************
*** 3506,3514 ****
  #endif
  
  /*
   * Expand environment variable with path name.
   * "~/" is also expanded, using $HOME.	For Unix "~user/" is expanded.
!  * Skips over "\ ", "\~" and "\$".
   * If anything fails no expansion is done and dst equals src.
   */
      void
--- 3506,3543 ----
  #endif
  
  /*
+  * Call expand_env() and store the result in an allocated string.
+  * This is not very memory efficient, this expects the result to be freed
+  * again soon.
+  */
+     char_u *
+ expand_env_save(src)
+     char_u	*src;
+ {
+     return expand_env_save_opt(src, FALSE);
+ }
+ 
+ /*
+  * Idem, but when "one" is TRUE handle the string as one file name, only
+  * expand "~" at the start.
+  */
+     char_u *
+ expand_env_save_opt(src, one)
+     char_u	*src;
+     int		one;
+ {
+     char_u	*p;
+ 
+     p = alloc(MAXPATHL);
+     if (p != NULL)
+ 	expand_env_esc(src, p, MAXPATHL, FALSE, one, NULL);
+     return p;
+ }
+ 
+ /*
   * Expand environment variable with path name.
   * "~/" is also expanded, using $HOME.	For Unix "~user/" is expanded.
!  * Skips over "\ ", "\~" and "\$" (not for Win32 though).
   * If anything fails no expansion is done and dst equals src.
   */
      void
***************
*** 3517,3531 ****
      char_u	*dst;		/* where to put the result */
      int		dstlen;		/* maximum length of the result */
  {
!     expand_env_esc(src, dst, dstlen, FALSE, NULL);
  }
  
      void
! expand_env_esc(srcp, dst, dstlen, esc, startstr)
      char_u	*srcp;		/* input string e.g. "$HOME/vim.hlp" */
      char_u	*dst;		/* where to put the result */
      int		dstlen;		/* maximum length of the result */
      int		esc;		/* escape spaces in expanded variables */
      char_u	*startstr;	/* start again after this (can be NULL) */
  {
      char_u	*src;
--- 3546,3561 ----
      char_u	*dst;		/* where to put the result */
      int		dstlen;		/* maximum length of the result */
  {
!     expand_env_esc(src, dst, dstlen, FALSE, FALSE, NULL);
  }
  
      void
! expand_env_esc(srcp, dst, dstlen, esc, one, startstr)
      char_u	*srcp;		/* input string e.g. "$HOME/vim.hlp" */
      char_u	*dst;		/* where to put the result */
      int		dstlen;		/* maximum length of the result */
      int		esc;		/* escape spaces in expanded variables */
+     int		one;		/* "srcp" is one file name */
      char_u	*startstr;	/* start again after this (can be NULL) */
  {
      char_u	*src;
***************
*** 3766,3771 ****
--- 3796,3803 ----
  	{
  	    /*
  	     * Recognize the start of a new name, for '~'.
+ 	     * Don't do this when "one" is TRUE, to avoid expanding "~" in
+ 	     * ":edit foo ~ foo".
  	     */
  	    at_start = FALSE;
  	    if (src[0] == '\\' && src[1] != NUL)
***************
*** 3773,3779 ****
  		*dst++ = *src++;
  		--dstlen;
  	    }
! 	    else if (src[0] == ' ' || src[0] == ',')
  		at_start = TRUE;
  	    *dst++ = *src++;
  	    --dstlen;
--- 3805,3811 ----
  		*dst++ = *src++;
  		--dstlen;
  	    }
! 	    else if ((src[0] == ' ' || src[0] == ',') && !one)
  		at_start = TRUE;
  	    *dst++ = *src++;
  	    --dstlen;
***************
*** 4070,4092 ****
  }
  
  /*
-  * Call expand_env() and store the result in an allocated string.
-  * This is not very memory efficient, this expects the result to be freed
-  * again soon.
-  */
-     char_u *
- expand_env_save(src)
-     char_u	*src;
- {
-     char_u	*p;
- 
-     p = alloc(MAXPATHL);
-     if (p != NULL)
- 	expand_env(src, p, MAXPATHL);
-     return p;
- }
- 
- /*
   * Our portable version of setenv.
   */
      void
--- 4102,4107 ----
***************
*** 9139,9145 ****
  	     */
  	    if (vim_strpbrk(p, (char_u *)"$~") != NULL)
  	    {
! 		p = expand_env_save(p);
  		if (p == NULL)
  		    p = pat[i];
  #ifdef UNIX
--- 9154,9160 ----
  	     */
  	    if (vim_strpbrk(p, (char_u *)"$~") != NULL)
  	    {
! 		p = expand_env_save_opt(p, TRUE);
  		if (p == NULL)
  		    p = pat[i];
  #ifdef UNIX
*** ../vim-7.1.122/src/proto/misc1.pro	Sat May  5 20:15:33 2007
--- src/proto/misc1.pro	Tue Sep 25 17:22:36 2007
***************
*** 48,57 ****
  void vim_beep __ARGS((void));
  void init_homedir __ARGS((void));
  void free_homedir __ARGS((void));
  void expand_env __ARGS((char_u *src, char_u *dst, int dstlen));
! void expand_env_esc __ARGS((char_u *srcp, char_u *dst, int dstlen, int esc, char_u *startstr));
  char_u *vim_getenv __ARGS((char_u *name, int *mustfree));
- char_u *expand_env_save __ARGS((char_u *src));
  void vim_setenv __ARGS((char_u *name, char_u *val));
  char_u *get_env_name __ARGS((expand_T *xp, int idx));
  void home_replace __ARGS((buf_T *buf, char_u *src, char_u *dst, int dstlen, int one));
--- 48,58 ----
  void vim_beep __ARGS((void));
  void init_homedir __ARGS((void));
  void free_homedir __ARGS((void));
+ char_u *expand_env_save __ARGS((char_u *src));
+ char_u *expand_env_save_opt __ARGS((char_u *src, int one));
  void expand_env __ARGS((char_u *src, char_u *dst, int dstlen));
! void expand_env_esc __ARGS((char_u *srcp, char_u *dst, int dstlen, int esc, int one, char_u *startstr));
  char_u *vim_getenv __ARGS((char_u *name, int *mustfree));
  void vim_setenv __ARGS((char_u *name, char_u *val));
  char_u *get_env_name __ARGS((expand_T *xp, int idx));
  void home_replace __ARGS((buf_T *buf, char_u *src, char_u *dst, int dstlen, int one));
*** ../vim-7.1.122/src/option.c	Tue Sep 25 14:50:19 2007
--- src/option.c	Tue Sep 25 17:20:05 2007
***************
*** 4996,5002 ****
       * For 'spellsuggest' expand after "file:".
       */
      expand_env_esc(val, NameBuff, MAXPATHL,
! 	    (char_u **)options[opt_idx].var == &p_tags,
  #ifdef FEAT_SPELL
  	    (char_u **)options[opt_idx].var == &p_sps ? (char_u *)"file:" :
  #endif
--- 4996,5002 ----
       * For 'spellsuggest' expand after "file:".
       */
      expand_env_esc(val, NameBuff, MAXPATHL,
! 	    (char_u **)options[opt_idx].var == &p_tags, FALSE,
  #ifdef FEAT_SPELL
  	    (char_u **)options[opt_idx].var == &p_sps ? (char_u *)"file:" :
  #endif
*** ../vim-7.1.122/src/version.c	Tue Sep 25 22:13:14 2007
--- src/version.c	Wed Sep 26 22:30:59 2007
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     123,
  /**/

-- 
So when I saw the post to comp.editors, I rushed over to the FTP site to
grab it.  So I yank apart the tarball, light x candles, where x= the
vim version multiplied by the md5sum of the source divided by the MAC of
my NIC (8A3FA78155A8A1D346C3C4A), put on black robes, dim the lights,
wave a dead chicken over the hard drive, and summon the power of GNU GCC
with the magic words "make config ; make!".
		[Jason Spence, compiling Vim 5.0]

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: patch 7.1.124
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.124 (extra)
Problem:    Mac: When dropping a file on Vim.app that is already in the buffer
	    list (from .viminfo) results in editing an empty, unnamed buffer.
	    (Axel Kielhorn)  Also: warning for unused variable.
Solution:   Move to the buffer of the first agument.  Delete unused variable.
Files:	    src/gui_mac.c


*** ../vim-7.1.123/src/gui_mac.c	Thu Aug 30 12:50:00 2007
--- src/gui_mac.c	Sat Sep 29 13:12:26 2007
***************
*** 1046,1051 ****
--- 1046,1052 ----
      {
  	int i;
  	char_u *p;
+ 	int fnum = -1;
  
  	/* these are the initial files dropped on the Vim icon */
  	for (i = 0 ; i < numFiles; i++)
***************
*** 1055,1060 ****
--- 1056,1073 ----
  		mch_exit(2);
  	    else
  		alist_add(&global_alist, p, 2);
+ 	    if (fnum == -1)
+ 		fnum = GARGLIST[GARGCOUNT - 1].ae_fnum;
+ 	}
+ 
+ 	/* If the file name was already in the buffer list we need to switch
+ 	 * to it. */
+ 	if (curbuf->b_fnum != fnum)
+ 	{
+ 	    char_u cmd[30];
+ 
+ 	    vim_snprintf((char *)cmd, 30, "silent %dbuffer", fnum);
+ 	    do_cmdline_cmd(cmd);
  	}
  
  	/* Change directory to the location of the first file. */
***************
*** 2920,2926 ****
      /* TODO: Move most of this stuff toward gui_mch_init */
      Rect	windRect;
      MenuHandle	pomme;
-     long	gestalt_rc;
      EventTypeSpec   eventTypeSpec;
      EventHandlerRef mouseWheelHandlerRef;
  #ifdef USE_CARBONKEYHANDLER
--- 2933,2938 ----
*** ../vim-7.1.123/src/version.c	Wed Sep 26 22:35:06 2007
--- src/version.c	Sat Sep 29 13:13:16 2007
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     124,
  /**/

-- 
ERIC IDLE PLAYED: THE DEAD COLLECTOR, MR BINT (A VILLAGE NE'ER-DO -WELL VERY
                  KEEN ON BURNING WITCHES), SIR ROBIN, THE GUARD WHO DOESN'T
                  HICOUGH BUT TRIES TO GET THINGS STRAIGHT, CONCORDE (SIR
                  LAUNCELOT'S TRUSTY STEED), ROGER THE SHRUBBER (A SHRUBBER),
                  BROTHER MAYNARD
                 "Monty Python and the Holy Grail" PYTHON (MONTY) PICTURES LTD

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: patch 7.1.125
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.125
Problem:    The TermResponse autocommand event is not always triggered. (Aron
	    Griffis)
Solution:   When unblocking autocommands check if v:termresponse changed and
	    trigger the event then.
Files:	    src/buffer.c, src/diff.c, src/ex_getln.c, src/fileio.c,
	    src/globals.h, src/misc2.c, src/proto/fileio.pro, src/window.c


*** ../vim-7.1.124/src/buffer.c	Sun Aug 12 15:50:26 2007
--- src/buffer.c	Wed Sep 26 20:05:38 2007
***************
*** 5515,5525 ****
  
  #ifdef FEAT_AUTOCMD
      if (!aucmd)		    /* Don't trigger BufDelete autocommands here. */
! 	++autocmd_block;
  #endif
      close_buffer(NULL, buf, DOBUF_WIPE);
  #ifdef FEAT_AUTOCMD
      if (!aucmd)
! 	--autocmd_block;
  #endif
  }
--- 5512,5522 ----
  
  #ifdef FEAT_AUTOCMD
      if (!aucmd)		    /* Don't trigger BufDelete autocommands here. */
! 	block_autocmds();
  #endif
      close_buffer(NULL, buf, DOBUF_WIPE);
  #ifdef FEAT_AUTOCMD
      if (!aucmd)
! 	unblock_autocmds();
  #endif
  }
*** ../vim-7.1.124/src/diff.c	Tue Feb 20 04:43:13 2007
--- src/diff.c	Tue Sep 25 22:01:40 2007
***************
*** 840,850 ****
  		    tmp_orig, tmp_new);
  	    append_redir(cmd, p_srr, tmp_diff);
  #ifdef FEAT_AUTOCMD
! 	    ++autocmd_block;	/* Avoid ShellCmdPost stuff */
  #endif
  	    (void)call_shell(cmd, SHELL_FILTER|SHELL_SILENT|SHELL_DOOUT);
  #ifdef FEAT_AUTOCMD
! 	    --autocmd_block;
  #endif
  	    vim_free(cmd);
  	}
--- 840,850 ----
  		    tmp_orig, tmp_new);
  	    append_redir(cmd, p_srr, tmp_diff);
  #ifdef FEAT_AUTOCMD
! 	    block_autocmds();	/* Avoid ShellCmdPost stuff */
  #endif
  	    (void)call_shell(cmd, SHELL_FILTER|SHELL_SILENT|SHELL_DOOUT);
  #ifdef FEAT_AUTOCMD
! 	    unblock_autocmds();
  #endif
  	    vim_free(cmd);
  	}
***************
*** 949,959 ****
  # endif
  		eap->arg);
  #ifdef FEAT_AUTOCMD
! 	++autocmd_block;	/* Avoid ShellCmdPost stuff */
  #endif
  	(void)call_shell(buf, SHELL_FILTER | SHELL_COOKED);
  #ifdef FEAT_AUTOCMD
! 	--autocmd_block;
  #endif
      }
  
--- 949,959 ----
  # endif
  		eap->arg);
  #ifdef FEAT_AUTOCMD
! 	block_autocmds();	/* Avoid ShellCmdPost stuff */
  #endif
  	(void)call_shell(buf, SHELL_FILTER | SHELL_COOKED);
  #ifdef FEAT_AUTOCMD
! 	unblock_autocmds();
  #endif
      }
  
*** ../vim-7.1.124/src/ex_getln.c	Thu Sep 13 18:25:08 2007
--- src/ex_getln.c	Tue Sep 25 22:03:05 2007
***************
*** 5925,5931 ****
  
  # ifdef FEAT_AUTOCMD
      /* Don't execute autocommands while creating the window. */
!     ++autocmd_block;
  # endif
      /* don't use a new tab page */
      cmdmod.tab = 0;
--- 5925,5931 ----
  
  # ifdef FEAT_AUTOCMD
      /* Don't execute autocommands while creating the window. */
!     block_autocmds();
  # endif
      /* don't use a new tab page */
      cmdmod.tab = 0;
***************
*** 5934,5939 ****
--- 5934,5942 ----
      if (win_split((int)p_cwh, WSP_BOT) == FAIL)
      {
  	beep_flush();
+ # ifdef FEAT_AUTOCMD
+ 	unblock_autocmds();
+ # endif
  	return K_IGNORE;
      }
      cmdwin_type = ccline.cmdfirstc;
***************
*** 5956,5962 ****
  
  # ifdef FEAT_AUTOCMD
      /* Do execute autocommands for setting the filetype (load syntax). */
!     --autocmd_block;
  # endif
  
      /* Showing the prompt may have set need_wait_return, reset it. */
--- 5959,5965 ----
  
  # ifdef FEAT_AUTOCMD
      /* Do execute autocommands for setting the filetype (load syntax). */
!     unblock_autocmds();
  # endif
  
      /* Showing the prompt may have set need_wait_return, reset it. */
***************
*** 6110,6116 ****
  
  # ifdef FEAT_AUTOCMD
  	/* Don't execute autocommands while deleting the window. */
! 	++autocmd_block;
  # endif
  	wp = curwin;
  	bp = curbuf;
--- 6113,6119 ----
  
  # ifdef FEAT_AUTOCMD
  	/* Don't execute autocommands while deleting the window. */
! 	block_autocmds();
  # endif
  	wp = curwin;
  	bp = curbuf;
***************
*** 6122,6128 ****
  	win_size_restore(&winsizes);
  
  # ifdef FEAT_AUTOCMD
! 	--autocmd_block;
  # endif
      }
  
--- 6125,6131 ----
  	win_size_restore(&winsizes);
  
  # ifdef FEAT_AUTOCMD
! 	unblock_autocmds();
  # endif
      }
  
*** ../vim-7.1.124/src/fileio.c	Sun Aug 12 15:50:26 2007
--- src/fileio.c	Wed Sep 26 20:02:54 2007
***************
*** 7165,7170 ****
--- 7187,7193 ----
  
  static event_T	last_event;
  static int	last_group;
+ static int	autocmd_blocked = 0;	/* block all autocmds */
  
  /*
   * Show the autocommands for one AutoPat.
***************
*** 8454,8460 ****
       * Quickly return if there are no autocommands for this event or
       * autocommands are blocked.
       */
!     if (first_autopat[(int)event] == NULL || autocmd_block > 0)
  	goto BYPASS_AU;
  
      /*
--- 8477,8483 ----
       * Quickly return if there are no autocommands for this event or
       * autocommands are blocked.
       */
!     if (first_autopat[(int)event] == NULL || autocmd_blocked > 0)
  	goto BYPASS_AU;
  
      /*
***************
*** 8766,8771 ****
--- 8789,8828 ----
  	aubuflocal_remove(buf);
  
      return retval;
+ }
+ 
+ # ifdef FEAT_EVAL
+ static char_u	*old_termresponse = NULL;
+ # endif
+ 
+ /*
+  * Block triggering autocommands until unblock_autocmd() is called.
+  * Can be used recursively, so long as it's symmetric.
+  */
+     void
+ block_autocmds()
+ {
+ # ifdef FEAT_EVAL
+     /* Remember the value of v:termresponse. */
+     if (autocmd_blocked == 0)
+ 	old_termresponse = get_vim_var_str(VV_TERMRESPONSE);
+ # endif
+     ++autocmd_blocked;
+ }
+ 
+     void
+ unblock_autocmds()
+ {
+     --autocmd_blocked;
+ 
+ # ifdef FEAT_EVAL
+     /* When v:termresponse was set while autocommands were blocked, trigger
+      * the autocommands now.  Esp. useful when executing a shell command
+      * during startup (vimdiff). */
+     if (autocmd_blocked == 0
+ 		      && get_vim_var_str(VV_TERMRESPONSE) != old_termresponse)
+ 	apply_autocmds(EVENT_TERMRESPONSE, NULL, NULL, FALSE, curbuf);
+ # endif
  }
  
  /*
*** ../vim-7.1.124/src/globals.h	Tue Sep 25 17:54:41 2007
--- src/globals.h	Tue Sep 25 22:03:39 2007
***************
*** 366,372 ****
  EXTERN int	autocmd_busy INIT(= FALSE);	/* Is apply_autocmds() busy? */
  EXTERN int	autocmd_no_enter INIT(= FALSE); /* *Enter autocmds disabled */
  EXTERN int	autocmd_no_leave INIT(= FALSE); /* *Leave autocmds disabled */
- EXTERN int	autocmd_block INIT(= 0);	/* block all autocmds */
  EXTERN int	modified_was_set;		/* did ":set modified" */
  EXTERN int	did_filetype INIT(= FALSE);	/* FileType event found */
  EXTERN int	keep_filetype INIT(= FALSE);	/* value for did_filetype when
--- 366,371 ----
*** ../vim-7.1.124/src/misc2.c	Thu May 10 19:58:47 2007
--- src/misc2.c	Tue Sep 25 22:04:39 2007
***************
*** 972,978 ****
  	return;
      entered = TRUE;
  
!     ++autocmd_block;	    /* don't want to trigger autocommands here */
  
  #ifdef FEAT_WINDOWS
      /* close all tabs and windows */
--- 973,979 ----
  	return;
      entered = TRUE;
  
!     block_autocmds();	    /* don't want to trigger autocommands here */
  
  #ifdef FEAT_WINDOWS
      /* close all tabs and windows */
*** ../vim-7.1.124/src/proto/fileio.pro	Thu Jun 28 21:57:08 2007
--- src/proto/fileio.pro	Wed Sep 26 20:05:02 2007
***************
*** 40,45 ****
--- 41,48 ----
  int trigger_cursorhold __ARGS((void));
  int has_cursormoved __ARGS((void));
  int has_cursormovedI __ARGS((void));
+ void block_autocmds __ARGS((void));
+ void unblock_autocmds __ARGS((void));
  int has_autocmd __ARGS((event_T event, char_u *sfname, buf_T *buf));
  char_u *get_augroup_name __ARGS((expand_T *xp, int idx));
  char_u *set_context_in_autocmd __ARGS((expand_T *xp, char_u *arg, int doautocmd));
*** ../vim-7.1.124/src/window.c	Tue Sep 25 14:50:19 2007
--- src/window.c	Tue Sep 25 22:05:45 2007
***************
*** 1291,1297 ****
       * Don't execute autocommands while creating the windows.  Must do that
       * when putting the buffers in the windows.
       */
!     ++autocmd_block;
  #endif
  
      /* todo is number of windows left to create */
--- 1291,1297 ----
       * Don't execute autocommands while creating the windows.  Must do that
       * when putting the buffers in the windows.
       */
!     block_autocmds();
  #endif
  
      /* todo is number of windows left to create */
***************
*** 1313,1319 ****
  	}
  
  #ifdef FEAT_AUTOCMD
!     --autocmd_block;
  #endif
  
      /* return actual number of windows */
--- 1313,1319 ----
  	}
  
  #ifdef FEAT_AUTOCMD
!     unblock_autocmds();
  #endif
  
      /* return actual number of windows */
***************
*** 3415,3421 ****
       * Don't execute autocommands while creating the tab pages.  Must do that
       * when putting the buffers in the windows.
       */
!     ++autocmd_block;
  #endif
  
      for (todo = count - 1; todo > 0; --todo)
--- 3415,3421 ----
       * Don't execute autocommands while creating the tab pages.  Must do that
       * when putting the buffers in the windows.
       */
!     block_autocmds();
  #endif
  
      for (todo = count - 1; todo > 0; --todo)
***************
*** 3423,3429 ****
  	    break;
  
  #ifdef FEAT_AUTOCMD
!     --autocmd_block;
  #endif
  
      /* return actual number of tab pages */
--- 3423,3429 ----
  	    break;
  
  #ifdef FEAT_AUTOCMD
!     unblock_autocmds();
  #endif
  
      /* return actual number of tab pages */
***************
*** 4162,4168 ****
  	/* Don't execute autocommands while the window is not properly
  	 * initialized yet.  gui_create_scrollbar() may trigger a FocusGained
  	 * event. */
! 	++autocmd_block;
  #endif
  	/*
  	 * link the window in the window list
--- 4162,4168 ----
  	/* Don't execute autocommands while the window is not properly
  	 * initialized yet.  gui_create_scrollbar() may trigger a FocusGained
  	 * event. */
! 	block_autocmds();
  #endif
  	/*
  	 * link the window in the window list
***************
*** 4207,4213 ****
  	foldInitWin(newwin);
  #endif
  #ifdef FEAT_AUTOCMD
! 	--autocmd_block;
  #endif
  #ifdef FEAT_SEARCH_EXTRA
  	newwin->w_match_head = NULL;
--- 4207,4213 ----
  	foldInitWin(newwin);
  #endif
  #ifdef FEAT_AUTOCMD
! 	unblock_autocmds();
  #endif
  #ifdef FEAT_SEARCH_EXTRA
  	newwin->w_match_head = NULL;
***************
*** 4232,4238 ****
  #ifdef FEAT_AUTOCMD
      /* Don't execute autocommands while the window is halfway being deleted.
       * gui_mch_destroy_scrollbar() may trigger a FocusGained event. */
!     ++autocmd_block;
  #endif
  
  #ifdef FEAT_MZSCHEME
--- 4232,4238 ----
  #ifdef FEAT_AUTOCMD
      /* Don't execute autocommands while the window is halfway being deleted.
       * gui_mch_destroy_scrollbar() may trigger a FocusGained event. */
!     block_autocmds();
  #endif
  
  #ifdef FEAT_MZSCHEME
***************
*** 4295,4301 ****
      vim_free(wp);
  
  #ifdef FEAT_AUTOCMD
!     --autocmd_block;
  #endif
  }
  
--- 4295,4301 ----
      vim_free(wp);
  
  #ifdef FEAT_AUTOCMD
!     unblock_autocmds();
  #endif
  }
  
*** ../vim-7.1.124/src/version.c	Sat Sep 29 13:15:29 2007
--- src/version.c	Sat Sep 29 14:08:31 2007
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     125,
  /**/

-- 
MICHAEL PALIN PLAYED: 1ST SOLDIER WITH A KEEN INTEREST IN BIRDS, DENNIS, MR
                      DUCK (A VILLAGE CARPENTER WHO IS ALMOST KEENER THAN
                      ANYONE ELSE TO BURN WITCHES), THREE-HEADED KNIGHT, SIR
                      GALAHAD, KING OF SWAMP CASTLE, BROTHER MAYNARD'S ROOMATE
                 "Monty Python and the Holy Grail" PYTHON (MONTY) PICTURES LTD

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: patch 7.1.126
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.126
Problem:    ":vimgrep */*" fails when a BufRead autocommand changes directory.
	    (Bernhard Kuhn)
Solution:   Change back to the original directory after loading a file.
	    Also: use shorten_fname1() to avoid duplicating code.
Files:	    src/buffer.c, src/ex_docmd.c, src/fileio.c, src/gui_gtk.c,
	    src/gui_w48.c, src/proto/ex_docmd.pro, src/proto/fileio.pro,
	    src/quickfix.c


*** ../vim-7.1.125/src/buffer.c	Sat Sep 29 14:15:00 2007
--- src/buffer.c	Wed Sep 26 20:05:38 2007
***************
*** 4261,4272 ****
  do_arg_all(count, forceit, keep_tabs)
      int	count;
      int	forceit;		/* hide buffers in current windows */
!     int keep_tabs;		/* keep curren tabs, for ":tab drop file" */
  {
      int		i;
      win_T	*wp, *wpnext;
      char_u	*opened;	/* array of flags for which args are open */
!     int		opened_len;	/* lenght of opened[] */
      int		use_firstwin = FALSE;	/* use first window for arglist */
      int		split_ret = OK;
      int		p_ea_save;
--- 4261,4272 ----
  do_arg_all(count, forceit, keep_tabs)
      int	count;
      int	forceit;		/* hide buffers in current windows */
!     int keep_tabs;		/* keep current tabs, for ":tab drop file" */
  {
      int		i;
      win_T	*wp, *wpnext;
      char_u	*opened;	/* array of flags for which args are open */
!     int		opened_len;	/* length of opened[] */
      int		use_firstwin = FALSE;	/* use first window for arglist */
      int		split_ret = OK;
      int		p_ea_save;
***************
*** 4946,4955 ****
  	/* Expand "~/" in the file name at "line + 1" to a full path.
  	 * Then try shortening it by comparing with the current directory */
  	expand_env(xline, NameBuff, MAXPATHL);
! 	mch_dirname(IObuff, IOSIZE);
! 	sfname = shorten_fname(NameBuff, IObuff);
! 	if (sfname == NULL)
! 	    sfname = NameBuff;
  
  	buf = buflist_new(NameBuff, sfname, (linenr_T)0, BLN_LISTED);
  	if (buf != NULL)	/* just in case... */
--- 4946,4952 ----
  	/* Expand "~/" in the file name at "line + 1" to a full path.
  	 * Then try shortening it by comparing with the current directory */
  	expand_env(xline, NameBuff, MAXPATHL);
! 	sfname = shorten_fname1(NameBuff);
  
  	buf = buflist_new(NameBuff, sfname, (linenr_T)0, BLN_LISTED);
  	if (buf != NULL)	/* just in case... */
*** ../vim-7.1.125/src/ex_docmd.c	Wed Sep 26 22:35:06 2007
--- src/ex_docmd.c	Wed Sep 26 20:29:36 2007
***************
*** 276,282 ****
  static void	ex_swapname __ARGS((exarg_T *eap));
  static void	ex_syncbind __ARGS((exarg_T *eap));
  static void	ex_read __ARGS((exarg_T *eap));
- static void	ex_cd __ARGS((exarg_T *eap));
  static void	ex_pwd __ARGS((exarg_T *eap));
  static void	ex_equal __ARGS((exarg_T *eap));
  static void	ex_sleep __ARGS((exarg_T *eap));
--- 276,281 ----
***************
*** 7778,7784 ****
  /*
   * ":cd", ":lcd", ":chdir" and ":lchdir".
   */
!     static void
  ex_cd(eap)
      exarg_T	*eap;
  {
--- 7777,7783 ----
  /*
   * ":cd", ":lcd", ":chdir" and ":lchdir".
   */
!     void
  ex_cd(eap)
      exarg_T	*eap;
  {
*** ../vim-7.1.125/src/fileio.c	Sat Sep 29 14:15:00 2007
--- src/fileio.c	Wed Sep 26 20:02:54 2007
***************
*** 114,120 ****
  {
      int		bw_fd;		/* file descriptor */
      char_u	*bw_buf;	/* buffer with data to be written */
!     int		bw_len;	/* lenght of data */
  #ifdef HAS_BW_FLAGS
      int		bw_flags;	/* FIO_ flags */
  #endif
--- 114,120 ----
  {
      int		bw_fd;		/* file descriptor */
      char_u	*bw_buf;	/* buffer with data to be written */
!     int		bw_len;		/* length of data */
  #ifdef HAS_BW_FLAGS
      int		bw_flags;	/* FIO_ flags */
  #endif
***************
*** 5552,5557 ****
--- 5553,5579 ----
      return (int)(p - buf);
  }
  #endif
+ 
+ /*
+  * Try to find a shortname by comparing the fullname with the current
+  * directory.
+  * Returns "full_path" or pointer into "full_path" if shortened.
+  */
+     char_u *
+ shorten_fname1(full_path)
+     char_u	*full_path;
+ {
+     char_u	dirname[MAXPATHL];
+     char_u	*p = full_path;
+ 
+     if (mch_dirname(dirname, MAXPATHL) == OK)
+     {
+ 	p = shorten_fname(full_path, dirname);
+ 	if (p == NULL || *p == NUL)
+ 	    p = full_path;
+     }
+     return p;
+ }
  
  /*
   * Try to find a shortname by comparing the fullname with the current
*** ../vim-7.1.125/src/gui_gtk.c	Tue Aug 14 14:59:41 2007
--- src/gui_gtk.c	Wed Sep 26 20:07:58 2007
***************
*** 1272,1278 ****
      GtkWidget		*fc;
  #endif
      char_u		dirbuf[MAXPATHL];
-     char_u		*p;
  
  # ifdef HAVE_GTK2
      title = CONVERT_TO_UTF8(title);
--- 1272,1277 ----
***************
*** 1363,1373 ****
  	return NULL;
  
      /* shorten the file name if possible */
!     mch_dirname(dirbuf, MAXPATHL);
!     p = shorten_fname(gui.browse_fname, dirbuf);
!     if (p == NULL)
! 	p = gui.browse_fname;
!     return vim_strsave(p);
  }
  
  #if defined(HAVE_GTK2) || defined(PROTO)
--- 1362,1368 ----
  	return NULL;
  
      /* shorten the file name if possible */
!     return vim_strsave(shorten_fname1(gui.browse_fname));
  }
  
  #if defined(HAVE_GTK2) || defined(PROTO)
***************
*** 1427,1437 ****
  	return NULL;
  
      /* shorten the file name if possible */
!     mch_dirname(dirbuf, MAXPATHL);
!     p = shorten_fname(dirname, dirbuf);
!     if (p == NULL || *p == NUL)
! 	p = dirname;
!     p = vim_strsave(p);
      g_free(dirname);
      return p;
  
--- 1422,1428 ----
  	return NULL;
  
      /* shorten the file name if possible */
!     p = vim_strsave(shorten_fname1(dirname));
      g_free(dirname);
      return p;
  
*** ../vim-7.1.125/src/gui_w48.c	Thu May 10 19:17:07 2007
--- src/gui_w48.c	Wed Sep 26 20:09:33 2007
***************
*** 3301,3311 ****
      SetFocus(s_hwnd);
  
      /* Shorten the file name if possible */
!     mch_dirname(IObuff, IOSIZE);
!     p = shorten_fname((char_u *)fileBuf, IObuff);
!     if (p == NULL)
! 	p = (char_u *)fileBuf;
!     return vim_strsave(p);
  }
  # endif /* FEAT_MBYTE */
  
--- 3301,3307 ----
      SetFocus(s_hwnd);
  
      /* Shorten the file name if possible */
!     return vim_strsave(shorten_fname1((char_u *)fileBuf));
  }
  # endif /* FEAT_MBYTE */
  
***************
*** 3450,3460 ****
      SetFocus(s_hwnd);
  
      /* Shorten the file name if possible */
!     mch_dirname(IObuff, IOSIZE);
!     p = shorten_fname((char_u *)fileBuf, IObuff);
!     if (p == NULL)
! 	p = (char_u *)fileBuf;
!     return vim_strsave(p);
  }
  #endif /* FEAT_BROWSE */
  
--- 3446,3452 ----
      SetFocus(s_hwnd);
  
      /* Shorten the file name if possible */
!     return vim_strsave(shorten_fname1((char_u *)fileBuf));
  }
  #endif /* FEAT_BROWSE */
  
*** ../vim-7.1.125/src/proto/ex_docmd.pro	Sun May  6 14:46:22 2007
--- src/proto/ex_docmd.pro	Wed Sep 26 20:30:10 2007
***************
*** 39,44 ****
--- 39,45 ----
  void tabpage_new __ARGS((void));
  void do_exedit __ARGS((exarg_T *eap, win_T *old_curwin));
  void free_cd_dir __ARGS((void));
+ void ex_cd __ARGS((exarg_T *eap));
  void do_sleep __ARGS((long msec));
  int vim_mkdir_emsg __ARGS((char_u *name, int prot));
  FILE *open_exfile __ARGS((char_u *fname, int forceit, char *mode));
*** ../vim-7.1.125/src/proto/fileio.pro	Sat Sep 29 14:15:00 2007
--- src/proto/fileio.pro	Wed Sep 26 20:05:02 2007
***************
*** 6,11 ****
--- 6,12 ----
  int buf_write __ARGS((buf_T *buf, char_u *fname, char_u *sfname, linenr_T start, linenr_T end, exarg_T *eap, int append, int forceit, int reset_changed, int filtering));
  void msg_add_fname __ARGS((buf_T *buf, char_u *fname));
  void msg_add_lines __ARGS((int insert_space, long lnum, long nchars));
+ char_u *shorten_fname1 __ARGS((char_u *full_path));
  char_u *shorten_fname __ARGS((char_u *full_path, char_u *dir_name));
  void shorten_fnames __ARGS((int force));
  void shorten_filenames __ARGS((char_u **fnames, int count));
*** ../vim-7.1.125/src/quickfix.c	Sun Sep 16 13:26:56 2007
--- src/quickfix.c	Sun Sep 30 13:58:38 2007
***************
*** 2972,2977 ****
--- 2972,2978 ----
      regmmatch_T	regmatch;
      int		fcount;
      char_u	**fnames;
+     char_u	*fname;
      char_u	*s;
      char_u	*p;
      int		fi;
***************
*** 2995,3000 ****
--- 2996,3004 ----
      int		flags = 0;
      colnr_T	col;
      long	tomatch;
+     char_u	dirname_start[MAXPATHL];
+     char_u	dirname_now[MAXPATHL];
+     char_u	*target_dir = NULL;
  
      switch (eap->cmdidx)
      {
***************
*** 3069,3085 ****
  	goto theend;
      }
  
      seconds = (time_t)0;
      for (fi = 0; fi < fcount && !got_int && tomatch > 0; ++fi)
      {
  	if (time(NULL) > seconds)
  	{
! 	    /* Display the file name every second or so. */
  	    seconds = time(NULL);
  	    msg_start();
! 	    p = msg_strtrunc(fnames[fi], TRUE);
  	    if (p == NULL)
! 		msg_outtrans(fnames[fi]);
  	    else
  	    {
  		msg_outtrans(p);
--- 3073,3095 ----
  	goto theend;
      }
  
+     /* Remember the current directory, because a BufRead autocommand that does
+      * ":lcd %:p:h" changes the meaning of short path names. */
+     mch_dirname(dirname_start, MAXPATHL);
+ 
      seconds = (time_t)0;
      for (fi = 0; fi < fcount && !got_int && tomatch > 0; ++fi)
      {
+ 	fname = shorten_fname1(fnames[fi]);
  	if (time(NULL) > seconds)
  	{
! 	    /* Display the file name every second or so, show the user we are
! 	     * working on it. */
  	    seconds = time(NULL);
  	    msg_start();
! 	    p = msg_strtrunc(fname, TRUE);
  	    if (p == NULL)
! 		msg_outtrans(fname);
  	    else
  	    {
  		msg_outtrans(p);
***************
*** 3111,3117 ****
  
  	    /* Load file into a buffer, so that 'fileencoding' is detected,
  	     * autocommands applied, etc. */
! 	    buf = load_dummy_buffer(fnames[fi]);
  
  	    p_mls = save_mls;
  #if defined(FEAT_AUTOCMD) && defined(FEAT_SYN_HL)
--- 3121,3139 ----
  
  	    /* Load file into a buffer, so that 'fileencoding' is detected,
  	     * autocommands applied, etc. */
! 	    buf = load_dummy_buffer(fname);
! 
! 	    /* When autocommands changed directory: go back.  We assume it was
! 	     * ":lcd %:p:h". */
! 	    mch_dirname(dirname_now, MAXPATHL);
! 	    if (STRCMP(dirname_start, dirname_now) != 0)
! 	    {
! 		exarg_T ea;
! 
! 		ea.arg = dirname_start;
! 		ea.cmdidx = CMD_lcd;
! 		ex_cd(&ea);
! 	    }
  
  	    p_mls = save_mls;
  #if defined(FEAT_AUTOCMD) && defined(FEAT_SYN_HL)
***************
*** 3125,3131 ****
  	if (buf == NULL)
  	{
  	    if (!got_int)
! 		smsg((char_u *)_("Cannot open file \"%s\""), fnames[fi]);
  	}
  	else
  	{
--- 3147,3153 ----
  	if (buf == NULL)
  	{
  	    if (!got_int)
! 		smsg((char_u *)_("Cannot open file \"%s\""), fname);
  	}
  	else
  	{
***************
*** 3139,3147 ****
  		while (vim_regexec_multi(&regmatch, curwin, buf, lnum,
  								     col) > 0)
  		{
  		    if (qf_add_entry(qi, &prevp,
  				NULL,       /* dir */
! 				fnames[fi],
  				0,
  				ml_get_buf(buf,
  				     regmatch.startpos[0].lnum + lnum, FALSE),
--- 3161,3170 ----
  		while (vim_regexec_multi(&regmatch, curwin, buf, lnum,
  								     col) > 0)
  		{
+ 		    ;
  		    if (qf_add_entry(qi, &prevp,
  				NULL,       /* dir */
! 				fname,
  				0,
  				ml_get_buf(buf,
  				     regmatch.startpos[0].lnum + lnum, FALSE),
***************
*** 3209,3214 ****
--- 3232,3244 ----
  
  		if (buf != NULL)
  		{
+ 		    /* If the buffer is still loaded we need to use the
+ 		     * directory we jumped to below. */
+ 		    if (buf == first_match_buf
+ 			    && target_dir == NULL
+ 			    && STRCMP(dirname_start, dirname_now) != 0)
+ 			target_dir = vim_strsave(dirname_now);
+ 
  		    /* The buffer is still loaded, the Filetype autocommands
  		     * need to be done now, in that buffer.  And the modelines
  		     * need to be done (again).  But not the window-local
***************
*** 3252,3257 ****
--- 3282,3297 ----
  		/* If we jumped to another buffer redrawing will already be
  		 * taken care of. */
  		redraw_for_dummy = FALSE;
+ 
+ 	    /* Jump to the directory used after loading the buffer. */
+ 	    if (curbuf == first_match_buf && target_dir != NULL)
+ 	    {
+ 		exarg_T ea;
+ 
+ 		ea.arg = target_dir;
+ 		ea.cmdidx = CMD_lcd;
+ 		ex_cd(&ea);
+ 	    }
  	}
      }
      else
***************
*** 3269,3274 ****
--- 3309,3315 ----
      }
  
  theend:
+     vim_free(target_dir);
      vim_free(regmatch.regprog);
  }
  
*** ../vim-7.1.125/src/version.c	Sat Sep 29 14:15:00 2007
--- src/version.c	Sun Sep 30 13:41:30 2007
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     126,
  /**/

-- 
The MS-Windows registry is no more hostile than any other bunch of state
information... that is held in a binary format... a format that nobody
understands... and is replicated and cached in a complex and largely
undocumented way... and contains large amounts of duplicate and obfuscated
information...  (Ben Peterson)

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: About patch 7.1.127
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.127
Problem:    Memory leak when doing cmdline completion. (Dominique Pelle)
Solution:   Free "orig" argument of ExpandOne() when it's not used.
Files:	    src/ex_getln.c


*** ../vim-7.1.126/src/ex_getln.c	Sat Sep 29 14:15:00 2007
--- src/ex_getln.c	Sun Sep 30 17:55:47 2007
***************
*** 3316,3321 ****
--- 3316,3325 ----
   * Return a pointer to alloced memory containing the new string.
   * Return NULL for failure.
   *
+  * "orig" is the originally expanded string, copied to allocated memory.  It
+  * should either be kept in orig_save or freed.  When "mode" is WILD_NEXT or
+  * WILD_PREV "orig" should be NULL.
+  *
   * Results are cached in xp->xp_files and xp->xp_numfiles, except when "mode"
   * is WILD_EXPAND_FREE or WILD_ALL.
   *
***************
*** 3400,3406 ****
  	    return NULL;
      }
  
! /* free old names */
      if (xp->xp_numfiles != -1 && mode != WILD_ALL && mode != WILD_LONGEST)
      {
  	FreeWild(xp->xp_numfiles, xp->xp_files);
--- 3404,3410 ----
  	    return NULL;
      }
  
!     /* free old names */
      if (xp->xp_numfiles != -1 && mode != WILD_ALL && mode != WILD_LONGEST)
      {
  	FreeWild(xp->xp_numfiles, xp->xp_files);
***************
*** 3540,3545 ****
--- 3544,3553 ----
  
      if (mode == WILD_EXPAND_FREE || mode == WILD_ALL)
  	ExpandCleanup(xp);
+ 
+     /* Free "orig" if it wasn't stored in "orig_save". */
+     if (orig != orig_save)
+ 	vim_free(orig);
  
      return ss;
  }
*** ../vim-7.1.126/src/version.c	Sun Sep 30 14:00:41 2007
--- src/version.c	Sun Sep 30 14:20:14 2007
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     127,
  /**/

-- 
A M00se once bit my sister ...
                 "Monty Python and the Holy Grail" PYTHON (MONTY) PICTURES LTD

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: About patch 7.1.128 (extra)
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.128 (extra)
Problem:    Build problems with new version of Cygwin.
Solution:   Remove -D__IID_DEFINED__, like with MingW. (Guopeng Wen)
Files:	    src/Make_cyg.mak


*** ../vim-7.1.127/src/Make_cyg.mak	Sun Apr 30 20:46:49 2006
--- src/Make_cyg.mak	Sat Sep 29 13:09:34 2007
***************
*** 1,6 ****
  #
  # Makefile for VIM on Win32, using Cygnus gcc
! # Last updated by Dan Sharp.  Last Change: 2006 Apr 30
  #
  # Also read INSTALLpc.txt!
  #
--- 1,6 ----
  #
  # Makefile for VIM on Win32, using Cygnus gcc
! # Last updated by Dan Sharp.  Last Change: 2007 Sep 29
  #
  # Also read INSTALLpc.txt!
  #
***************
*** 503,509 ****
  	$(CC) -c $(CFLAGS) if_cscope.c -o $(OUTDIR)/if_cscope.o
  
  $(OUTDIR)/if_ole.o:	if_ole.cpp $(INCL)
! 	$(CC) -c $(CFLAGS) -D__IID_DEFINED__ if_ole.cpp -o $(OUTDIR)/if_ole.o
  
  if_perl.c: if_perl.xs typemap
  	$(PERL)/bin/perl `cygpath -d $(PERL)/lib/ExtUtils/xsubpp` \
--- 503,509 ----
  	$(CC) -c $(CFLAGS) if_cscope.c -o $(OUTDIR)/if_cscope.o
  
  $(OUTDIR)/if_ole.o:	if_ole.cpp $(INCL)
! 	$(CC) -c $(CFLAGS) if_ole.cpp -o $(OUTDIR)/if_ole.o
  
  if_perl.c: if_perl.xs typemap
  	$(PERL)/bin/perl `cygpath -d $(PERL)/lib/ExtUtils/xsubpp` \
*** ../vim-7.1.127/src/version.c	Sun Sep 30 22:10:45 2007
--- src/version.c	Sun Sep 30 22:27:51 2007
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     128,
  /**/

-- 
Mynd you, m00se bites Kan be pretty nasti ...
                 "Monty Python and the Holy Grail" PYTHON (MONTY) PICTURES LTD

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: About patch 7.1.129 (extra)
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.129 (extra)
Problem:    Win32: Can't get the user name when it is longer than 15
	    characters.
Solution:   Use UNLEN instead of MAX_COMPUTERNAME_LENGTH. (Alexei Alexandrov)
Files:	    src/os_win32.c


*** ../vim-7.1.128/src/os_win32.c	Thu May 10 19:22:59 2007
--- src/os_win32.c	Mon Oct  1 20:07:24 2007
***************
*** 2378,2384 ****
      char_u  *s,
      int	    len)
  {
!     char szUserName[MAX_COMPUTERNAME_LENGTH + 1];
      DWORD cch = sizeof szUserName;
  
      if (GetUserName(szUserName, &cch))
--- 2378,2384 ----
      char_u  *s,
      int	    len)
  {
!     char szUserName[256 + 1];	/* UNLEN is 256 */
      DWORD cch = sizeof szUserName;
  
      if (GetUserName(szUserName, &cch))
*** ../vim-7.1.128/src/version.c	Sun Sep 30 22:28:08 2007
--- src/version.c	Mon Oct  1 20:32:52 2007
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     129,
  /**/

-- 
ARTHUR: It is I, Arthur, son of Uther Pendragon, from the castle of Camelot.
        King of all Britons, defeator of the Saxons, sovereign of all England!
   [Pause]
SOLDIER: Get away!
                 "Monty Python and the Holy Grail" PYTHON (MONTY) PICTURES LTD

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: About patch 7.1.130
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.130
Problem:    Crash with specific order of undo and redo. (A.Politz)
Solution:   Clear and adjust pointers properly.  Add u_check() for debugging.
Files:	    src/undo.c, src/structs.h


*** ../vim-7.1.129/src/undo.c	Thu May 10 20:01:43 2007
--- src/undo.c	Mon Oct  1 22:49:16 2007
***************
*** 76,81 ****
--- 76,87 ----
   * buffer is unloaded.
   */
  
+ /* Uncomment the next line for including the u_check() function.  This warns
+  * for errors in the debug information. */
+ /* #define U_DEBUG 1 */
+ #define UH_MAGIC 0x18dade	/* value for uh_magic when in use */
+ #define UE_MAGIC 0xabc123	/* value for ue_magic when in use */
+ 
  #include "vim.h"
  
  /* See below: use malloc()/free() for memory management. */
***************
*** 113,118 ****
--- 119,213 ----
   */
  static int	undo_undoes = FALSE;
  
+ #ifdef U_DEBUG
+ /*
+  * Check the undo structures for being valid.  Print a warning when something
+  * looks wrong.
+  */
+ static int seen_b_u_curhead;
+ static int seen_b_u_newhead;
+ static int header_count;
+ 
+     static void
+ u_check_tree(u_header_T *uhp,
+ 	u_header_T *exp_uh_next,
+ 	u_header_T *exp_uh_alt_prev)
+ {
+     u_entry_T *uep;
+ 
+     if (uhp == NULL)
+ 	return;
+     ++header_count;
+     if (uhp == curbuf->b_u_curhead && ++seen_b_u_curhead > 1)
+     {
+ 	EMSG("b_u_curhead found twice (looping?)");
+ 	return;
+     }
+     if (uhp == curbuf->b_u_newhead && ++seen_b_u_newhead > 1)
+     {
+ 	EMSG("b_u_newhead found twice (looping?)");
+ 	return;
+     }
+ 
+     if (uhp->uh_magic != UH_MAGIC)
+ 	EMSG("uh_magic wrong (may be using freed memory)");
+     else
+     {
+ 	/* Check pointers back are correct. */
+ 	if (uhp->uh_next != exp_uh_next)
+ 	{
+ 	    EMSG("uh_next wrong");
+ 	    smsg((char_u *)"expected: 0x%x, actual: 0x%x",
+ 						   exp_uh_next, uhp->uh_next);
+ 	}
+ 	if (uhp->uh_alt_prev != exp_uh_alt_prev)
+ 	{
+ 	    EMSG("uh_alt_prev wrong");
+ 	    smsg((char_u *)"expected: 0x%x, actual: 0x%x",
+ 					   exp_uh_alt_prev, uhp->uh_alt_prev);
+ 	}
+ 
+ 	/* Check the undo tree at this header. */
+ 	for (uep = uhp->uh_entry; uep != NULL; uep = uep->ue_next)
+ 	{
+ 	    if (uep->ue_magic != UE_MAGIC)
+ 	    {
+ 		EMSG("ue_magic wrong (may be using freed memory)");
+ 		break;
+ 	    }
+ 	}
+ 
+ 	/* Check the next alt tree. */
+ 	u_check_tree(uhp->uh_alt_next, uhp->uh_next, uhp);
+ 
+ 	/* Check the next header in this branch. */
+ 	u_check_tree(uhp->uh_prev, uhp, NULL);
+     }
+ }
+ 
+     void
+ u_check(int newhead_may_be_NULL)
+ {
+     seen_b_u_newhead = 0;
+     seen_b_u_curhead = 0;
+     header_count = 0;
+ 
+     u_check_tree(curbuf->b_u_oldhead, NULL, NULL);
+ 
+     if (seen_b_u_newhead == 0 && curbuf->b_u_oldhead != NULL
+ 	    && !(newhead_may_be_NULL && curbuf->b_u_newhead == NULL))
+ 	EMSGN("b_u_newhead invalid: 0x%x", curbuf->b_u_newhead);
+     if (curbuf->b_u_curhead != NULL && seen_b_u_curhead == 0)
+ 	EMSGN("b_u_curhead invalid: 0x%x", curbuf->b_u_curhead);
+     if (header_count != curbuf->b_u_numhead)
+     {
+ 	EMSG("b_u_numhead invalid");
+ 	smsg((char_u *)"expected: %ld, actual: %ld",
+ 			       (long)header_count, (long)curbuf->b_u_numhead);
+     }
+ }
+ #endif
+ 
  /*
   * Save the current line for both the "u" and "U" command.
   * Returns OK or FAIL.
***************
*** 243,248 ****
--- 338,346 ----
      if (!undo_allowed())
  	return FAIL;
  
+ #ifdef U_DEBUG
+     u_check(FALSE);
+ #endif
  #ifdef FEAT_NETBEANS_INTG
      /*
       * Netbeans defines areas that cannot be modified.  Bail out here when
***************
*** 294,299 ****
--- 392,400 ----
  	    uhp = (u_header_T *)U_ALLOC_LINE((unsigned)sizeof(u_header_T));
  	    if (uhp == NULL)
  		goto nomem;
+ #ifdef U_DEBUG
+ 	    uhp->uh_magic = UH_MAGIC;
+ #endif
  	}
  	else
  	    uhp = NULL;
***************
*** 316,323 ****
  	{
  	    u_header_T	    *uhfree = curbuf->b_u_oldhead;
  
! 	    /* If there is no branch only free one header. */
! 	    if (uhfree->uh_alt_next == NULL)
  		u_freeheader(curbuf, uhfree, &old_curhead);
  	    else
  	    {
--- 417,427 ----
  	{
  	    u_header_T	    *uhfree = curbuf->b_u_oldhead;
  
! 	    if (uhfree == old_curhead)
! 		/* Can't reconnect the branch, delete all of it. */
! 		u_freebranch(curbuf, uhfree, &old_curhead);
! 	    else if (uhfree->uh_alt_next == NULL)
! 		/* There is no branch, only free one header. */
  		u_freeheader(curbuf, uhfree, &old_curhead);
  	    else
  	    {
***************
*** 326,331 ****
--- 430,438 ----
  		    uhfree = uhfree->uh_alt_next;
  		u_freebranch(curbuf, uhfree, &old_curhead);
  	    }
+ #ifdef U_DEBUG
+ 	    u_check(TRUE);
+ #endif
  	}
  
  	if (uhp == NULL)		/* no undo at all */
***************
*** 478,483 ****
--- 585,593 ----
      uep = (u_entry_T *)U_ALLOC_LINE((unsigned)sizeof(u_entry_T));
      if (uep == NULL)
  	goto nomem;
+ #ifdef U_DEBUG
+     uep->ue_magic = UE_MAGIC;
+ #endif
  
      uep->ue_size = size;
      uep->ue_top = top;
***************
*** 525,530 ****
--- 635,643 ----
      curbuf->b_u_synced = FALSE;
      undo_undoes = FALSE;
  
+ #ifdef U_DEBUG
+     u_check(FALSE);
+ #endif
      return OK;
  
  nomem:
***************
*** 955,960 ****
--- 1068,1076 ----
      int		empty_buffer;		    /* buffer became empty */
      u_header_T	*curhead = curbuf->b_u_curhead;
  
+ #ifdef U_DEBUG
+     u_check(FALSE);
+ #endif
      old_flags = curhead->uh_flags;
      new_flags = (curbuf->b_changed ? UH_CHANGED : 0) +
  	       ((curbuf->b_ml.ml_flags & ML_EMPTY) ? UH_EMPTYBUF : 0);
***************
*** 1186,1191 ****
--- 1302,1310 ----
      /* The timestamp can be the same for multiple changes, just use the one of
       * the undone/redone change. */
      curbuf->b_u_seq_time = curhead->uh_time;
+ #ifdef U_DEBUG
+     u_check(FALSE);
+ #endif
  }
  
  /*
***************
*** 1515,1521 ****
  }
  
  /*
!  * Free one header and its entry list and adjust the pointers.
   */
      static void
  u_freeheader(buf, uhp, uhpp)
--- 1634,1640 ----
  }
  
  /*
!  * Free one header "uhp" and its entry list and adjust the pointers.
   */
      static void
  u_freeheader(buf, uhp, uhpp)
***************
*** 1523,1528 ****
--- 1642,1649 ----
      u_header_T	    *uhp;
      u_header_T	    **uhpp;	/* if not NULL reset when freeing this header */
  {
+     u_header_T	    *uhap;
+ 
      /* When there is an alternate redo list free that branch completely,
       * because we can never go there. */
      if (uhp->uh_alt_next != NULL)
***************
*** 1540,1546 ****
      if (uhp->uh_prev == NULL)
  	buf->b_u_newhead = uhp->uh_next;
      else
! 	uhp->uh_prev->uh_next = uhp->uh_next;
  
      u_freeentries(buf, uhp, uhpp);
  }
--- 1661,1668 ----
      if (uhp->uh_prev == NULL)
  	buf->b_u_newhead = uhp->uh_next;
      else
! 	for (uhap = uhp->uh_prev; uhap != NULL; uhap = uhap->uh_alt_next)
! 	    uhap->uh_next = uhp->uh_next;
  
      u_freeentries(buf, uhp, uhpp);
  }
***************
*** 1585,1590 ****
--- 1707,1714 ----
      /* Check for pointers to the header that become invalid now. */
      if (buf->b_u_curhead == uhp)
  	buf->b_u_curhead = NULL;
+     if (buf->b_u_newhead == uhp)
+ 	buf->b_u_newhead = NULL;  /* freeing the newest entry */
      if (uhpp != NULL && uhp == *uhpp)
  	*uhpp = NULL;
  
***************
*** 1594,1599 ****
--- 1718,1726 ----
  	u_freeentry(uep, uep->ue_size);
      }
  
+ #ifdef U_DEBUG
+     uhp->uh_magic = 0;
+ #endif
      U_FREE_LINE((char_u *)uhp);
      --buf->b_u_numhead;
  }
***************
*** 1609,1614 ****
--- 1736,1744 ----
      while (n > 0)
  	U_FREE_LINE(uep->ue_array[--n]);
      U_FREE_LINE((char_u *)uep->ue_array);
+ #ifdef U_DEBUG
+     uep->ue_magic = 0;
+ #endif
      U_FREE_LINE((char_u *)uep);
  }
  
*** ../vim-7.1.129/src/structs.h	Sun Aug 12 15:50:26 2007
--- src/structs.h	Sat Sep 29 15:03:38 2007
***************
*** 278,283 ****
--- 278,286 ----
      linenr_T	ue_lcount;	/* linecount when u_save called */
      char_u	**ue_array;	/* array of lines in undo block */
      long	ue_size;	/* number of lines in ue_array */
+ #ifdef U_DEBUG
+     int		ue_magic;	/* magic number to check allocation */
+ #endif
  };
  
  struct u_header
***************
*** 300,305 ****
--- 303,311 ----
      visualinfo_T uh_visual;	/* Visual areas before undo/after redo */
  #endif
      time_t	uh_time;	/* timestamp when the change was made */
+ #ifdef U_DEBUG
+     int		uh_magic;	/* magic number to check allocation */
+ #endif
  };
  
  /* values for uh_flags */
*** ../vim-7.1.129/src/version.c	Mon Oct  1 20:33:45 2007
--- src/version.c	Mon Oct  1 22:50:23 2007
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     130,
  /**/

-- 
FIRST SOLDIER:  So they wouldn't be able to bring a coconut back anyway.
SECOND SOLDIER: Wait a minute! Suppose two swallows carried it together?
FIRST SOLDIER:  No, they'd have to have it on a line.
                 "Monty Python and the Holy Grail" PYTHON (MONTY) PICTURES LTD

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: patch 7.1.131
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.131
Problem:    ":mksession" always adds ":setlocal autoread". (Christian J.
	    Robinson)
Solution:   Skip boolean global/local option using global value.
Files:	    src/option.c


*** ../vim-7.1.130/src/option.c	Wed Sep 26 22:35:06 2007
--- src/option.c	Sun Sep 30 16:21:08 2007
***************
*** 8753,8758 ****
--- 8753,8760 ----
      char	*name;
      int		value;
  {
+     if (value < 0)	/* global/local option using global value */
+ 	return OK;
      if (fprintf(fd, "%s %s%s", cmd, value ? "" : "no", name) < 0
  	    || put_eol(fd) < 0)
  	return FAIL;
*** ../vim-7.1.130/src/version.c	Mon Oct  1 22:53:27 2007
--- src/version.c	Tue Oct  2 20:39:02 2007
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     131,
  /**/

-- 
ARTHUR: Old woman!
DENNIS: Man!
ARTHUR: Man.  I'm sorry.  Old man, What knight live in that castle over there?
DENNIS: I'm thirty-seven.
                 "Monty Python and the Holy Grail" PYTHON (MONTY) PICTURES LTD

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: patch 7.1.132
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.132
Problem:    getpos("'>") may return a negative column number for a Linewise
	    selection. (A.Politz)
Solution:   Don't add one to MAXCOL.
Files:	    src/eval.c


*** ../vim-7.1.131/src/eval.c	Tue Sep 25 20:39:14 2007
--- src/eval.c	Mon Oct  1 20:56:09 2007
***************
*** 10388,10394 ****
  	    list_append_number(l, (varnumber_T)0);
  	list_append_number(l, (fp != NULL) ? (varnumber_T)fp->lnum
  							    : (varnumber_T)0);
! 	list_append_number(l, (fp != NULL) ? (varnumber_T)fp->col + 1
  							    : (varnumber_T)0);
  	list_append_number(l,
  #ifdef FEAT_VIRTUALEDIT
--- 10388,10395 ----
  	    list_append_number(l, (varnumber_T)0);
  	list_append_number(l, (fp != NULL) ? (varnumber_T)fp->lnum
  							    : (varnumber_T)0);
! 	list_append_number(l, (fp != NULL)
! 		     ? (varnumber_T)(fp->col == MAXCOL ? MAXCOL : fp->col + 1)
  							    : (varnumber_T)0);
  	list_append_number(l,
  #ifdef FEAT_VIRTUALEDIT
*** ../vim-7.1.131/src/version.c	Tue Oct  2 20:40:01 2007
--- src/version.c	Tue Oct  2 22:07:17 2007
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     132,
  /**/

-- 
"The future's already arrived - it's just not evenly distributed yet."
		-- William Gibson

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: patch 7.1.133
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.133 (after 7.1.126)
Problem:    shorten_fname1() linked when it's not needed.
Solution:   Add #ifdef.
Files:	    src/fileio.c


*** ../vim-7.1.132/src/fileio.c	Sun Sep 30 14:00:41 2007
--- src/fileio.c	Sun Sep 30 16:32:43 2007
***************
*** 5553,5558 ****
--- 5554,5561 ----
  }
  #endif
  
+ #if defined(FEAT_VIMINFO) || defined(FEAT_BROWSE) || \
+     defined(FEAT_QUICKFIX) || defined(PROTO)
  /*
   * Try to find a shortname by comparing the fullname with the current
   * directory.
***************
*** 5573,5578 ****
--- 5576,5582 ----
      }
      return p;
  }
+ #endif
  
  /*
   * Try to find a shortname by comparing the fullname with the current
*** ../vim-7.1.132/src/version.c	Tue Oct  2 22:07:58 2007
--- src/version.c	Wed Oct  3 12:46:59 2007
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     133,
  /**/

-- 
"Beware of bugs in the above code; I have only proved
it correct, not tried it." -- Donald Knuth

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: patch 7.1.134 (extra)
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.134 (extra)
Problem:    Win32: Can't build with VC8
Solution:   Detect the MSVC version instead of using NMAKE_VER.
            (Mike Williams)
Files:      src/Make_mvc.mak


*** ../vim-7.1.133/src/Make_mvc.mak	Tue Feb 20 03:15:08 2007
--- src/Make_mvc.mak	Mon Oct  1 21:37:20 2007
***************
*** 92,97 ****
--- 92,99 ----
  #       Netbeans Debugging Support: NBDEBUG=[yes or no] (should be no, yes
  #       doesn't work)
  #
+ #       Visual C Version: MSVCVER=m.n (default derived from nmake if undefined)
+ #
  # You can combine any of these interfaces
  #
  # Example: To build the non-debug, GUI version with Perl interface:
***************
*** 101,107 ****
  #	This makefile gives a fineness of control which is not supported in
  #	Visual C++ configuration files.  Therefore, debugging requires a bit of
  #	extra work.
! #	Make_dvc.mak is a Visual C++ project to access that support.
  #	To use Make_dvc.mak:
  #	1) Build Vim with Make_mvc.mak.
  #	     Use a "DEBUG=yes" argument to build Vim with debug support.
--- 103,110 ----
  #	This makefile gives a fineness of control which is not supported in
  #	Visual C++ configuration files.  Therefore, debugging requires a bit of
  #	extra work.
! #	Make_dvc.mak is a Visual C++ project to access that support.  It may be
! #	badly out of date for the Visual C++ you are using...
  #	To use Make_dvc.mak:
  #	1) Build Vim with Make_mvc.mak.
  #	     Use a "DEBUG=yes" argument to build Vim with debug support.
***************
*** 198,211 ****
  !if "$(DEBUG)" != "yes"
  NODEBUG = 1
  !else
  MAKEFLAGS_GVIMEXT = DEBUG=yes
  !endif
  
  
! # Get all sorts of useful, standard macros from the SDK.  (Note that
! # MSVC 2.2 does not install <ntwin32.mak> in the \msvc20\include
! # directory, but you can find it in \msvc20\include on the CD-ROM.
! # You may also need <win32.mak> from the same place.)
  
  !include <Win32.mak>
  
--- 201,212 ----
  !if "$(DEBUG)" != "yes"
  NODEBUG = 1
  !else
+ !undef NODEBUG
  MAKEFLAGS_GVIMEXT = DEBUG=yes
  !endif
  
  
! # Get all sorts of useful, standard macros from the Platform SDK.
  
  !include <Win32.mak>
  
***************
*** 272,283 ****
  
  # Set which version of the CRT to use
  !if defined(USE_MSVCRT)
! CVARS = $(cvarsdll)
  # !elseif defined(MULTITHREADED)
  # CVARS = $(cvarsmt)
  !else
  # CVARS = $(cvars)
! CVARS = $(cvarsmt)
  !endif
  
  # need advapi32.lib for GetUserName()
--- 273,284 ----
  
  # Set which version of the CRT to use
  !if defined(USE_MSVCRT)
! # CVARS = $(cvarsdll)
  # !elseif defined(MULTITHREADED)
  # CVARS = $(cvarsmt)
  !else
  # CVARS = $(cvars)
! # CVARS = $(cvarsmt)
  !endif
  
  # need advapi32.lib for GetUserName()
***************
*** 320,326 ****
--- 321,364 ----
  INTDIR=$(OBJDIR)
  OUTDIR=$(OBJDIR)
  
+ # Derive version of VC being used from nmake if not specified
+ !if "$(MSVCVER)" == ""
+ !if "$(_NMAKE_VER)" == ""
+ MSVCVER = 4.0
+ !endif
+ !if "$(_NMAKE_VER)" == "162"
+ MSVCVER = 5.0
+ !endif
+ !if "$(_NMAKE_VER)" == "6.00.8168.0"
+ MSVCVER = 6.0
+ !endif
+ !if "$(_NMAKE_VER)" == "7.00.9466"
+ MSVCVER = 7.0
+ !endif
+ !if "$(_NMAKE_VER)" == "7.10.3077"
+ MSVCVER = 7.1
+ !endif
+ !if "$(_NMAKE_VER)" == "8.00.50727.42"
+ MSVCVER = 8.0
+ !endif
+ !if "$(_NMAKE_VER)" == "8.00.50727.762"
+ MSVCVER = 8.0
+ !endif
+ !endif
+ 
+ # Abort bulding VIM if version of VC is unrecognised.
+ !ifndef MSVCVER
+ !message *** ERROR
+ !message Cannot determine Visual C version being used.  If you are using the
+ !message Windows SDK then you must have the environment variable MSVCVER set to
+ !message your version of the VC compiler.  If you are not using the Express
+ !message version of Visual C you van either set MSVCVER or update this makefile
+ !message to handle the new value for _NMAKE_VER.
+ !error Make aborted.
+ !endif
+ 
  # Convert processor ID to MVC-compatible number
+ !if "$(MSVCVER)" != "8.0"
  !if "$(CPUNR)" == "i386"
  CPUARG = /G3
  !elseif "$(CPUNR)" == "i486"
***************
*** 334,339 ****
--- 372,386 ----
  !else
  CPUARG =
  !endif
+ !else
+ # VC8 only allows specifying SSE architecture
+ !if "$(CPUNR)" == "pentium4"
+ CPUARG = /arch:SSE2
+ !endif
+ !endif
+ 
+ LIBC =
+ DEBUGINFO = /Zi
  
  !ifdef NODEBUG
  VIM = vim
***************
*** 344,384 ****
  !else # MAXSPEED
  OPTFLAG = /Ox
  !endif
  CFLAGS = $(CFLAGS) $(OPTFLAG) -DNDEBUG $(CPUARG)
  RCFLAGS = $(rcflags) $(rcvars) -DNDEBUG
  ! ifdef USE_MSVCRT
! CFLAGS = $(CFLAGS) -MD
  LIBC = msvcrt.lib
- # CFLAGS = $(CFLAGS) $(cvarsdll)
- # ! elseif defined(MULTITHREADED)
- # LIBC = libcmt.lib
- # CFLAGS = $(CFLAGS) $(cvarsmt)
  ! else
- # LIBC = libc.lib
  LIBC = libcmt.lib
! # CFLAGS = $(CFLAGS) $(cvars)
  ! endif
  !else  # DEBUG
  VIM = vimd
  CFLAGS = $(CFLAGS) -D_DEBUG -DDEBUG /Od
  RCFLAGS = $(rcflags) $(rcvars) -D_DEBUG -DDEBUG
  # The /fixed:no is needed for Quantify. Assume not 4.? as unsupported in VC4.0.
! ! if "$(_NMAKE_VER)" == ""
  LIBC =
  ! else
  LIBC = /fixed:no
  ! endif
  ! ifdef USE_MSVCRT
! CFLAGS = $(CFLAGS) -MDd
  LIBC = $(LIBC) msvcrtd.lib
- # CFLAGS = $(CFLAGS) $(cvarsdll)
- # ! elseif defined(MULTITHREADED)
- # LIBC = $(LIBC) libcmtd.lib
- # CFLAGS = $(CFLAGS) $(cvarsmt)
  ! else
- # LIBC = $(LIBC) libcd.lib
  LIBC = $(LIBC) libcmtd.lib
! # CFLAGS = $(CFLAGS) $(cvars)
  ! endif
  !endif # DEBUG
  
--- 391,430 ----
  !else # MAXSPEED
  OPTFLAG = /Ox
  !endif
+ !if "$(MSVCVER)" == "8.0"
+ # Use link time code generation if not worried about size
+ !if "$(OPTIMIZE)" != "SPACE"
+ OPTFLAG = $(OPTFLAG) /GL
+ !endif
+ !endif
  CFLAGS = $(CFLAGS) $(OPTFLAG) -DNDEBUG $(CPUARG)
  RCFLAGS = $(rcflags) $(rcvars) -DNDEBUG
  ! ifdef USE_MSVCRT
! CFLAGS = $(CFLAGS) /MD
  LIBC = msvcrt.lib
  ! else
  LIBC = libcmt.lib
! CFLAGS = $(CFLAGS) /MT
  ! endif
  !else  # DEBUG
  VIM = vimd
+ ! if "$(CPU)" == "i386"
+ DEBUGINFO = /ZI
+ ! endif
  CFLAGS = $(CFLAGS) -D_DEBUG -DDEBUG /Od
  RCFLAGS = $(rcflags) $(rcvars) -D_DEBUG -DDEBUG
  # The /fixed:no is needed for Quantify. Assume not 4.? as unsupported in VC4.0.
! ! if "$(MSVCVER)" == "4.0"
  LIBC =
  ! else
  LIBC = /fixed:no
  ! endif
  ! ifdef USE_MSVCRT
! CFLAGS = $(CFLAGS) /MDd
  LIBC = $(LIBC) msvcrtd.lib
  ! else
  LIBC = $(LIBC) libcmtd.lib
! CFLAGS = $(CFLAGS) /MTd
  ! endif
  !endif # DEBUG
  
***************
*** 681,696 ****
  #
  # Always generate the .pdb file, so that we get debug symbols that can be used
  # on a crash (doesn't add overhead to the executable).
  #
! CFLAGS = $(CFLAGS) /Zi /Fd$(OUTDIR)/
! LINK_PDB = /PDB:$(VIM).pdb -debug # -debug:full -debugtype:cv,fixup
  
  #
  # End extra feature include
  #
  !message
  
! conflags = /nologo /subsystem:$(SUBSYSTEM) /incremental:no
  
  PATHDEF_SRC = $(OUTDIR)\pathdef.c
  
--- 727,744 ----
  #
  # Always generate the .pdb file, so that we get debug symbols that can be used
  # on a crash (doesn't add overhead to the executable).
+ # Generate edit-and-continue debug info when no optimization - allows to
+ # debug more conveniently (able to look at variables which are in registers)
  #
! CFLAGS = $(CFLAGS) /Fd$(OUTDIR)/ $(DEBUGINFO)
! LINK_PDB = /PDB:$(VIM).pdb -debug
  
  #
  # End extra feature include
  #
  !message
  
! conflags = /nologo /subsystem:$(SUBSYSTEM)
  
  PATHDEF_SRC = $(OUTDIR)\pathdef.c
  
***************
*** 702,712 ****
  conflags = $(conflags) /map /mapinfo:lines
  !ENDIF
  
! LINKARGS1 = $(linkdebug) $(conflags) /nodefaultlib:libc
  LINKARGS2 = $(CON_LIB) $(GUI_LIB) $(LIBC) $(OLE_LIB)  user32.lib $(SNIFF_LIB) \
  		$(MZSCHEME_LIB) $(PERL_LIB) $(PYTHON_LIB) $(RUBY_LIB) \
  		$(TCL_LIB) $(NETBEANS_LIB) $(XPM_LIB) $(LINK_PDB)
  
  all:	$(VIM).exe vimrun.exe install.exe uninstal.exe xxd/xxd.exe \
  		GvimExt/gvimext.dll
  
--- 750,769 ----
  conflags = $(conflags) /map /mapinfo:lines
  !ENDIF
  
! LINKARGS1 = $(linkdebug) $(conflags)
  LINKARGS2 = $(CON_LIB) $(GUI_LIB) $(LIBC) $(OLE_LIB)  user32.lib $(SNIFF_LIB) \
  		$(MZSCHEME_LIB) $(PERL_LIB) $(PYTHON_LIB) $(RUBY_LIB) \
  		$(TCL_LIB) $(NETBEANS_LIB) $(XPM_LIB) $(LINK_PDB)
  
+ # Report link time code generation progress if used. 
+ !ifdef NODEBUG
+ !if "$(MSVCVER)" == "8.0"
+ !if "$(OPTIMIZE)" != "SPACE"
+ LINKARGS1 = $(LINKARGS1) /LTCG:STATUS
+ !endif
+ !endif
+ !endif
+ 
  all:	$(VIM).exe vimrun.exe install.exe uninstal.exe xxd/xxd.exe \
  		GvimExt/gvimext.dll
  
***************
*** 794,800 ****
  
  # Create a default rule for transforming .c files to .obj files in $(OUTDIR)
  # Batch compilation is supported by nmake 1.62 (part of VS 5.0) and later)
! !IF "$(_NMAKE_VER)" == ""
  .c{$(OUTDIR)/}.obj:
  !ELSE
  .c{$(OUTDIR)/}.obj::
--- 851,857 ----
  
  # Create a default rule for transforming .c files to .obj files in $(OUTDIR)
  # Batch compilation is supported by nmake 1.62 (part of VS 5.0) and later)
! !IF "$(MSVCVER)" == "4.0"
  .c{$(OUTDIR)/}.obj:
  !ELSE
  .c{$(OUTDIR)/}.obj::
***************
*** 803,809 ****
  
  # Create a default rule for transforming .cpp files to .obj files in $(OUTDIR)
  # Batch compilation is supported by nmake 1.62 (part of VS 5.0) and later)
! !IF "$(_NMAKE_VER)" == ""
  .cpp{$(OUTDIR)/}.obj:
  !ELSE
  .cpp{$(OUTDIR)/}.obj::
--- 860,866 ----
  
  # Create a default rule for transforming .cpp files to .obj files in $(OUTDIR)
  # Batch compilation is supported by nmake 1.62 (part of VS 5.0) and later)
! !IF "$(MSVCVER)" == "4.0"
  .cpp{$(OUTDIR)/}.obj:
  !ELSE
  .cpp{$(OUTDIR)/}.obj::
*** ../vim-7.1.133/src/version.c	Wed Oct  3 12:49:24 2007
--- src/version.c	Wed Oct  3 13:23:51 2007
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     134,
  /**/

-- 
BLACK KNIGHT: The Black Knight always triumphs. Have at you!
   ARTHUR takes his last leg off.  The BLACK KNIGHT's body lands upright.
BLACK KNIGHT: All right, we'll call it a draw.
                 "Monty Python and the Holy Grail" PYTHON (MONTY) PICTURES LTD

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: patch 7.1.135
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.135
Problem:    Win32: When editing a file c:\tmp\foo and c:\tmp\\foo we have two
	    buffers for the same file. (Suresh Govindachar)
Solution:   Invoke FullName_save() when a path contains "//" or "\\".
Files:	    src/buffer.c


*** ../vim-7.1.134/src/buffer.c	Sun Sep 30 14:00:41 2007
--- src/buffer.c	Wed Oct  3 14:24:52 2007
***************
*** 4175,4203 ****
       * mess up the full path name, even though it starts with a '/'.
       * Also expand when there is ".." in the file name, try to remove it,
       * because "c:/src/../README" is equal to "c:/README".
       * For MS-Windows also expand names like "longna~1" to "longname".
       */
  #ifdef UNIX
      return FullName_save(fname, TRUE);
  #else
!     if (!vim_isAbsName(fname) || strstr((char *)fname, "..") != NULL
! #if defined(MSWIN) || defined(DJGPP)
  	    || vim_strchr(fname, '~') != NULL
! #endif
  	    )
  	return FullName_save(fname, FALSE);
  
      fname = vim_strsave(fname);
  
! #ifdef USE_FNAME_CASE
! # ifdef USE_LONG_FNAME
      if (USE_LONG_FNAME)
! # endif
      {
  	if (fname != NULL)
  	    fname_case(fname, 0);	/* set correct case for file name */
      }
! #endif
  
      return fname;
  #endif
--- 4175,4209 ----
       * mess up the full path name, even though it starts with a '/'.
       * Also expand when there is ".." in the file name, try to remove it,
       * because "c:/src/../README" is equal to "c:/README".
+      * Similarly "c:/src//file" is equal to "c:/src/file".
       * For MS-Windows also expand names like "longna~1" to "longname".
       */
  #ifdef UNIX
      return FullName_save(fname, TRUE);
  #else
!     if (!vim_isAbsName(fname)
! 	    || strstr((char *)fname, "..") != NULL
! 	    || strstr((char *)fname, "//") != NULL
! # ifdef BACKSLASH_IN_FILENAME
! 	    || strstr((char *)fname, "\\\\") != NULL
! # endif
! # if defined(MSWIN) || defined(DJGPP)
  	    || vim_strchr(fname, '~') != NULL
! # endif
  	    )
  	return FullName_save(fname, FALSE);
  
      fname = vim_strsave(fname);
  
! # ifdef USE_FNAME_CASE
! #  ifdef USE_LONG_FNAME
      if (USE_LONG_FNAME)
! #  endif
      {
  	if (fname != NULL)
  	    fname_case(fname, 0);	/* set correct case for file name */
      }
! # endif
  
      return fname;
  #endif
*** ../vim-7.1.134/src/version.c	Wed Oct  3 13:28:40 2007
--- src/version.c	Wed Oct  3 14:26:54 2007
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     135,
  /**/

-- 
   A village.  Sound of chanting of Latin canon, punctuated by short, sharp
   cracks.  It comes nearer.  We see it is a line of MONKS ala SEVENTH SEAL
   flagellation scene, chanting and banging themselves on the foreheads with
   wooden boards.
                 "Monty Python and the Holy Grail" PYTHON (MONTY) PICTURES LTD

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: Patch 7.1.136
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.136
Problem:    Memory leak when using Ruby syntax highlighting. (Dominique Pelle)
Solution:   Free the contained-in list.
Files:	    src/syntax.c


*** ../vim-7.1.135/src/syntax.c	Thu Aug 30 19:36:52 2007
--- src/syntax.c	Sun Oct  7 15:10:54 2007
***************
*** 3354,3359 ****
--- 3354,3360 ----
      {
  	vim_free(SYN_ITEMS(buf)[i].sp_cont_list);
  	vim_free(SYN_ITEMS(buf)[i].sp_next_list);
+ 	vim_free(SYN_ITEMS(buf)[i].sp_syn.cont_in_list);
      }
  }
  
*** ../vim-7.1.135/src/version.c	Wed Oct  3 14:30:54 2007
--- src/version.c	Sun Oct  7 15:20:22 2007
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     136,
  /**/

-- 
Every engineer dreams about saving the universe and having sex with aliens.
This is much more glamorous than the real life of an engineer, which consists
of hiding from the universe and having sex without the participation of other
life forms.                     (Scott Adams - The Dilbert principle)

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: Patch 7.1.137
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.137
Problem:    Build failure when using EXITFREE. (Dominique Pelle)
Solution:   Add an #ifdef around using clip_exclude_prog.
Files:      src/misc2.c
    

*** ../vim-7.1.136/src/misc2.c	Sat Sep 29 14:15:00 2007
--- src/misc2.c	Sun Sep 30 18:00:09 2007
***************
*** 1037,1043 ****
--- 1038,1046 ----
  
      /* Free some global vars. */
      vim_free(username);
+ # ifdef FEAT_CLIPBOARD
      vim_free(clip_exclude_prog);
+ # endif
      vim_free(last_cmdline);
      vim_free(new_last_cmdline);
      set_keep_msg(NULL, 0);
*** ../vim-7.1.136/src/version.c	Sun Oct  7 15:21:31 2007
--- src/version.c	Sun Oct  7 15:42:26 2007
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     137,
  /**/

-- 
For society, it's probably a good thing that engineers value function over
appearance.  For example, you wouldn't want engineers to build nuclear power
plants that only _look_ like they would keep all the radiation inside.
				(Scott Adams - The Dilbert principle)

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: Patch 7.1.138
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.138
Problem:    The Perl Msg() function doesn't stop when "q" is typed at the more
	    prompt. (Hari Krishna Dara)
Solution:   Check got_int.
Files:	    src/if_perl.xs


*** ../vim-7.1.137/src/if_perl.xs	Sat Sep 15 14:48:57 2007
--- src/if_perl.xs	Wed Oct  3 17:00:16 2007
***************
*** 445,457 ****
      char *next;
      char *token = (char *)s;
  
!     while ((next = strchr(token, '\n')))
      {
  	*next++ = '\0';			/* replace \n with \0 */
  	msg_attr((char_u *)token, attr);
  	token = next;
      }
!     if (*token)
  	msg_attr((char_u *)token, attr);
  }
  
--- 445,457 ----
      char *next;
      char *token = (char *)s;
  
!     while ((next = strchr(token, '\n')) && !got_int)
      {
  	*next++ = '\0';			/* replace \n with \0 */
  	msg_attr((char_u *)token, attr);
  	token = next;
      }
!     if (*token && !got_int)
  	msg_attr((char_u *)token, attr);
  }
  
*** ../vim-7.1.137/src/version.c	Sun Oct  7 15:44:28 2007
--- src/version.c	Tue Oct  9 10:45:08 2007
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     138,
  /**/

-- 
A consultant is a person who takes your money and annoys your employees while
tirelessly searching for the best way to extend the consulting contract.
				(Scott Adams - The Dilbert principle)

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: Patch 7.1.139
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.139
Problem:    When using marker folding and ending Insert mode with CTRL-C the
	    current fold is truncated. (Fred Kater)
Solution:   Ignore got_int while updating folds.
Files:	    src/fold.c


*** ../vim-7.1.138/src/fold.c	Thu May 10 21:02:13 2007
--- src/fold.c	Sun Oct 14 15:27:13 2007
***************
*** 858,864 ****
--- 858,871 ----
  	    || foldmethodIsDiff(wp)
  #endif
  	    || foldmethodIsSyntax(wp))
+     {
+ 	int save_got_int = got_int;
+ 
+ 	/* reset got_int here, otherwise it won't work */
+ 	got_int = FALSE;
  	foldUpdateIEMS(wp, top, bot);
+ 	got_int |= save_got_int;
+     }
  }
  
  /* foldUpdateAll() {{{2 */
*** ../vim-7.1.138/src/version.c	Tue Oct  9 10:46:39 2007
--- src/version.c	Sun Oct 14 15:31:18 2007
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     139,
  /**/

-- 
If Pacman had affected us as kids we'd be running around in dark rooms,
munching pills and listening to repetitive music.
                       -- Marcus Brigstocke

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: Patch 7.1.140
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.140
Problem:    v:count is set only after typing a non-digit, that makes it
	    difficult to make a nice mapping.
Solution:   Set v:count while still typing the count.
Files:	    src/normal.c


*** ../vim-7.1.139/src/normal.c	Thu Sep 13 18:25:08 2007
--- src/normal.c	Sun Oct 14 17:15:36 2007
***************
*** 690,695 ****
--- 690,702 ----
  		ca.count0 = ca.count0 * 10 + (c - '0');
  	    if (ca.count0 < 0)	    /* got too large! */
  		ca.count0 = 999999999L;
+ #ifdef FEAT_EVAL
+ 	    /* Set v:count here, when called from main() and not a stuffed
+ 	     * command, so that v:count can be used in an expression mapping
+ 	     * right after the count. */
+ 	    if (toplevel && stuff_empty())
+ 		set_vcount(ca.count0, ca.count0 == 0 ? 1 : ca.count0);
+ #endif
  	    if (ctrl_w)
  	    {
  		++no_mapping;
*** ../vim-7.1.139/src/version.c	Sun Oct 14 15:32:10 2007
--- src/version.c	Sun Oct 14 17:13:15 2007
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     140,
  /**/

-- 
How To Keep A Healthy Level Of Insanity:
11. Specify that your drive-through order is "to go".

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: Patch 7.1.141
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.141
Problem:    GTK: -geom argument doesn't support a negative offset.
Solution:   Compute position from the right/lower corner.
Files:	    src/gui_gtk_x11.c


*** ../vim-7.1.140/src/gui_gtk_x11.c	Sat Sep 15 14:06:41 2007
--- src/gui_gtk_x11.c	Mon Oct  8 21:26:50 2007
***************
*** 4044,4049 ****
--- 4044,4051 ----
  	unsigned int	w, h;
  	int		x = 0;
  	int		y = 0;
+ 	guint		pixel_width;
+ 	guint		pixel_height;
  
  	mask = XParseGeometry((char *)gui.geom, &x, &y, &w, &h);
  
***************
*** 4055,4066 ****
--- 4057,4087 ----
  		p_window = h - 1;
  	    Rows = h;
  	}
+ 
+ 	pixel_width = (guint)(gui_get_base_width() + Columns * gui.char_width);
+ 	pixel_height = (guint)(gui_get_base_height() + Rows * gui.char_height);
+ 
+ #ifdef HAVE_GTK2
+ 	pixel_width  += get_menu_tool_width();
+ 	pixel_height += get_menu_tool_height();
+ #endif
+ 
  	if (mask & (XValue | YValue))
+ 	{
+ 	    int w, h;
+ 	    gui_mch_get_screen_dimensions(&w, &h);
+ 	    h += p_ghr + get_menu_tool_height();
+ 	    w += get_menu_tool_width();
+ 	    if (mask & XNegative)
+ 		x += w - pixel_width;
+ 	    if (mask & YNegative)
+ 		y += h - pixel_height;
  #ifdef HAVE_GTK2
  	    gtk_window_move(GTK_WINDOW(gui.mainwin), x, y);
  #else
  	    gtk_widget_set_uposition(gui.mainwin, x, y);
  #endif
+ 	}
  	vim_free(gui.geom);
  	gui.geom = NULL;
  
***************
*** 4071,4084 ****
  	 */
  	if (gtk_socket_id != 0  &&  (mask & WidthValue || mask & HeightValue))
  	{
- 	    guint pixel_width = (guint)(gui_get_base_width() + Columns * gui.char_width);
- 	    guint pixel_height = (guint)(gui_get_base_height() + Rows * gui.char_height);
- 
- #ifdef HAVE_GTK2
- 	    pixel_width  += get_menu_tool_width();
- 	    pixel_height += get_menu_tool_height();
- #endif
- 
  	    update_window_manager_hints(pixel_width, pixel_height);
  	    init_window_hints_state = 1;
  	    g_timeout_add(1000, check_startup_plug_hints, NULL);
--- 4092,4097 ----
*** ../vim-7.1.140/src/version.c	Sun Oct 14 17:15:45 2007
--- src/version.c	Fri Oct 19 14:28:52 2007
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     141,
  /**/

-- 
hundred-and-one symptoms of being an internet addict:
35. Your husband tells you he's had the beard for 2 months.

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: Patch 7.1.142
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.142
Problem:    ":redir @A>" doesn't work.
Solution:   Ignore the extra ">" also when appending. (James Vega)
Files:	    src/ex_docmd.c


*** ../vim-7.1.141/src/ex_docmd.c	Sun Sep 30 14:00:41 2007
--- src/ex_docmd.c	Tue Oct  9 11:09:09 2007
***************
*** 8426,8446 ****
  		    || *arg == '"')
  	    {
  		redir_reg = *arg++;
! 		if (*arg == '>' && arg[1] == '>')
  		    arg += 2;
! 		else if ((*arg == NUL || (*arg == '>' && arg[1] == NUL)) &&
! 			 (islower(redir_reg)
! # ifdef FEAT_CLIPBOARD
! 			    || redir_reg == '*'
! 			    || redir_reg == '+'
! # endif
! 			    || redir_reg == '"'))
  		{
  		    if (*arg == '>')
  			arg++;
! 
! 		    /* make register empty */
! 		    write_reg_contents(redir_reg, (char_u *)"", -1, FALSE);
  		}
  	    }
  	    if (*arg != NUL)
--- 8426,8442 ----
  		    || *arg == '"')
  	    {
  		redir_reg = *arg++;
! 		if (*arg == '>' && arg[1] == '>')  /* append */
  		    arg += 2;
! 		else
  		{
+ 		    /* Can use both "@a" and "@a>". */
  		    if (*arg == '>')
  			arg++;
! 		    /* Make register empty when not using @A-@Z and the
! 		     * command is valid. */
! 		    if (*arg == NUL && !isupper(redir_reg))
! 			write_reg_contents(redir_reg, (char_u *)"", -1, FALSE);
  		}
  	    }
  	    if (*arg != NUL)
*** ../vim-7.1.141/src/version.c	Fri Oct 19 14:32:50 2007
--- src/version.c	Fri Oct 19 16:18:36 2007
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     142,
  /**/

-- 
hundred-and-one symptoms of being an internet addict:
36. You miss more than five meals a week downloading the latest games from
    Apogee.

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: Patch 7.1.143
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.143
Problem:    Uninitialized memory read when diffing three files. (Dominique
	    Pelle)
Solution:   Remove "+ !notset" so that we don't use fields that were not
	    computed.
Files:	    src/diff.c


*** ../vim-7.1.142/src/diff.c	Sat Sep 29 14:15:00 2007
--- src/diff.c	Sun Oct 14 21:52:56 2007
***************
*** 1310,1316 ****
  		    dp->df_count[idx_new] += -off;
  		off = 0;
  	    }
! 	    for (i = idx_orig; i < idx_new + !notset; ++i)
  		if (curtab->tp_diffbuf[i] != NULL)
  		    dp->df_count[i] = dpl->df_lnum[i] + dpl->df_count[i]
  						       - dp->df_lnum[i] + off;
--- 1310,1316 ----
  		    dp->df_count[idx_new] += -off;
  		off = 0;
  	    }
! 	    for (i = idx_orig; i < idx_new; ++i)
  		if (curtab->tp_diffbuf[i] != NULL)
  		    dp->df_count[i] = dpl->df_lnum[i] + dpl->df_count[i]
  						       - dp->df_lnum[i] + off;
*** ../vim-7.1.142/src/version.c	Fri Oct 19 16:20:09 2007
--- src/version.c	Fri Oct 19 17:32:18 2007
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     143,
  /**/

-- 
hundred-and-one symptoms of being an internet addict:
37. You start looking for hot HTML addresses in public restrooms.

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: Patch 7.1.144
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.144
Problem:    After ":diffup" cursor can be in the wrong position.
Solution:   Force recomputing the cursor position.
Files:	    src/diff.c


*** ../vim-7.1.143/src/diff.c	Fri Oct 19 17:32:58 2007
--- src/diff.c	Fri Oct 19 18:54:13 2007
***************
*** 791,796 ****
--- 791,799 ----
      }
      mch_remove(tmp_orig);
  
+     /* force updating cursor position on screen */
+     curwin->w_valid_cursor.lnum = 0;
+ 
      diff_redraw(TRUE);
  
  theend:
*** ../vim-7.1.143/src/version.c	Fri Oct 19 17:32:58 2007
--- src/version.c	Fri Oct 19 18:56:49 2007
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     144,
  /**/

-- 
He who laughs last, thinks slowest.

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: Patch 7.1.145
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.145
Problem:    Insert mode completion: When using the popup menu, after
	    completing a word and typing a non-word character Vim is still
	    completing the same word, following CTRL-N doesn't work.
	    Insert mode Completion: When using CTRL-X O and there is only
	    "struct." before the cursor, typing one char to reduce the
	    matches, then BS completion stops.
Solution:   When typing a character that is not part of the item being
	    completed, stop complete mode.  For whole line completion also
	    accept a space.  For file name completion stop at a path
	    separator.
	    For omni completion stay in completion mode even if completing
	    with empty string.
Files:	    src/edit.c


*** ../vim-7.1.144/src/edit.c	Thu Sep 13 18:25:08 2007
--- src/edit.c	Fri Oct 19 16:04:38 2007
***************
*** 129,134 ****
--- 129,135 ----
  
  static void ins_ctrl_x __ARGS((void));
  static int  has_compl_option __ARGS((int dict_opt));
+ static int  ins_compl_accept_char __ARGS((int c));
  static int ins_compl_add __ARGS((char_u *str, int len, int icase, char_u *fname, char_u **cptext, int cdir, int flags, int adup));
  static int  ins_compl_equal __ARGS((compl_T *match, char_u *str, int len));
  static void ins_compl_longest_match __ARGS((compl_T *match));
***************
*** 754,761 ****
  		    continue;
  		}
  
! 		/* A printable, non-white character: Add to "compl_leader". */
! 		if (vim_isprintc(c) && !vim_iswhite(c))
  		{
  		    ins_compl_addleader(c);
  		    continue;
--- 755,763 ----
  		    continue;
  		}
  
! 		/* A non-white character that fits in with the current
! 		 * completion: Add to "compl_leader". */
! 		if (ins_compl_accept_char(c))
  		{
  		    ins_compl_addleader(c);
  		    continue;
***************
*** 2053,2058 ****
--- 2055,2094 ----
  }
  
  /*
+  * Return TRUE when character "c" is part of the item currently being
+  * completed.  Used to decide whether to abandon complete mode when the menu
+  * is visible.
+  */
+     static int
+ ins_compl_accept_char(c)
+     int c;
+ {
+     if (ctrl_x_mode & CTRL_X_WANT_IDENT)
+ 	/* When expanding an identifier only accept identifier chars. */
+ 	return vim_isIDc(c);
+ 
+     switch (ctrl_x_mode)
+     {
+ 	case CTRL_X_FILES:
+ 	    /* When expanding file name only accept file name chars. But not
+ 	     * path separators, so that "proto/<Tab>" expands files in
+ 	     * "proto", not "proto/" as a whole */
+ 	    return vim_isfilec(c) && !vim_ispathsep(c);
+ 
+ 	case CTRL_X_CMDLINE:
+ 	case CTRL_X_OMNI:
+ 	    /* Command line and Omni completion can work with just about any
+ 	     * printable character, but do stop at white space. */
+ 	    return vim_isprintc(c) && !vim_iswhite(c);
+ 
+ 	case CTRL_X_WHOLE_LINE:
+ 	    /* For while line completion a space can be part of the line. */
+ 	    return vim_isprintc(c);
+     }
+     return vim_iswordc(c);
+ }
+ 
+ /*
   * This is like ins_compl_add(), but if 'ic' and 'inf' are set, then the
   * case of the originally typed text is used, and the case of the completed
   * text is inferred, ie this tries to work out what case you probably wanted
***************
*** 3128,3135 ****
      p = line + curwin->w_cursor.col;
      mb_ptr_back(line, p);
  
!     /* Stop completion when the whole word was deleted. */
!     if ((int)(p - line) - (int)compl_col <= 0)
  	return K_BS;
  
      /* Deleted more than what was used to find matches or didn't finish
--- 3164,3174 ----
      p = line + curwin->w_cursor.col;
      mb_ptr_back(line, p);
  
!     /* Stop completion when the whole word was deleted.  For Omni completion
!      * allow the word to be deleted, we won't match everything. */
!     if ((int)(p - line) - (int)compl_col < 0
! 	    || ((int)(p - line) - (int)compl_col == 0
! 		&& (ctrl_x_mode & CTRL_X_OMNI) == 0))
  	return K_BS;
  
      /* Deleted more than what was used to find matches or didn't finish
***************
*** 4591,4604 ****
  	curs_col = curwin->w_cursor.col;
  	compl_pending = 0;
  
! 	/* if this same ctrl_x_mode has been interrupted use the text from
  	 * "compl_startpos" to the cursor as a pattern to add a new word
  	 * instead of expand the one before the cursor, in word-wise if
! 	 * "compl_startpos"
! 	 * is not in the same line as the cursor then fix it (the line has
! 	 * been split because it was longer than 'tw').  if SOL is set then
! 	 * skip the previous pattern, a word at the beginning of the line has
! 	 * been inserted, we'll look for that  -- Acevedo. */
  	if ((compl_cont_status & CONT_INTRPT) == CONT_INTRPT
  					    && compl_cont_mode == ctrl_x_mode)
  	{
--- 4630,4642 ----
  	curs_col = curwin->w_cursor.col;
  	compl_pending = 0;
  
! 	/* If this same ctrl_x_mode has been interrupted use the text from
  	 * "compl_startpos" to the cursor as a pattern to add a new word
  	 * instead of expand the one before the cursor, in word-wise if
! 	 * "compl_startpos" is not in the same line as the cursor then fix it
! 	 * (the line has been split because it was longer than 'tw').  if SOL
! 	 * is set then skip the previous pattern, a word at the beginning of
! 	 * the line has been inserted, we'll look for that  -- Acevedo. */
  	if ((compl_cont_status & CONT_INTRPT) == CONT_INTRPT
  					    && compl_cont_mode == ctrl_x_mode)
  	{
*** ../vim-7.1.144/src/version.c	Fri Oct 19 18:57:33 2007
--- src/version.c	Fri Oct 19 20:38:21 2007
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     145,
  /**/

-- 
Micro$oft: where do you want to go today?
    Linux: where do you want to go tomorrow?
  FreeBSD: are you guys coming, or what?

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: Patch 7.1.146 (extra)
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.146 (extra)
Problem:    VMS: Files with a very rare record organization (VFC) cannot be
	    properly written by Vim.
	    On older VAX systems mms runs into a syntax error.
Solution:   Check for this special situation.  Do not wrap a comment, make it
	    one long line.  (Zoltan Arpadffy)
Files:	    src/fileio.c, src/Make_vms.mms


*** ../vim-7.1.145/src/fileio.c	Wed Oct  3 12:49:24 2007
--- src/fileio.c	Mon Oct 22 21:10:00 2007
***************
*** 4251,4257 ****
  	 * they don't it adds one.
  	 * With other RMS structures it works perfect without this fix.
  	 */
! 	if ((buf->b_fab_rat & (FAB$M_FTN | FAB$M_CR)) != 0)
  	{
  	    int b2write;
  
--- 4252,4259 ----
  	 * they don't it adds one.
  	 * With other RMS structures it works perfect without this fix.
  	 */
! 	if (buf->b_fab_rfm == FAB$C_VFC
! 		|| ((buf->b_fab_rat & (FAB$M_FTN | FAB$M_CR)) != 0))
  	{
  	    int b2write;
  
*** ../vim-7.1.145/src/Make_vms.mms	Thu May 10 20:47:35 2007
--- src/Make_vms.mms	Mon Oct 22 21:13:08 2007
***************
*** 2,8 ****
  # Makefile for Vim on OpenVMS
  #
  # Maintainer:   Zoltan Arpadffy <arpadffy@polarhome.com>
! # Last change:  2007 May 07
  #
  # This has script been tested on VMS 6.2 to 8.2 on DEC Alpha, VAX and IA64
  # with MMS and MMK
--- 2,8 ----
  # Makefile for Vim on OpenVMS
  #
  # Maintainer:   Zoltan Arpadffy <arpadffy@polarhome.com>
! # Last change:  2007 Oct 22
  #
  # This has script been tested on VMS 6.2 to 8.2 on DEC Alpha, VAX and IA64
  # with MMS and MMK
***************
*** 96,103 ****
  
  .IFDEF MMSVAX
  .IFDEF DECC	     # VAX with DECC
! CC_DEF  = cc # /decc # some system requires this switch
! 		     # but when it is not required /ver might fail
  PREFIX  = /prefix=all
  .ELSE		     # VAX with VAXC
  CC_DEF	= cc
--- 96,102 ----
  
  .IFDEF MMSVAX
  .IFDEF DECC	     # VAX with DECC
! CC_DEF  = cc # /decc # some system requires this switch but when it is not required /ver might fail
  PREFIX  = /prefix=all
  .ELSE		     # VAX with VAXC
  CC_DEF	= cc
*** ../vim-7.1.145/src/version.c	Fri Oct 19 20:39:56 2007
--- src/version.c	Mon Oct 29 22:36:20 2007
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     146,
  /**/

-- 
Be thankful to be in a traffic jam, because it means you own a car.

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: Patch 7.1.147
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.147 (after 7.1.127)
Problem:    Freeing memory already freed when completing user name. (Meino
	    Cramer)
Solution:   Use a flag to remember if "orig" needs to be freed.
Files:	    src/ex_getln.c


*** ../vim-7.1.146/src/ex_getln.c	Sun Sep 30 22:10:45 2007
--- src/ex_getln.c	Tue Oct 30 17:13:33 2007
***************
*** 3353,3358 ****
--- 3353,3359 ----
      char_u	*ss = NULL;
      static int	findex;
      static char_u *orig_save = NULL;	/* kept value of orig */
+     int		orig_saved = FALSE;
      int		i;
      long_u	len;
      int		non_suf_match;		/* number without matching suffix */
***************
*** 3421,3426 ****
--- 3422,3428 ----
      {
  	vim_free(orig_save);
  	orig_save = orig;
+ 	orig_saved = TRUE;
  
  	/*
  	 * Do the expansion.
***************
*** 3546,3552 ****
  	ExpandCleanup(xp);
  
      /* Free "orig" if it wasn't stored in "orig_save". */
!     if (orig != orig_save)
  	vim_free(orig);
  
      return ss;
--- 3548,3554 ----
  	ExpandCleanup(xp);
  
      /* Free "orig" if it wasn't stored in "orig_save". */
!     if (!orig_saved)
  	vim_free(orig);
  
      return ss;
*** ../vim-7.1.146/src/version.c	Mon Oct 29 22:37:57 2007
--- src/version.c	Tue Oct 30 17:30:35 2007
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     147,
  /**/

-- 
hundred-and-one symptoms of being an internet addict:
59. Your wife says communication is important in a marriage...so you buy
    another computer and install a second phone line so the two of you can
    chat.

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: Patch 7.1.148
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.148
Problem:    Some types are not found by configure.
Solution:   Test for the sys/types.h header file. (Sean Boudreau)
Files:	    src/configure.in, src/auto/configure


*** ../vim-7.1.147/src/configure.in	Thu Jun 28 13:02:22 2007
--- src/configure.in	Sat Oct 27 15:52:16 2007
***************
*** 2026,2032 ****
  fi
  
  AC_CHECK_HEADERS(stdarg.h stdlib.h string.h sys/select.h sys/utsname.h \
! 	termcap.h fcntl.h sgtty.h sys/ioctl.h sys/time.h termio.h \
  	iconv.h langinfo.h unistd.h stropts.h errno.h \
  	sys/resource.h sys/systeminfo.h locale.h \
  	sys/stream.h sys/ptem.h termios.h libc.h sys/statfs.h \
--- 2026,2032 ----
  fi
  
  AC_CHECK_HEADERS(stdarg.h stdlib.h string.h sys/select.h sys/utsname.h \
! 	termcap.h fcntl.h sgtty.h sys/ioctl.h sys/time.h sys/types.h termio.h \
  	iconv.h langinfo.h unistd.h stropts.h errno.h \
  	sys/resource.h sys/systeminfo.h locale.h \
  	sys/stream.h sys/ptem.h termios.h libc.h sys/statfs.h \
*** ../vim-7.1.147/src/auto/configure	Thu Jun 28 13:02:22 2007
--- src/auto/configure	Sun Nov  4 15:34:14 2007
***************
*** 10265,10272 ****
  
  
  
  for ac_header in stdarg.h stdlib.h string.h sys/select.h sys/utsname.h \
! 	termcap.h fcntl.h sgtty.h sys/ioctl.h sys/time.h termio.h \
  	iconv.h langinfo.h unistd.h stropts.h errno.h \
  	sys/resource.h sys/systeminfo.h locale.h \
  	sys/stream.h sys/ptem.h termios.h libc.h sys/statfs.h \
--- 10265,10273 ----
  
  
  
+ 
  for ac_header in stdarg.h stdlib.h string.h sys/select.h sys/utsname.h \
! 	termcap.h fcntl.h sgtty.h sys/ioctl.h sys/time.h sys/types.h termio.h \
  	iconv.h langinfo.h unistd.h stropts.h errno.h \
  	sys/resource.h sys/systeminfo.h locale.h \
  	sys/stream.h sys/ptem.h termios.h libc.h sys/statfs.h \
*** ../vim-7.1.147/src/version.c	Tue Oct 30 17:36:31 2007
--- src/version.c	Sun Nov  4 15:34:26 2007
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     148,
  /**/

-- 
If your nose runs, and your feet smell, you might be upside down.

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: Patch 7.1.149
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.149
Problem:    GTK GUI: When the completion popup menu is used scrolling another
	    window by the scrollbar is OK, but using the scroll wheel it
	    behaves line <Enter>.
Solution:   Ignore K_MOUSEDOWN and K_MOUSEUP.  Fix redrawing the popup menu.
Files:	    src/edit.c, src/gui.c


*** ../vim-7.1.148/src/edit.c	Fri Oct 19 20:39:56 2007
--- src/edit.c	Sun Nov  4 16:17:42 2007
***************
*** 3385,3392 ****
      if (c != Ctrl_R && vim_is_ctrl_x_key(c))
  	edit_submode_extra = NULL;
  
!     /* Ignore end of Select mode mapping */
!     if (c == K_SELECT)
  	return retval;
  
      /* Set "compl_get_longest" when finding the first matches. */
--- 3385,3392 ----
      if (c != Ctrl_R && vim_is_ctrl_x_key(c))
  	edit_submode_extra = NULL;
  
!     /* Ignore end of Select mode mapping and mouse scroll buttons. */
!     if (c == K_SELECT || c == K_MOUSEDOWN || c == K_MOUSEUP)
  	return retval;
  
      /* Set "compl_get_longest" when finding the first matches. */
***************
*** 8652,8666 ****
      int		up;
  {
      pos_T	tpos;
! # if defined(FEAT_GUI) && defined(FEAT_WINDOWS)
!     win_T	*old_curwin;
  # endif
  
      tpos = curwin->w_cursor;
  
  # if defined(FEAT_GUI) && defined(FEAT_WINDOWS)
-     old_curwin = curwin;
- 
      /* Currently the mouse coordinates are only known in the GUI. */
      if (gui.in_use && mouse_row >= 0 && mouse_col >= 0)
      {
--- 8652,8667 ----
      int		up;
  {
      pos_T	tpos;
! # if defined(FEAT_WINDOWS)
!     win_T	*old_curwin = curwin;
! # endif
! # ifdef FEAT_INS_EXPAND
!     int		did_scroll = FALSE;
  # endif
  
      tpos = curwin->w_cursor;
  
  # if defined(FEAT_GUI) && defined(FEAT_WINDOWS)
      /* Currently the mouse coordinates are only known in the GUI. */
      if (gui.in_use && mouse_row >= 0 && mouse_col >= 0)
      {
***************
*** 8677,8692 ****
  # endif
  	undisplay_dollar();
  
!     if (mod_mask & (MOD_MASK_SHIFT | MOD_MASK_CTRL))
! 	scroll_redraw(up, (long)(curwin->w_botline - curwin->w_topline));
!     else
! 	scroll_redraw(up, 3L);
  
  # if defined(FEAT_GUI) && defined(FEAT_WINDOWS)
      curwin->w_redr_status = TRUE;
  
      curwin = old_curwin;
      curbuf = curwin->w_buffer;
  # endif
  
      if (!equalpos(curwin->w_cursor, tpos))
--- 8678,8717 ----
  # endif
  	undisplay_dollar();
  
! # ifdef FEAT_INS_EXPAND
!     /* Don't scroll the window in which completion is being done. */
!     if (!pum_visible()
! #  if defined(FEAT_WINDOWS)
! 	    || curwin != old_curwin
! #  endif
! 	    )
! # endif
!     {
! 	if (mod_mask & (MOD_MASK_SHIFT | MOD_MASK_CTRL))
! 	    scroll_redraw(up, (long)(curwin->w_botline - curwin->w_topline));
! 	else
! 	    scroll_redraw(up, 3L);
! # ifdef FEAT_INS_EXPAND
! 	did_scroll = TRUE;
! # endif
!     }
  
  # if defined(FEAT_GUI) && defined(FEAT_WINDOWS)
      curwin->w_redr_status = TRUE;
  
      curwin = old_curwin;
      curbuf = curwin->w_buffer;
+ # endif
+ 
+ # ifdef FEAT_INS_EXPAND
+     /* The popup menu may overlay the window, need to redraw it.
+      * TODO: Would be more efficient to only redraw the windows that are
+      * overlapped by the popup menu. */
+     if (pum_visible() && did_scroll)
+     {
+ 	redraw_all_later(NOT_VALID);
+ 	ins_compl_show_pum();
+     }
  # endif
  
      if (!equalpos(curwin->w_cursor, tpos))
*** ../vim-7.1.148/src/gui.c	Wed Sep  5 21:45:54 2007
--- src/gui.c	Fri Oct 19 16:14:57 2007
***************
*** 4214,4220 ****
  #endif
  	    )
      {
! 	redraw_win_later(wp, VALID);
  	updateWindow(wp);   /* update window, status line, and cmdline */
      }
  
--- 4214,4232 ----
  #endif
  	    )
      {
! 	int type = VALID;
! 
! #ifdef FEAT_INS_EXPAND
! 	if (pum_visible())
! 	{
! 	    type = NOT_VALID;
! 	    wp->w_lines_valid = 0;
! 	}
! #endif
! 	/* Don't set must_redraw here, it may cause the popup menu to
! 	 * disappear when losing focus after a scrollbar drag. */
! 	if (wp->w_redr_type < type)
! 	    wp->w_redr_type = type;
  	updateWindow(wp);   /* update window, status line, and cmdline */
      }
  
*** ../vim-7.1.148/src/version.c	Sun Nov  4 15:35:23 2007
--- src/version.c	Tue Nov  6 22:21:03 2007
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     149,
  /**/

-- 
From "know your smileys":
 ...---...   SOS

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: Patch 7.1.150
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.150
Problem:    When 'clipboard' has "unnamed" using "p" in Visual mode doesn't
	    work correctly. (Jianrong Yu)
Solution:   When 'clipboard' has "unnamed" also obtain the selection when
	    getting the default register.
Files:	    src/ops.c


*** ../vim-7.1.149/src/ops.c	Tue Sep 25 14:19:35 2007
--- src/ops.c	Sun Oct 28 13:58:35 2007
***************
*** 933,941 ****
  #ifdef FEAT_CLIPBOARD
      /* When Visual area changed, may have to update selection.  Obtain the
       * selection too. */
!     if (name == '*' && clip_star.available && clip_isautosel())
      {
! 	clip_update_selection();
  	may_get_selection(name);
      }
  #endif
--- 933,942 ----
  #ifdef FEAT_CLIPBOARD
      /* When Visual area changed, may have to update selection.  Obtain the
       * selection too. */
!     if (name == '*' && clip_star.available)
      {
! 	if (clip_isautosel())
! 	    clip_update_selection();
  	may_get_selection(name);
      }
  #endif
*** ../vim-7.1.149/src/version.c	Tue Nov  6 22:26:39 2007
--- src/version.c	Thu Nov  8 10:34:18 2007
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     150,
  /**/

-- 
From "know your smileys":
 8<}}	Glasses, big nose, beard

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: Patch 7.1.151
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.151
Problem:    Using whole line completion with 'ignorecase' and 'infercase' set
	    and the line is empty get an lalloc(0) error.
Solution:   Don't try changing case for an empty match. (Matthew Wozniski)
Files:	    src/edit.c


*** ../vim-7.1.150/src/edit.c	Tue Nov  6 22:26:39 2007
--- src/edit.c	Sun Nov  4 16:17:42 2007
***************
*** 2111,2117 ****
      int		has_lower = FALSE;
      int		was_letter = FALSE;
  
!     if (p_ic && curbuf->b_p_inf)
      {
  	/* Infer case of completed part. */
  
--- 2111,2117 ----
      int		has_lower = FALSE;
      int		was_letter = FALSE;
  
!     if (p_ic && curbuf->b_p_inf && len > 0)
      {
  	/* Infer case of completed part. */
  
***************
*** 2225,2231 ****
  		    wca[i] = MB_TOUPPER(wca[i]);
  	    }
  
! 	    /* 
  	     * Generate encoding specific output from wide character array.
  	     * Multi-byte characters can occupy up to five bytes more than
  	     * ASCII characters, and we also need one byte for NUL, so stay
--- 2225,2231 ----
  		    wca[i] = MB_TOUPPER(wca[i]);
  	    }
  
! 	    /*
  	     * Generate encoding specific output from wide character array.
  	     * Multi-byte characters can occupy up to five bytes more than
  	     * ASCII characters, and we also need one byte for NUL, so stay
*** ../vim-7.1.150/src/version.c	Thu Nov  8 10:35:02 2007
--- src/version.c	Thu Nov  8 13:01:34 2007
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     151,
  /**/

-- 
From "know your smileys":
 %-)	After staring at screen for 15 hours

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: Patch 7.1.152
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.152
Problem:    Display problem when 'hls' and 'cursorcolumn' are set and
	    searching for "$".  (John Mullin)  Also when scrolling
	    horizontally when 'wrap' is off.
Solution:   Keep track of the column where highlighting was set.  Check the
	    column offset when skipping characters.
Files:	    src/screen.c


*** ../vim-7.1.151/src/screen.c	Mon Sep 17 22:37:05 2007
--- src/screen.c	Fri Oct 19 15:18:49 2007
***************
*** 2599,2604 ****
--- 2599,2605 ----
      int		syntax_attr = 0;	/* attributes desired by syntax */
      int		has_syntax = FALSE;	/* this buffer has syntax highl. */
      int		save_did_emsg;
+     int		eol_hl_off = 0;		/* 1 if highlighted char after EOL */
  #endif
  #ifdef FEAT_SPELL
      int		has_spell = FALSE;	/* this buffer has spell checking */
***************
*** 4312,4317 ****
--- 4313,4322 ----
  	{
  #ifdef FEAT_SEARCH_EXTRA
  	    long prevcol = (long)(ptr - line) - (c == NUL);
+ 
+ 	    /* we're not really at that column when skipping some text */
+ 	    if ((wp->w_p_wrap ? wp->w_skipcol : wp->w_leftcol) > prevcol)
+ 		++prevcol;
  #endif
  
  	    /* invert at least one char, used for Visual and empty line or
***************
*** 4408,4418 ****
--- 4413,4432 ----
  		ScreenAttrs[off] = char_attr;
  #ifdef FEAT_RIGHTLEFT
  		if (wp->w_p_rl)
+ 		{
  		    --col;
+ 		    --off;
+ 		}
  		else
  #endif
+ 		{
  		    ++col;
+ 		    ++off;
+ 		}
  		++vcol;
+ #ifdef FEAT_SYN_HL
+ 		eol_hl_off = 1;
+ #endif
  	    }
  	}
  
***************
*** 4422,4427 ****
--- 4436,4449 ----
  	if (c == NUL)
  	{
  #ifdef FEAT_SYN_HL
+ 	    if (eol_hl_off > 0 && vcol - eol_hl_off == (long)wp->w_virtcol)
+ 	    {
+ 		/* highlight last char after line */
+ 		--col;
+ 		--off;
+ 		--vcol;
+ 	    }
+ 
  	    /* Highlight 'cursorcolumn' past end of the line. */
  	    if (wp->w_p_wrap)
  		v = wp->w_skipcol;
***************
*** 4432,4438 ****
  
  		vcol = v + col - win_col_off(wp);
  	    if (wp->w_p_cuc
! 		    && (int)wp->w_virtcol >= vcol
  		    && (int)wp->w_virtcol < W_WIDTH(wp) * (row - startrow + 1)
  									   + v
  		    && lnum != wp->w_cursor.lnum
--- 4454,4460 ----
  
  		vcol = v + col - win_col_off(wp);
  	    if (wp->w_p_cuc
! 		    && (int)wp->w_virtcol >= vcol - eol_hl_off
  		    && (int)wp->w_virtcol < W_WIDTH(wp) * (row - startrow + 1)
  									   + v
  		    && lnum != wp->w_cursor.lnum
*** ../vim-7.1.151/src/version.c	Thu Nov  8 13:03:33 2007
--- src/version.c	Thu Nov  8 14:48:59 2007
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     152,
  /**/

-- 
From "know your smileys":
 2B|^2B	  Message from Shakespeare

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: Patch 7.1.153
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.153
Problem:    Compiler warnings on SGI.  Undefined XpmAllocColor (Charles
	    Campbell)
Solution:   Add type casts.  Init st_dev and st_ino separately.  Don't use
	    type casts for vim_snprintf() when HAVE_STDARG_H is defined.
	    Define XpmAllocColor when needed.
Files:	    src/eval.c, src/ex_cmds.c, src/fileio.c, src/misc2.c,
	    src/gui_xmebw.c


*** ../vim-7.1.152/src/eval.c	Tue Oct  2 22:07:58 2007
--- src/eval.c	Mon Oct  1 20:56:09 2007
***************
*** 8729,8735 ****
      static int		fnum = 0;
      static int		change_start = 0;
      static int		change_end = 0;
!     static hlf_T	hlID = 0;
      int			filler_lines;
      int			col;
  
--- 8729,8735 ----
      static int		fnum = 0;
      static int		change_start = 0;
      static int		change_end = 0;
!     static hlf_T	hlID = (hlf_T)0;
      int			filler_lines;
      int			col;
  
*** ../vim-7.1.152/src/ex_cmds.c	Thu Sep 13 18:25:08 2007
--- src/ex_cmds.c	Thu Sep 13 16:19:40 2007
***************
*** 1774,1780 ****
  	 * overwrite a user's viminfo file after a "su root", with a
  	 * viminfo file that the user can't read.
  	 */
! 	st_old.st_dev = st_old.st_ino = 0;
  	st_old.st_mode = 0600;
  	if (mch_stat((char *)fname, &st_old) == 0
  		&& getuid() != ROOT_UID
--- 1774,1781 ----
  	 * overwrite a user's viminfo file after a "su root", with a
  	 * viminfo file that the user can't read.
  	 */
! 	st_old.st_dev = 0;
! 	st_old.st_ino = 0;
  	st_old.st_mode = 0600;
  	if (mch_stat((char *)fname, &st_old) == 0
  		&& getuid() != ROOT_UID
*** ../vim-7.1.152/src/fileio.c	Mon Oct 29 22:37:57 2007
--- src/fileio.c	Mon Oct 22 21:10:00 2007
***************
*** 3209,3215 ****
       * Get information about original file (if there is one).
       */
  #if defined(UNIX) && !defined(ARCHIE)
!     st_old.st_dev = st_old.st_ino = 0;
      perm = -1;
      if (mch_stat((char *)fname, &st_old) < 0)
  	newfile = TRUE;
--- 3209,3216 ----
       * Get information about original file (if there is one).
       */
  #if defined(UNIX) && !defined(ARCHIE)
!     st_old.st_dev = 0;
!     st_old.st_ino = 0;
      perm = -1;
      if (mch_stat((char *)fname, &st_old) < 0)
  	newfile = TRUE;
*** ../vim-7.1.152/src/misc2.c	Sun Oct  7 15:44:28 2007
--- src/misc2.c	Sun Sep 30 18:00:09 2007
***************
*** 5924,5930 ****
--- 5925,5935 ----
  {
      if (emsg_not_now())
  	return TRUE;		/* no error messages at the moment */
+ #ifdef HAVE_STDARG_H
+     vim_snprintf((char *)IObuff, IOSIZE, (char *)s, a1, a2);
+ #else
      vim_snprintf((char *)IObuff, IOSIZE, (char *)s, (long_u)a1, (long_u)a2);
+ #endif
      return emsg(IObuff);
  }
  
*** ../vim-7.1.152/src/gui_xmebw.c	Thu May 10 19:46:55 2007
--- src/gui_xmebw.c	Thu Sep  6 12:57:51 2007
***************
*** 395,405 ****
  
      /* Create the "highlight" pixmap. */
      color[4].pixel = eb->primitive.bottom_shadow_color;
      attr.valuemask = XpmColorSymbols | XpmCloseness | XpmAllocColor;
      attr.closeness = 65535;	/* accuracy isn't crucial */
      attr.colorsymbols = color;
      attr.numsymbols = XtNumber(color);
-     attr.alloc_color = alloc_color;
  
      status = XpmCreatePixmapFromData(dpy, root, data, &pix, NULL, &attr);
      XpmFreeAttributes(&attr);
--- 395,409 ----
  
      /* Create the "highlight" pixmap. */
      color[4].pixel = eb->primitive.bottom_shadow_color;
+ #ifdef XpmAllocColor /* SGI doesn't have it */
      attr.valuemask = XpmColorSymbols | XpmCloseness | XpmAllocColor;
+     attr.alloc_color = alloc_color;
+ #else
+     attr.valuemask = XpmColorSymbols | XpmCloseness;
+ #endif
      attr.closeness = 65535;	/* accuracy isn't crucial */
      attr.colorsymbols = color;
      attr.numsymbols = XtNumber(color);
  
      status = XpmCreatePixmapFromData(dpy, root, data, &pix, NULL, &attr);
      XpmFreeAttributes(&attr);
*** ../vim-7.1.152/src/version.c	Thu Nov  8 14:50:58 2007
--- src/version.c	Thu Nov  8 20:45:56 2007
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     153,
  /**/

-- 
From "know your smileys":
 @:-()	Elvis Presley

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: Patch 7.1.154
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.154
Problem:    Compiler warning for signed/unsigned compare.
Solution:   Add type cast.
Files:	    src/screen.c


*** ../vim-7.1.153/src/screen.c	Thu Nov  8 14:50:58 2007
--- src/screen.c	Thu Nov  8 21:18:46 2007
***************
*** 4315,4321 ****
  	    long prevcol = (long)(ptr - line) - (c == NUL);
  
  	    /* we're not really at that column when skipping some text */
! 	    if ((wp->w_p_wrap ? wp->w_skipcol : wp->w_leftcol) > prevcol)
  		++prevcol;
  #endif
  
--- 4315,4321 ----
  	    long prevcol = (long)(ptr - line) - (c == NUL);
  
  	    /* we're not really at that column when skipping some text */
! 	    if ((long)(wp->w_p_wrap ? wp->w_skipcol : wp->w_leftcol) > prevcol)
  		++prevcol;
  #endif
  
*** ../vim-7.1.153/src/version.c	Thu Nov  8 20:47:34 2007
--- src/version.c	Thu Nov  8 21:19:59 2007
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     154,
  /**/

-- 
From "know your smileys":
 :-F	Bucktoothed vampire with one tooth missing

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: Patch 7.1.155
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.155
Problem:    Crash when 'undolevels' is 0 and repeating "udd". (James Vega)
Solution:   When there is only one branch use u_freeheader() to delete it.
Files:	    src/undo.c


*** ../vim-7.1.154/src/undo.c	Mon Oct  1 22:53:27 2007
--- src/undo.c	Sat Nov 10 13:45:28 2007
***************
*** 1677,1682 ****
--- 1677,1690 ----
      u_header_T	    **uhpp;	/* if not NULL reset when freeing this header */
  {
      u_header_T	    *tofree, *next;
+ 
+     /* If this is the top branch we may need to use u_freeheader() to update
+      * all the pointers. */
+     if (uhp == buf->b_u_oldhead)
+     {
+ 	u_freeheader(buf, uhp, uhpp);
+ 	return;
+     }
  
      if (uhp->uh_alt_prev != NULL)
  	uhp->uh_alt_prev->uh_alt_next = NULL;
*** ../vim-7.1.154/src/version.c	Thu Nov  8 21:23:34 2007
--- src/version.c	Sat Nov 10 22:49:40 2007
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     155,
  /**/

-- 
I AM THANKFUL...
...for the piles of laundry and ironing because it means I
have plenty of clothes to wear.

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: Patch 7.1.156
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.156
Problem:    Overlapping arguments for strcpy() when expanding command line
	    variables.
Solution:   Use mch_memmove() instead of STRCPY().  Also fix a few typos.
	    (Dominique Pelle)
Files:	    src/ex_docmd.c


*** ../vim-7.1.155/src/ex_docmd.c	Fri Oct 19 16:20:09 2007
--- src/ex_docmd.c	Sat Nov 10 12:39:51 2007
***************
*** 666,672 ****
  		if (ex_pressedreturn)
  		{
  		    /* go up one line, to overwrite the ":<CR>" line, so the
! 		     * output doensn't contain empty lines. */
  		    msg_row = prev_msg_row;
  		    if (prev_msg_row == Rows - 1)
  			msg_row--;
--- 666,672 ----
  		if (ex_pressedreturn)
  		{
  		    /* go up one line, to overwrite the ":<CR>" line, so the
! 		     * output doesn't contain empty lines. */
  		    msg_row = prev_msg_row;
  		    if (prev_msg_row == Rows - 1)
  			msg_row--;
***************
*** 2760,2766 ****
  
      /*
       * Isolate the command and search for it in the command table.
!      * Exeptions:
       * - the 'k' command can directly be followed by any character.
       * - the 's' command can be followed directly by 'c', 'g', 'i', 'I' or 'r'
       *	    but :sre[wind] is another command, as are :scrip[tnames],
--- 2760,2766 ----
  
      /*
       * Isolate the command and search for it in the command table.
!      * Exceptions:
       * - the 'k' command can directly be followed by any character.
       * - the 's' command can be followed directly by 'c', 'g', 'i', 'I' or 'r'
       *	    but :sre[wind] is another command, as are :scrip[tnames],
***************
*** 6677,6683 ****
   * The list should be allocated using alloc(), as should each item in the
   * list. This function takes over responsibility for freeing the list.
   *
!  * XXX The list is made into the arggument list. This is freed using
   * FreeWild(), which does a series of vim_free() calls, unless the two defines
   * __EMX__ and __ALWAYS_HAS_TRAILING_NUL_POINTER are set. In this case, a
   * routine _fnexplodefree() is used. This may cause problems, but as the drop
--- 6677,6683 ----
   * The list should be allocated using alloc(), as should each item in the
   * list. This function takes over responsibility for freeing the list.
   *
!  * XXX The list is made into the argument list. This is freed using
   * FreeWild(), which does a series of vim_free() calls, unless the two defines
   * __EMX__ and __ALWAYS_HAS_TRAILING_NUL_POINTER are set. In this case, a
   * routine _fnexplodefree() is used. This may cause problems, but as the drop
***************
*** 7795,7801 ****
  	if (vim_strchr(p_cpo, CPO_CHDIR) != NULL && curbufIsChanged()
  							     && !eap->forceit)
  	{
! 	    EMSG(_("E747: Cannot change directory, buffer is modifed (add ! to override)"));
  	    return;
  	}
  
--- 7795,7801 ----
  	if (vim_strchr(p_cpo, CPO_CHDIR) != NULL && curbufIsChanged()
  							     && !eap->forceit)
  	{
! 	    EMSG(_("E747: Cannot change directory, buffer is modified (add ! to override)"));
  	    return;
  	}
  
***************
*** 9391,9397 ****
      if (src > srcstart && src[-1] == '\\')
      {
  	*usedlen = 0;
! 	STRCPY(src - 1, src);		/* remove backslash */
  	return NULL;
      }
  
--- 9391,9397 ----
      if (src > srcstart && src[-1] == '\\')
      {
  	*usedlen = 0;
! 	mch_memmove(src - 1, src, STRLEN(src) + 1);	/* remove backslash */
  	return NULL;
      }
  
*** ../vim-7.1.155/src/version.c	Sat Nov 10 22:50:20 2007
--- src/version.c	Sun Nov 11 19:15:51 2007
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     156,
  /**/

-- 
Common sense is what tells you that the world is flat.

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: Patch 7.1.157
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.157
Problem:    In Ex mode, :" gives an error at end-of-file. (Michael Hordijk)
Solution:   Only give an error for an empty line, not for a comment.
Files:	    src/ex_docmd.c


*** ../vim-7.1.156/src/ex_docmd.c	Sun Nov 11 19:16:44 2007
--- src/ex_docmd.c	Sat Nov 17 20:23:38 2007
***************
*** 1741,1747 ****
  	}
  
  	/* ignore comment and empty lines */
! 	if (*ea.cmd == '"' || *ea.cmd == NUL)
  	{
  	    ex_pressedreturn = TRUE;
  	    goto doend;
--- 1741,1749 ----
  	}
  
  	/* ignore comment and empty lines */
! 	if (*ea.cmd == '"')
! 	    goto doend;
! 	if (*ea.cmd == NUL)
  	{
  	    ex_pressedreturn = TRUE;
  	    goto doend;
*** ../vim-7.1.156/src/version.c	Sun Nov 11 19:16:44 2007
--- src/version.c	Tue Nov 20 12:28:22 2007
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     157,
  /**/

-- 
hundred-and-one symptoms of being an internet addict:
119. You are reading a book and look for the scroll bar to get to
     the next page.

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: Patch 7.1.158 (extra)
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.158 (extra)
Problem:    Win32 console: When 'encoding' is "utf-8" and typing Alt-y the
            result is wrong.  Win32 GUI: Alt-y results in "u" when 'encoding'
            is "cp1250" (Lukas Cerman)
Solution:   For utf-8 don't set the 7th bit in a byte, convert to the correct
            byte sequence.  For cp1250, when conversion to 'encoding' results
            in the 7th bit not set, set the 7th bit after conversion.
Files:      src/os_win32.c, src/gui_w48.c


*** ../vim-7.1.157/src/os_win32.c	Mon Oct  1 20:33:45 2007
--- src/os_win32.c	Sat Oct 27 17:35:04 2007
***************
*** 1521,1527 ****
--- 1521,1532 ----
  #endif
  		   )
  		{
+ #ifdef FEAT_MBYTE
+ 		    n = (*mb_char2bytes)(typeahead[typeaheadlen] | 0x80,
+ 						    typeahead + typeaheadlen);
+ #else
  		    typeahead[typeaheadlen] |= 0x80;
+ #endif
  		    modifiers &= ~MOD_MASK_ALT;
  		}
  
*** ../vim-7.1.157/src/gui_w48.c	Sun Sep 30 14:00:41 2007
--- src/gui_w48.c	Mon Oct 29 20:00:25 2007
***************
*** 486,495 ****
  
  /*
   * Convert Unicode character "ch" to bytes in "string[slen]".
   * Return the length.
   */
      static int
! char_to_string(int ch, char_u *string, int slen)
  {
      int		len;
      int		i;
--- 486,496 ----
  
  /*
   * Convert Unicode character "ch" to bytes in "string[slen]".
+  * When "had_alt" is TRUE the ALT key was included in "ch".
   * Return the length.
   */
      static int
! char_to_string(int ch, char_u *string, int slen, int had_alt)
  {
      int		len;
      int		i;
***************
*** 522,529 ****
--- 523,544 ----
  	 * "enc_codepage" is non-zero use the standard Win32 function,
  	 * otherwise use our own conversion function (e.g., for UTF-8). */
  	if (enc_codepage > 0)
+ 	{
  	    len = WideCharToMultiByte(enc_codepage, 0, wstring, len,
  						       string, slen, 0, NULL);
+ 	    /* If we had included the ALT key into the character but now the
+ 	     * upper bit is no longer set, that probably means the conversion
+ 	     * failed.  Convert the original character and set the upper bit
+ 	     * afterwards. */
+ 	    if (had_alt && len == 1 && ch >= 0x80 && string[0] < 0x80)
+ 	    {
+ 		wstring[0] = ch & 0x7f;
+ 		len = WideCharToMultiByte(enc_codepage, 0, wstring, len,
+ 						       string, slen, 0, NULL);
+ 		if (len == 1) /* safety check */
+ 		    string[0] |= 0x80;
+ 	    }
+ 	}
  	else
  	{
  	    len = 1;
***************
*** 573,579 ****
      char_u	string[40];
      int		len = 0;
  
!     len = char_to_string(ch, string, 40);
      if (len == 1 && string[0] == Ctrl_C && ctrl_c_interrupts)
      {
  	trash_input_buf();
--- 588,594 ----
      char_u	string[40];
      int		len = 0;
  
!     len = char_to_string(ch, string, 40, FALSE);
      if (len == 1 && string[0] == Ctrl_C && ctrl_c_interrupts)
      {
  	trash_input_buf();
***************
*** 640,646 ****
      {
  	/* Although the documentation isn't clear about it, we assume "ch" is
  	 * a Unicode character. */
! 	len += char_to_string(ch, string + len, 40 - len);
      }
  
      add_to_input_buf(string, len);
--- 655,661 ----
      {
  	/* Although the documentation isn't clear about it, we assume "ch" is
  	 * a Unicode character. */
! 	len += char_to_string(ch, string + len, 40 - len, TRUE);
      }
  
      add_to_input_buf(string, len);
***************
*** 1775,1781 ****
  		    int	len;
  
  		    /* Handle "key" as a Unicode character. */
! 		    len = char_to_string(key, string, 40);
  		    add_to_input_buf(string, len);
  		}
  		break;
--- 1790,1796 ----
  		    int	len;
  
  		    /* Handle "key" as a Unicode character. */
! 		    len = char_to_string(key, string, 40, FALSE);
  		    add_to_input_buf(string, len);
  		}
  		break;
*** ../vim-7.1.157/src/version.c	Tue Nov 20 12:30:31 2007
--- src/version.c	Tue Nov 20 17:19:18 2007
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     158,
  /**/

-- 
hundred-and-one symptoms of being an internet addict:
123. You ask the car dealer to install an extra cigarette lighter
     on your new car to power your notebook.

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: Patch 7.1.159
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.159
Problem:    strcpy() has overlapping arguments.
Solution:   Use mch_memmove() instead. (Dominique Pelle)
Files:	    src/ex_cmds.c


*** ../vim-7.1.158/src/ex_cmds.c	Thu Nov  8 20:47:34 2007
--- src/ex_cmds.c	Sun Nov 18 14:11:58 2007
***************
*** 4885,4891 ****
  			    ++line2;
  			    /* move the cursor to the new line, like Vi */
  			    ++curwin->w_cursor.lnum;
! 			    STRCPY(new_start, p1 + 1);	/* copy the rest */
  			    p1 = new_start - 1;
  			}
  		    }
--- 4885,4892 ----
  			    ++line2;
  			    /* move the cursor to the new line, like Vi */
  			    ++curwin->w_cursor.lnum;
! 			    /* copy the rest */
! 			    mch_memmove(new_start, p1 + 1, STRLEN(p1 + 1) + 1);
  			    p1 = new_start - 1;
  			}
  		    }
*** ../vim-7.1.158/src/version.c	Tue Nov 20 17:21:28 2007
--- src/version.c	Tue Nov 20 18:01:45 2007
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     159,
  /**/

-- 
hundred-and-one symptoms of being an internet addict:
125. You begin to wonder how often it REALLY is necessary to get up
     and shower or bathe.

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: Patch 7.1.160
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.160
Problem:    When a focus autocommand is defined, getting or losing focus
	    causes the hit-enter prompt to be redrawn. (Bjorn Winckler)
Solution:   Overwrite the last line.
Files:	    src/message.c


*** ../vim-7.1.159/src/message.c	Thu Sep 13 22:04:30 2007
--- src/message.c	Sun Nov  4 17:33:15 2007
***************
*** 2850,2855 ****
--- 2850,2864 ----
      }
      else if (State == HITRETURN || State == SETWSIZE)
      {
+ 	if (msg_row == Rows - 1)
+ 	{
+ 	    /* Avoid drawing the "hit-enter" prompt below the previous one,
+ 	     * overwrite it.  Esp. useful when regaining focus and a
+ 	     * FocusGained autocmd exists but didn't draw anything. */
+ 	    msg_didout = FALSE;
+ 	    msg_col = 0;
+ 	    msg_clr_eos();
+ 	}
  	hit_return_msg();
  	msg_row = Rows - 1;
      }
*** ../vim-7.1.159/src/version.c	Tue Nov 20 18:03:34 2007
--- src/version.c	Sat Nov 24 15:41:43 2007
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     160,
  /**/

-- 
hundred-and-one symptoms of being an internet addict:
142. You dream about creating the world's greatest web site.

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: Patch 7.1.161
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.161
Problem:    Compilation errors with tiny features and EXITFREE.
Solution:   Add #ifdefs. (Dominique Pelle)
Files:	    src/edit.c, src/misc2.c


*** ../vim-7.1.160/src/edit.c	Thu Nov  8 13:03:33 2007
--- src/edit.c	Sat Nov 24 14:57:46 2007
***************
*** 2236,2242 ****
  	    while (i < actual_len && (p - IObuff + 6) < IOSIZE)
  #ifdef FEAT_MBYTE
  		if (has_mbyte)
! 		    p += mb_char2bytes(wca[i++], p);
  		else
  #endif
  		    *(p++) = wca[i++];
--- 2236,2242 ----
  	    while (i < actual_len && (p - IObuff + 6) < IOSIZE)
  #ifdef FEAT_MBYTE
  		if (has_mbyte)
! 		    p += (*mb_char2bytes)(wca[i++], p);
  		else
  #endif
  		    *(p++) = wca[i++];
***************
*** 6444,6451 ****
--- 6444,6453 ----
  {
      vim_free(last_insert);
      last_insert = NULL;
+ # ifdef FEAT_INS_EXPAND
      vim_free(compl_orig_text);
      compl_orig_text = NULL;
+ # endif
  }
  #endif
  
*** ../vim-7.1.160/src/misc2.c	Thu Nov  8 20:47:34 2007
--- src/misc2.c	Sat Nov 24 15:01:46 2007
***************
*** 964,970 ****
  {
      buf_T	*buf, *nextbuf;
      static int	entered = FALSE;
-     win_T	*win;
  
      /* When we cause a crash here it is caught and Vim tries to exit cleanly.
       * Don't try freeing everything again. */
--- 965,970 ----
***************
*** 972,986 ****
  	return;
      entered = TRUE;
  
      block_autocmds();	    /* don't want to trigger autocommands here */
  
! #ifdef FEAT_WINDOWS
      /* close all tabs and windows */
      if (first_tabpage->tp_next != NULL)
  	do_cmdline_cmd((char_u *)"tabonly!");
      if (firstwin != lastwin)
  	do_cmdline_cmd((char_u *)"only!");
! #endif
  
  # if defined(FEAT_SPELL)
      /* Free all spell info. */
--- 972,988 ----
  	return;
      entered = TRUE;
  
+ # ifdef FEAT_AUTOCMD
      block_autocmds();	    /* don't want to trigger autocommands here */
+ # endif
  
! # ifdef FEAT_WINDOWS
      /* close all tabs and windows */
      if (first_tabpage->tp_next != NULL)
  	do_cmdline_cmd((char_u *)"tabonly!");
      if (firstwin != lastwin)
  	do_cmdline_cmd((char_u *)"only!");
! # endif
  
  # if defined(FEAT_SPELL)
      /* Free all spell info. */
***************
*** 1031,1038 ****
--- 1033,1044 ----
      free_regexp_stuff();
      free_tag_stuff();
      free_cd_dir();
+ # ifdef FEAT_EVAL
      set_expr_line(NULL);
+ # endif
+ # ifdef FEAT_DIFF
      diff_clear(curtab);
+ # endif
      clear_sb_text();	      /* free any scrollback text */
  
      /* Free some global vars. */
***************
*** 1041,1059 ****
      vim_free(clip_exclude_prog);
  # endif
      vim_free(last_cmdline);
      vim_free(new_last_cmdline);
      set_keep_msg(NULL, 0);
      vim_free(ff_expand_buffer);
  
      /* Clear cmdline history. */
      p_hi = 0;
      init_history();
  
  #ifdef FEAT_QUICKFIX
!     qf_free_all(NULL);
!     /* Free all location lists */
!     FOR_ALL_WINDOWS(win)
! 	qf_free_all(win);
  #endif
  
      /* Close all script inputs. */
--- 1047,1073 ----
      vim_free(clip_exclude_prog);
  # endif
      vim_free(last_cmdline);
+ # ifdef FEAT_CMDHIST
      vim_free(new_last_cmdline);
+ # endif
      set_keep_msg(NULL, 0);
      vim_free(ff_expand_buffer);
  
      /* Clear cmdline history. */
      p_hi = 0;
+ # ifdef FEAT_CMDHIST
      init_history();
+ # endif
  
  #ifdef FEAT_QUICKFIX
!     {
! 	win_T	*win;
! 
! 	qf_free_all(NULL);
! 	/* Free all location lists */
! 	FOR_ALL_WINDOWS(win)
! 	    qf_free_all(win);
!     }
  #endif
  
      /* Close all script inputs. */
*** ../vim-7.1.160/src/version.c	Sat Nov 24 15:44:17 2007
--- src/version.c	Sat Nov 24 20:55:38 2007
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     161,
  /**/

-- 
hundred-and-one symptoms of being an internet addict:
143. You dream in pallettes of 216 websafe colors.

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: Patch 7.1.162
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.162
Problem:    Crash when using a modifier before "while" or "for". (A.Politz)
Solution:   Skip modifiers when checking for a loop command.
Files:	    src/proto/ex_docmd.pro, src/ex_docmd.c, src/ex_eval.c


*** ../vim-7.1.161/src/proto/ex_docmd.pro	Sun Sep 30 14:00:41 2007
--- src/proto/ex_docmd.pro	Sat Nov 24 16:34:06 2007
***************
*** 5,10 ****
--- 5,11 ----
  int getline_equal __ARGS((char_u *(*fgetline)(int, void *, int), void *cookie, char_u *(*func)(int, void *, int)));
  void *getline_cookie __ARGS((char_u *(*fgetline)(int, void *, int), void *cookie));
  int checkforcmd __ARGS((char_u **pp, char *cmd, int len));
+ int modifier_len __ARGS((char_u *cmd));
  int cmd_exists __ARGS((char_u *name));
  char_u *set_one_cmd_context __ARGS((expand_T *xp, char_u *buff));
  char_u *skip_range __ARGS((char_u *cmd, int *ctx));
*** ../vim-7.1.161/src/ex_docmd.c	Tue Nov 20 12:30:31 2007
--- src/ex_docmd.c	Sat Nov 24 16:41:20 2007
***************
*** 2963,2968 ****
--- 2963,3019 ----
  #endif
  
  #if defined(FEAT_EVAL) || defined(PROTO)
+ static struct cmdmod
+ {
+     char	*name;
+     int		minlen;
+     int		has_count;  /* :123verbose  :3tab */
+ } cmdmods[] = {
+     {"aboveleft", 3, FALSE},
+     {"belowright", 3, FALSE},
+     {"botright", 2, FALSE},
+     {"browse", 3, FALSE},
+     {"confirm", 4, FALSE},
+     {"hide", 3, FALSE},
+     {"keepalt", 5, FALSE},
+     {"keepjumps", 5, FALSE},
+     {"keepmarks", 3, FALSE},
+     {"leftabove", 5, FALSE},
+     {"lockmarks", 3, FALSE},
+     {"rightbelow", 6, FALSE},
+     {"sandbox", 3, FALSE},
+     {"silent", 3, FALSE},
+     {"tab", 3, TRUE},
+     {"topleft", 2, FALSE},
+     {"verbose", 4, TRUE},
+     {"vertical", 4, FALSE},
+ };
+ 
+ /*
+  * Return length of a command modifier (including optional count).
+  * Return zero when it's not a modifier.
+  */
+     int
+ modifier_len(cmd)
+     char_u	*cmd;
+ {
+     int		i, j;
+     char_u	*p = cmd;
+ 
+     if (VIM_ISDIGIT(*cmd))
+ 	p = skipwhite(skipdigits(cmd));
+     for (i = 0; i < sizeof(cmdmods) / sizeof(struct cmdmod); ++i)
+     {
+ 	for (j = 0; p[j] != NUL; ++j)
+ 	    if (p[j] != cmdmods[i].name[j])
+ 		break;
+ 	if (!isalpha(p[j]) && j >= cmdmods[i].minlen
+ 					&& (p == cmd || cmdmods[i].has_count))
+ 	    return j + (p - cmd);
+     }
+     return 0;
+ }
+ 
  /*
   * Return > 0 if an Ex command "name" exists.
   * Return 2 if there is an exact match.
***************
*** 2977,3006 ****
      int		i;
      int		j;
      char_u	*p;
-     static struct cmdmod
-     {
- 	char	*name;
- 	int	minlen;
-     } cmdmods[] = {
- 	{"aboveleft", 3},
- 	{"belowright", 3},
- 	{"botright", 2},
- 	{"browse", 3},
- 	{"confirm", 4},
- 	{"hide", 3},
- 	{"keepalt", 5},
- 	{"keepjumps", 5},
- 	{"keepmarks", 3},
- 	{"leftabove", 5},
- 	{"lockmarks", 3},
- 	{"rightbelow", 6},
- 	{"sandbox", 3},
- 	{"silent", 3},
- 	{"tab", 3},
- 	{"topleft", 2},
- 	{"verbose", 4},
- 	{"vertical", 4},
-     };
  
      /* Check command modifiers. */
      for (i = 0; i < sizeof(cmdmods) / sizeof(struct cmdmod); ++i)
--- 3028,3033 ----
*** ../vim-7.1.161/src/ex_eval.c	Wed Aug  1 15:47:06 2007
--- src/ex_eval.c	Sat Nov 24 16:34:09 2007
***************
*** 2269,2277 ****
  has_loop_cmd(p)
      char_u	*p;
  {
!     p = skipwhite(p);
!     while (*p == ':')
! 	p = skipwhite(p + 1);
      if ((p[0] == 'w' && p[1] == 'h')
  	    || (p[0] == 'f' && p[1] == 'o' && p[2] == 'r'))
  	return TRUE;
--- 2269,2286 ----
  has_loop_cmd(p)
      char_u	*p;
  {
!     int		len;
! 
!     /* skip modifiers, white space and ':' */
!     for (;;)
!     {
! 	while (*p == ' ' || *p == '\t' || *p == ':')
! 	    ++p;
! 	len = modifier_len(p);
! 	if (len == 0)
! 	    break;
! 	p += len;
!     }
      if ((p[0] == 'w' && p[1] == 'h')
  	    || (p[0] == 'f' && p[1] == 'o' && p[2] == 'r'))
  	return TRUE;
*** ../vim-7.1.161/src/version.c	Sat Nov 24 21:27:33 2007
--- src/version.c	Sat Nov 24 21:48:38 2007
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     162,
  /**/

-- 
hundred-and-one symptoms of being an internet addict:
144. You eagerly await the update of the "Cool Site of the Day."

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: Patch 7.1.163
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.163
Problem:    Warning for the unknown option 'bufsecret'.
Solution:   Remove the lines .vim that use this option. (Andy Wokula)
Files:	    runtime/menu.vim


*** ../vim-7.1.162/runtime/menu.vim	Sun May  6 15:21:23 2007
--- runtime/menu.vim	Mon Nov 19 23:17:11 2007
***************
*** 2,8 ****
  " You can also use this as a start for your own set of menus.
  "
  " Maintainer:	Bram Moolenaar <Bram@vim.org>
! " Last Change:	2007 Jan 09
  
  " Note that ":an" (short for ":anoremenu") is often used to make a menu work
  " in all modes and avoid side effects from mappings defined by the user.
--- 2,8 ----
  " You can also use this as a start for your own set of menus.
  "
  " Maintainer:	Bram Moolenaar <Bram@vim.org>
! " Last Change:	2007 Nov 19
  
  " Note that ":an" (short for ":anoremenu") is often used to make a menu work
  " in all modes and avoid side effects from mappings defined by the user.
***************
*** 658,664 ****
    let buf = 1
    while buf <= bufnr('$')
      if bufexists(buf) && !isdirectory(bufname(buf)) && buflisted(buf)
- 					    \ && !getbufvar(buf, "&bufsecret")
        let s:bmenu_count = s:bmenu_count + 1
      endif
      let buf = buf + 1
--- 658,663 ----
***************
*** 671,677 ****
    let buf = 1
    while buf <= bufnr('$')
      if bufexists(buf) && !isdirectory(bufname(buf)) && buflisted(buf)
- 					    \ && !getbufvar(buf, "&bufsecret")
        call <SID>BMFilename(bufname(buf), buf)
      endif
      let buf = buf + 1
--- 670,675 ----
*** ../vim-7.1.162/src/version.c	Sat Nov 24 21:49:19 2007
--- src/version.c	Thu Nov 29 17:44:08 2007
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     163,
  /**/

-- 
hundred-and-one symptoms of being an internet addict:
158. You get a tuner card so you can watch TV while surfing.

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: Patch 7.1.164
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.164
Problem:    Reading past end of regexp pattern. (Dominique Pelle)
Solution:   Use utf_ptr2len().
Files:	    src/regexp.c


*** ../vim-7.1.163/src/regexp.c	Sat Aug 11 13:57:31 2007
--- src/regexp.c	Sat Nov 24 13:23:53 2007
***************
*** 2770,2776 ****
      {
  #ifdef FEAT_MBYTE
  	if (enc_utf8)
! 	    prevchr_len += utf_char2len(mb_ptr2char(regparse + prevchr_len));
  	else if (has_mbyte)
  	    prevchr_len += (*mb_ptr2len)(regparse + prevchr_len);
  	else
--- 2770,2777 ----
      {
  #ifdef FEAT_MBYTE
  	if (enc_utf8)
! 	    /* exclude composing chars that mb_ptr2len does include */
! 	    prevchr_len += utf_ptr2len(regparse + prevchr_len);
  	else if (has_mbyte)
  	    prevchr_len += (*mb_ptr2len)(regparse + prevchr_len);
  	else
*** ../vim-7.1.163/src/version.c	Thu Nov 29 17:46:01 2007
--- src/version.c	Thu Nov 29 21:25:45 2007
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     164,
  /**/

-- 
Send $25.00 for handy leaflet on how to make money by selling leaflets

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: Patch 7.1.165
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.165
Problem:    Crash related to getting X window ID. (Dominique Pelle)
Solution:   Don't trust the window ID that we got in the past, check it every
	    time.
Files:	    src/os_unix.c


*** ../vim-7.1.164/src/os_unix.c	Thu Aug 30 11:46:46 2007
--- src/os_unix.c	Thu Nov 29 18:19:56 2007
***************
*** 310,316 ****
  }
  
  /*
!  * mch_inchar(): low level input funcion.
   * Get a characters from the keyboard.
   * Return the number of characters that are available.
   * If wtime == 0 do not wait for characters.
--- 310,316 ----
  }
  
  /*
!  * mch_inchar(): low level input function.
   * Get a characters from the keyboard.
   * Return the number of characters that are available.
   * If wtime == 0 do not wait for characters.
***************
*** 1567,1584 ****
  #ifdef FEAT_XCLIPBOARD
      if (xterm_dpy != NULL && x11_window != 0)
      {
! 	/* Checked it already. */
! 	if (x11_display_from == XD_XTERM)
! 	    return OK;
! 
! 	/*
! 	 * If the X11 display was opened here before, for the window where Vim
! 	 * was started, close that one now to avoid a memory leak.
! 	 */
! 	if (x11_display_from == XD_HERE && x11_display != NULL)
! 	    XCloseDisplay(x11_display);
! 	x11_display = xterm_dpy;
! 	x11_display_from = XD_XTERM;
  	if (test_x11_window(x11_display) == FAIL)
  	{
  	    /* probably bad $WINDOWID */
--- 1567,1585 ----
  #ifdef FEAT_XCLIPBOARD
      if (xterm_dpy != NULL && x11_window != 0)
      {
! 	/* We may have checked it already, but Gnome terminal can move us to
! 	 * another window, so we need to check every time. */
! 	if (x11_display_from != XD_XTERM)
! 	{
! 	    /*
! 	     * If the X11 display was opened here before, for the window where
! 	     * Vim was started, close that one now to avoid a memory leak.
! 	     */
! 	    if (x11_display_from == XD_HERE && x11_display != NULL)
! 		XCloseDisplay(x11_display);
! 	    x11_display = xterm_dpy;
! 	    x11_display_from = XD_XTERM;
! 	}
  	if (test_x11_window(x11_display) == FAIL)
  	{
  	    /* probably bad $WINDOWID */
***************
*** 2421,2427 ****
  /*
   * Set the case of the file name, if it already exists.  This will cause the
   * file name to remain exactly the same.
!  * Only required for file systems where case is ingored and preserved.
   */
  /*ARGSUSED*/
      void
--- 2422,2428 ----
  /*
   * Set the case of the file name, if it already exists.  This will cause the
   * file name to remain exactly the same.
!  * Only required for file systems where case is ignored and preserved.
   */
  /*ARGSUSED*/
      void
***************
*** 4653,4659 ****
  	ret = poll(fds, nfd, towait);
  # ifdef FEAT_MZSCHEME
  	if (ret == 0 && mzquantum_used)
! 	    /* MzThreads scheduling is required and timeout occured */
  	    finished = FALSE;
  # endif
  
--- 4654,4660 ----
  	ret = poll(fds, nfd, towait);
  # ifdef FEAT_MZSCHEME
  	if (ret == 0 && mzquantum_used)
! 	    /* MzThreads scheduling is required and timeout occurred */
  	    finished = FALSE;
  # endif
  
***************
*** 4801,4807 ****
  #endif
  # ifdef FEAT_MZSCHEME
  	if (ret == 0 && mzquantum_used)
! 	    /* loop if MzThreads must be scheduled and timeout occured */
  	    finished = FALSE;
  # endif
  
--- 4802,4808 ----
  #endif
  # ifdef FEAT_MZSCHEME
  	if (ret == 0 && mzquantum_used)
! 	    /* loop if MzThreads must be scheduled and timeout occurred */
  	    finished = FALSE;
  # endif
  
***************
*** 5191,5197 ****
  	{
  	    /* When using system() always add extra quotes, because the shell
  	     * is started twice.  Otherwise put a backslash before special
! 	     * characters, except insice ``. */
  #ifdef USE_SYSTEM
  	    STRCAT(command, " \"");
  	    STRCAT(command, pat[i]);
--- 5192,5198 ----
  	{
  	    /* When using system() always add extra quotes, because the shell
  	     * is started twice.  Otherwise put a backslash before special
! 	     * characters, except inside ``. */
  #ifdef USE_SYSTEM
  	    STRCAT(command, " \"");
  	    STRCAT(command, pat[i]);
***************
*** 5675,5681 ****
  	    /* gpm library tries to handling TSTP causes
  	     * problems. Anyways, we close connection to Gpm whenever
  	     * we are going to suspend or starting an external process
! 	     * so we should'nt  have problem with this
  	     */
  	    signal(SIGTSTP, restricted ? SIG_IGN : SIG_DFL);
  	    return 1; /* succeed */
--- 5676,5682 ----
  	    /* gpm library tries to handling TSTP causes
  	     * problems. Anyways, we close connection to Gpm whenever
  	     * we are going to suspend or starting an external process
! 	     * so we shouldn't  have problem with this
  	     */
  	    signal(SIGTSTP, restricted ? SIG_IGN : SIG_DFL);
  	    return 1; /* succeed */
*** ../vim-7.1.164/src/version.c	Thu Nov 29 21:26:38 2007
--- src/version.c	Sat Dec  1 17:17:20 2007
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     165,
  /**/

-- 
"Hit any key to continue" is very confusing when you have two keyboards.

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: Patch 7.1.166
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.166
Problem:    Memory leak for using "gp" in Visual mode.
Solution:   Free memory in put_register(). (Dominique Pelle)
Files:	    src/ops.c


*** ../vim-7.1.165/src/ops.c	Thu Nov  8 10:35:02 2007
--- src/ops.c	Sun Nov 25 15:17:43 2007
***************
*** 927,934 ****
      int		name;
      int		copy;	/* make a copy, if FALSE make register empty. */
  {
!     static struct yankreg	*reg;
!     int				i;
  
  #ifdef FEAT_CLIPBOARD
      /* When Visual area changed, may have to update selection.  Obtain the
--- 927,934 ----
      int		name;
      int		copy;	/* make a copy, if FALSE make register empty. */
  {
!     struct yankreg	*reg;
!     int			i;
  
  #ifdef FEAT_CLIPBOARD
      /* When Visual area changed, may have to update selection.  Obtain the
***************
*** 967,973 ****
  }
  
  /*
!  * Put "reg" into register "name".  Free any previous contents.
   */
      void
  put_register(name, reg)
--- 967,973 ----
  }
  
  /*
!  * Put "reg" into register "name".  Free any previous contents and "reg".
   */
      void
  put_register(name, reg)
***************
*** 977,982 ****
--- 977,983 ----
      get_yank_register(name, 0);
      free_yank_all();
      *y_current = *(struct yankreg *)reg;
+     vim_free(reg);
  
  # ifdef FEAT_CLIPBOARD
      /* Send text written to clipboard register to the clipboard. */
*** ../vim-7.1.165/src/version.c	Sat Dec  1 17:18:45 2007
--- src/version.c	Sat Dec  1 21:11:25 2007
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     166,
  /**/

-- 
An error has occurred.  Hit any user to continue.

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: Patch 7.1.167
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.167
Problem:    Xxd crashes when using "xxd -b -c 110". (Debian bug 452789)
Solution:   Allocate more memory.  Fix check for maximum number of columns.
Files:	    src/xxd/xxd.c


*** ../vim-7.1.166/src/xxd/xxd.c	Thu May 10 19:07:42 2007
--- src/xxd/xxd.c	Thu Nov 29 21:05:16 2007
***************
*** 212,218 ****
  
  #define TRY_SEEK	/* attempt to use lseek, or skip forward by reading */
  #define COLS 256	/* change here, if you ever need more columns */
! #define LLEN (9 + (5*COLS-1)/2 + 2 + COLS)
  
  char hexxa[] = "0123456789abcdef0123456789ABCDEF", *hexx = hexxa;
  
--- 212,218 ----
  
  #define TRY_SEEK	/* attempt to use lseek, or skip forward by reading */
  #define COLS 256	/* change here, if you ever need more columns */
! #define LLEN (11 + (9*COLS-1)/1 + COLS + 2)
  
  char hexxa[] = "0123456789abcdef0123456789ABCDEF", *hexx = hexxa;
  
***************
*** 590,596 ****
        default:			octspergrp = 0; break;
        }
  
!   if (cols < 1 || (!hextype && (cols > COLS)))
      {
        fprintf(stderr, "%s: invalid number of columns (max. %d).\n", pname, COLS);
        exit(1);
--- 590,597 ----
        default:			octspergrp = 0; break;
        }
  
!   if (cols < 1 || ((hextype == HEX_NORMAL || hextype == HEX_BITS)
! 							    && (cols > COLS)))
      {
        fprintf(stderr, "%s: invalid number of columns (max. %d).\n", pname, COLS);
        exit(1);
***************
*** 750,755 ****
--- 751,757 ----
  	}
        if (ebcdic)
  	e = (e < 64) ? '.' : etoa64[e-64];
+       /* When changing this update definition of LLEN above. */
        l[11 + (grplen * cols - 1)/octspergrp + p] =
  #ifdef __MVS__
  	  (e >= 64)
*** ../vim-7.1.166/src/version.c	Sat Dec  1 21:12:23 2007
--- src/version.c	Mon Dec  3 21:30:31 2007
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     167,
  /**/

-- 
hundred-and-one symptoms of being an internet addict:
178. You look for an icon to double-click to open your bedroom window.

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: Patch 7.1.168 (extra)
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.168 (extra)
Problem:    Win32 GUI: Since patch 7.1.095, when the Vim window does not have
	    focus, clicking in it doesn't position the cursor. (Juergen
	    Kraemer)
Solution:   Don't reset s_button_pending just after receiving focus.
Files:	    src/gui_w48.c


*** ../vim-7.1.167/src/gui_w48.c	Tue Nov 20 17:21:28 2007
--- src/gui_w48.c	Mon Dec  3 22:13:16 2007
***************
*** 290,295 ****
--- 290,300 ----
  
  /* Local variables */
  static int		s_button_pending = -1;
+ 
+ /* s_getting_focus is set when we got focus but didn't see mouse-up event yet,
+  * so don't reset s_button_pending. */
+ static int		s_getting_focus = FALSE;
+ 
  static int		s_x_pending;
  static int		s_y_pending;
  static UINT		s_kFlags_pending;
***************
*** 671,676 ****
--- 676,683 ----
  {
      int vim_modifiers = 0x0;
  
+     s_getting_focus = FALSE;
+ 
      if (keyFlags & MK_SHIFT)
  	vim_modifiers |= MOUSE_SHIFT;
      if (keyFlags & MK_CONTROL)
***************
*** 792,797 ****
--- 799,805 ----
  {
      int button;
  
+     s_getting_focus = FALSE;
      if (s_button_pending > -1)
      {
  	/* Delayed action for mouse down event */
***************
*** 1951,1958 ****
  	    allow_scrollbar = FALSE;
  
  	    /* Clear pending mouse button, the release event may have been
! 	     * taken by the dialog window. */
! 	    s_button_pending = -1;
  
  	    return OK;
  	}
--- 1959,1968 ----
  	    allow_scrollbar = FALSE;
  
  	    /* Clear pending mouse button, the release event may have been
! 	     * taken by the dialog window.  But don't do this when getting
! 	     * focus, we need the mouse-up event then. */
! 	    if (!s_getting_focus)
! 		s_button_pending = -1;
  
  	    return OK;
  	}
***************
*** 2702,2707 ****
--- 2712,2718 ----
      HWND hwndOldFocus)
  {
      gui_focus_change(TRUE);
+     s_getting_focus = TRUE;
      (void)MyWindowProc(hwnd, WM_SETFOCUS, (WPARAM)hwndOldFocus, 0);
  }
  
***************
*** 2711,2716 ****
--- 2722,2728 ----
      HWND hwndNewFocus)
  {
      gui_focus_change(FALSE);
+     s_getting_focus = FALSE;
      (void)MyWindowProc(hwnd, WM_KILLFOCUS, (WPARAM)hwndNewFocus, 0);
  }
  
*** ../vim-7.1.167/src/version.c	Mon Dec  3 21:31:56 2007
--- src/version.c	Mon Dec  3 22:16:32 2007
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     168,
  /**/

-- 
Rule #1: Don't give somebody a tool that he's going to hurt himself with.

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: Patch 7.1.169
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.169
Problem:    Using uninitialized variable when system() fails. (Dominique
            Pelle)
Solution:   Let system() return an empty string when it fails.
Files:      src/eval.c


*** ../vim-7.1.168/src/eval.c	Thu Nov  8 20:47:34 2007
--- src/eval.c	Fri Nov 30 21:01:26 2007
***************
*** 15826,15832 ****
      FILE	*fd;
  
      if (check_restricted() || check_secure())
! 	return;
  
      if (argvars[1].v_type != VAR_UNKNOWN)
      {
--- 15826,15832 ----
      FILE	*fd;
  
      if (check_restricted() || check_secure())
! 	goto done;
  
      if (argvars[1].v_type != VAR_UNKNOWN)
      {
***************
*** 15837,15843 ****
  	if ((infile = vim_tempname('i')) == NULL)
  	{
  	    EMSG(_(e_notmp));
! 	    return;
  	}
  
  	fd = mch_fopen((char *)infile, WRITEBIN);
--- 15837,15843 ----
  	if ((infile = vim_tempname('i')) == NULL)
  	{
  	    EMSG(_(e_notmp));
! 	    goto done;
  	}
  
  	fd = mch_fopen((char *)infile, WRITEBIN);
*** ../vim-7.1.168/src/version.c	Mon Dec  3 22:20:17 2007
--- src/version.c	Fri Dec  7 17:07:32 2007
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     169,
  /**/

-- 
% cat /usr/include/sys/errno.h
#define	EPERM		1		/* Operation not permitted */
#define	ENOENT		2		/* No such file or directory */
#define	ESRCH		3		/* No such process */
[...]
#define EMACS		666		/* Too many macros */
%

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: Patch 7.1.170
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.170
Problem:    Valgrind warning for overlapping arguments for strcpy().
Solution:   Use mch_memmove() instead. (Dominique Pelle)
Files:	    src/getchar.c


*** ../vim-7.1.169/src/getchar.c	Thu Sep 13 18:25:08 2007
--- src/getchar.c	Mon Dec  3 20:42:29 2007
***************
*** 253,260 ****
  	return;
      }
      else if (buf->bh_index != 0)
! 	STRCPY(buf->bh_first.b_next->b_str,
! 				 buf->bh_first.b_next->b_str + buf->bh_index);
      buf->bh_index = 0;
  
      if (buf->bh_space >= (int)slen)
--- 253,261 ----
  	return;
      }
      else if (buf->bh_index != 0)
! 	mch_memmove(buf->bh_first.b_next->b_str,
! 		    buf->bh_first.b_next->b_str + buf->bh_index,
! 		    STRLEN(buf->bh_first.b_next->b_str + buf->bh_index) + 1);
      buf->bh_index = 0;
  
      if (buf->bh_space >= (int)slen)
*** ../vim-7.1.169/src/version.c	Fri Dec  7 17:08:35 2007
--- src/version.c	Fri Dec  7 17:27:13 2007
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     170,
  /**/

-- 
Some of the well know MS-Windows errors:
	ESLEEP		Operator fell asleep
	ENOERR		No error yet
	EDOLLAR		OS too expensive
	EWINDOWS	MS-Windows loaded, system in danger

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: Patch 7.1.171
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.171
Problem:    Reading one byte before allocated memory.
Solution:   Check index not to become negative. (Dominique Pelle)
Files:	    src/ex_getln.c


*** ../vim-7.1.170/src/ex_getln.c	Tue Oct 30 17:36:31 2007
--- src/ex_getln.c	Tue Dec  4 21:49:24 2007
***************
*** 1186,1195 ****
  	case K_LEFT:
  	case K_S_LEFT:
  	case K_C_LEFT:
  		do
  		{
- 		    if (ccline.cmdpos == 0)
- 			break;
  		    --ccline.cmdpos;
  #ifdef FEAT_MBYTE
  		    if (has_mbyte)	/* move to first byte of char */
--- 1186,1195 ----
  	case K_LEFT:
  	case K_S_LEFT:
  	case K_C_LEFT:
+ 		if (ccline.cmdpos == 0)
+ 		    goto cmdline_not_changed;
  		do
  		{
  		    --ccline.cmdpos;
  #ifdef FEAT_MBYTE
  		    if (has_mbyte)	/* move to first byte of char */
***************
*** 1198,1204 ****
  #endif
  		    ccline.cmdspos -= cmdline_charsize(ccline.cmdpos);
  		}
! 		while ((c == K_S_LEFT || c == K_C_LEFT
  			       || (mod_mask & (MOD_MASK_SHIFT|MOD_MASK_CTRL)))
  			&& ccline.cmdbuff[ccline.cmdpos - 1] != ' ');
  #ifdef FEAT_MBYTE
--- 1198,1205 ----
  #endif
  		    ccline.cmdspos -= cmdline_charsize(ccline.cmdpos);
  		}
! 		while (ccline.cmdpos > 0
! 			&& (c == K_S_LEFT || c == K_C_LEFT
  			       || (mod_mask & (MOD_MASK_SHIFT|MOD_MASK_CTRL)))
  			&& ccline.cmdbuff[ccline.cmdpos - 1] != ' ');
  #ifdef FEAT_MBYTE
*** ../vim-7.1.170/src/version.c	Fri Dec  7 17:30:04 2007
--- src/version.c	Fri Dec  7 20:00:06 2007
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     171,
  /**/

-- 
Some of the well know MS-Windows errors:
	EMULTI		Multitasking attempted, system confused
	EKEYBOARD	Keyboard locked, try getting out of this one!
	EXPLAIN		Unexplained error, please tell us what happened
	EFUTURE		Reserved for our future mistakes

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: Patch 7.1.172
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.172
Problem:    When 'buftype' is "acwrite" Vim still checks if the file or
	    directory exists before overwriting.
Solution:   Don't check for overwriting when the buffer name is not a file
	    name.
Files:	    src/ex_cmds.c


*** ../vim-7.1.171/src/ex_cmds.c	Tue Nov 20 18:03:34 2007
--- src/ex_cmds.c	Fri Dec  7 22:13:32 2007
***************
*** 2732,2737 ****
--- 2732,2740 ----
  		    && vim_strchr(p_cpo, CPO_OVERNEW) == NULL)
  		|| (buf->b_flags & BF_READERR))
  	    && !p_wa
+ #ifdef FEAT_QUICKFIX
+ 	    && !bt_nofile(buf)
+ #endif
  	    && vim_fexists(ffname))
      {
  	if (!eap->forceit && !eap->append)
*** ../vim-7.1.171/src/version.c	Fri Dec  7 20:28:13 2007
--- src/version.c	Sat Dec  8 22:18:54 2007
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     172,
  /**/

-- 
hundred-and-one symptoms of being an internet addict:
206. You religiously respond immediately to e-mail, while ignoring
     your growing pile of snail mail.

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: Patch 7.1.173
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.173
Problem:    Accessing freed memory. (Dominique Pelle)
Solution:   Don't call reg_getline() to check if a line is the first in the
	    file.
Files:	    src/regexp.c


*** ../vim-7.1.172/src/regexp.c	Thu Nov 29 21:26:38 2007
--- src/regexp.c	Sat Dec  8 15:54:05 2007
***************
*** 3810,3820 ****
  	    break;
  
  	  case RE_BOF:
! 	    /* Passing -1 to the getline() function provided for the search
! 	     * should always return NULL if the current line is the first
! 	     * line of the file. */
  	    if (reglnum != 0 || reginput != regline
! 			|| (REG_MULTI && reg_getline((linenr_T)-1) != NULL))
  		status = RA_NOMATCH;
  	    break;
  
--- 3810,3820 ----
  	    break;
  
  	  case RE_BOF:
! 	    /* We're not at the beginning of the file when below the first
! 	     * line where we started, not at the start of the line or we
! 	     * didn't start at the first line of the buffer. */
  	    if (reglnum != 0 || reginput != regline
! 					  || (REG_MULTI && reg_firstlnum > 1))
  		status = RA_NOMATCH;
  	    break;
  
*** ../vim-7.1.172/src/version.c	Sat Dec  8 22:20:24 2007
--- src/version.c	Sun Dec  9 19:24:36 2007
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     173,
  /**/

-- 
hundred-and-one symptoms of being an internet addict:
213. Your kids start referring to you as "that guy in front of the monitor."

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: Patch 7.1.174
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.174
Problem:    Writing NUL past end of a buffer.
Solution:   Copy one byte less when using strncat(). (Dominuque Pelle)
Files:	    src/ex_cmds.c, src/ex_docmd.c


*** ../vim-7.1.173/src/ex_cmds.c	Sat Dec  8 22:20:24 2007
--- src/ex_cmds.c	Fri Dec  7 22:13:32 2007
***************
*** 1650,1656 ****
  {
      vim_snprintf((char *)IObuff, IOSIZE, _("%sviminfo: %s in line: "),
  							     errnum, message);
!     STRNCAT(IObuff, line, IOSIZE - STRLEN(IObuff));
      if (IObuff[STRLEN(IObuff) - 1] == '\n')
  	IObuff[STRLEN(IObuff) - 1] = NUL;
      emsg(IObuff);
--- 1650,1656 ----
  {
      vim_snprintf((char *)IObuff, IOSIZE, _("%sviminfo: %s in line: "),
  							     errnum, message);
!     STRNCAT(IObuff, line, IOSIZE - STRLEN(IObuff) - 1);
      if (IObuff[STRLEN(IObuff) - 1] == '\n')
  	IObuff[STRLEN(IObuff) - 1] = NUL;
      emsg(IObuff);
*** ../vim-7.1.173/src/ex_docmd.c	Sat Nov 24 21:49:19 2007
--- src/ex_docmd.c	Fri Dec  7 21:01:03 2007
***************
*** 2660,2666 ****
  		errormsg = IObuff;
  	    }
  	    STRCAT(errormsg, ": ");
! 	    STRNCAT(errormsg, *cmdlinep, IOSIZE - STRLEN(IObuff));
  	}
  	emsg(errormsg);
      }
--- 2660,2666 ----
  		errormsg = IObuff;
  	    }
  	    STRCAT(errormsg, ": ");
! 	    STRNCAT(errormsg, *cmdlinep, IOSIZE - STRLEN(IObuff) - 1);
  	}
  	emsg(errormsg);
      }
*** ../vim-7.1.173/src/version.c	Sun Dec  9 19:25:35 2007
--- src/version.c	Sun Dec  9 19:36:50 2007
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     174,
  /**/

-- 
hundred-and-one symptoms of being an internet addict:
214. Your MCI "Circle of Friends" are all Hayes-compatible.

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: Patch 7.1.175
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.175
Problem:    <BS> doesn't work with some combination of 'sts', 'linebreak' and
	    'backspace'. (Francois Ingelrest)
Solution:   When adding white space results in not moving back delete one
	    character.
Files:	    src/edit.c


*** ../vim-7.1.174/src/edit.c	Sat Nov 24 21:27:33 2007
--- src/edit.c	Fri Dec  7 21:32:48 2007
***************
*** 8189,8194 ****
--- 8189,8217 ----
      AppendCharToRedobuff(K_DEL);
  }
  
+ static void ins_bs_one __ARGS((colnr_T *vcolp));
+ 
+ /*
+  * Delete one character for ins_bs().
+  */
+     static void
+ ins_bs_one(vcolp)
+     colnr_T	*vcolp;
+ {
+     dec_cursor();
+     getvcol(curwin, &curwin->w_cursor, vcolp, NULL, NULL);
+     if (State & REPLACE_FLAG)
+     {
+ 	/* Don't delete characters before the insert point when in
+ 	 * Replace mode */
+ 	if (curwin->w_cursor.lnum != Insstart.lnum
+ 		|| curwin->w_cursor.col >= Insstart.col)
+ 	    replace_do_bs();
+     }
+     else
+ 	(void)del_char(FALSE);
+ }
+ 
  /*
   * Handle Backspace, delete-word and delete-line in Insert mode.
   * Return TRUE when backspace was actually used.
***************
*** 8418,8426 ****
  	    int		ts;
  	    colnr_T	vcol;
  	    colnr_T	want_vcol;
! #if 0
! 	    int		extra = 0;
! #endif
  
  	    *inserted_space_p = FALSE;
  	    if (p_sta && in_indent)
--- 8441,8447 ----
  	    int		ts;
  	    colnr_T	vcol;
  	    colnr_T	want_vcol;
! 	    colnr_T	start_vcol;
  
  	    *inserted_space_p = FALSE;
  	    if (p_sta && in_indent)
***************
*** 8431,8436 ****
--- 8452,8458 ----
  	     * 'showbreak' may get in the way, need to get the last column of
  	     * the previous character. */
  	    getvcol(curwin, &curwin->w_cursor, &vcol, NULL, NULL);
+ 	    start_vcol = vcol;
  	    dec_cursor();
  	    getvcol(curwin, &curwin->w_cursor, NULL, NULL, &want_vcol);
  	    inc_cursor();
***************
*** 8439,8468 ****
  	    /* delete characters until we are at or before want_vcol */
  	    while (vcol > want_vcol
  		    && (cc = *(ml_get_cursor() - 1), vim_iswhite(cc)))
! 	    {
! 		dec_cursor();
! 		getvcol(curwin, &curwin->w_cursor, &vcol, NULL, NULL);
! 		if (State & REPLACE_FLAG)
! 		{
! 		    /* Don't delete characters before the insert point when in
! 		     * Replace mode */
! 		    if (curwin->w_cursor.lnum != Insstart.lnum
! 			    || curwin->w_cursor.col >= Insstart.col)
! 		    {
! #if 0	/* what was this for?  It causes problems when sw != ts. */
! 			if (State == REPLACE && (int)vcol < want_vcol)
! 			{
! 			    (void)del_char(FALSE);
! 			    extra = 2;	/* don't pop too much */
! 			}
! 			else
! #endif
! 			    replace_do_bs();
! 		    }
! 		}
! 		else
! 		    (void)del_char(FALSE);
! 	    }
  
  	    /* insert extra spaces until we are at want_vcol */
  	    while (vcol < want_vcol)
--- 8461,8467 ----
  	    /* delete characters until we are at or before want_vcol */
  	    while (vcol > want_vcol
  		    && (cc = *(ml_get_cursor() - 1), vim_iswhite(cc)))
! 		ins_bs_one(&vcol);
  
  	    /* insert extra spaces until we are at want_vcol */
  	    while (vcol < want_vcol)
***************
*** 8479,8500 ****
  #endif
  		{
  		    ins_str((char_u *)" ");
! 		    if ((State & REPLACE_FLAG) /* && extra <= 1 */)
! 		    {
! #if 0
! 			if (extra)
! 			    replace_push_off(NUL);
! 			else
! #endif
! 			    replace_push(NUL);
! 		    }
! #if 0
! 		    if (extra == 2)
! 			extra = 1;
! #endif
  		}
  		getvcol(curwin, &curwin->w_cursor, &vcol, NULL, NULL);
  	    }
  	}
  
  	/*
--- 8478,8493 ----
  #endif
  		{
  		    ins_str((char_u *)" ");
! 		    if ((State & REPLACE_FLAG))
! 			replace_push(NUL);
  		}
  		getvcol(curwin, &curwin->w_cursor, &vcol, NULL, NULL);
  	    }
+ 
+ 	    /* If we are now back where we started delete one character.  Can
+ 	     * happen when using 'sts' and 'linebreak'. */
+ 	    if (vcol >= start_vcol)
+ 		ins_bs_one(&vcol);
  	}
  
  	/*
*** ../vim-7.1.174/src/version.c	Sun Dec  9 19:37:37 2007
--- src/version.c	Sun Dec  9 20:24:11 2007
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     175,
  /**/

-- 
hundred-and-one symptoms of being an internet addict:
215. Your mouse-clicking forearm rivals Popeye's.

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: Patch 7.1.176
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.176
Problem:    Building with Aap fails when the "compiledby" argument contains
	    '<' or '>' characters. (Alex Yeh)
Solution:   Change how quoting is done in the Aap recipe.
Files:	    src/main.aap


*** ../vim-7.1.175/src/main.aap	Tue Sep 25 22:13:14 2007
--- src/main.aap	Fri Dec  7 17:03:31 2007
***************
*** 63,70 ****
          @else:
          @   arch = "ppc"
          :print Building for $arch system
          :sys CONFIG_STATUS=auto/config.status
!                 ./configure.aap `file2string("config.arg")`
                      --with-mac-arch=$arch
                      --cache-file=auto/config.cache
  
--- 63,71 ----
          @else:
          @   arch = "ppc"
          :print Building for $arch system
+         config_args = `file2string("config.arg")`
          :sys CONFIG_STATUS=auto/config.status
!                 ./configure.aap $config_args
                      --with-mac-arch=$arch
                      --cache-file=auto/config.cache
  
***************
*** 440,450 ****
          :print >> $target char_u *all_lflags = (char_u *)"$linkcmd";
          @if _no.get("COMPILEDBY"):
              who = $COMPILEDBY
!             where = ''
          @else:
              :syseval whoami | :eval re.sub("\n", "", stdin) | :assign who
  
              :syseval hostname | :eval re.sub("\n", "", stdin) | :assign where
          :print >> $target char_u *compiled_user = (char_u *)"$who";
          :print >> $target char_u *compiled_sys = (char_u *)"$where";
  
--- 441,453 ----
          :print >> $target char_u *all_lflags = (char_u *)"$linkcmd";
          @if _no.get("COMPILEDBY"):
              who = $COMPILEDBY
!             where =
          @else:
              :syseval whoami | :eval re.sub("\n", "", stdin) | :assign who
  
              :syseval hostname | :eval re.sub("\n", "", stdin) | :assign where
+         @who = string.replace(who, '"', '\\"')
+         @where = string.replace(where, '"', '\\"')
          :print >> $target char_u *compiled_user = (char_u *)"$who";
          :print >> $target char_u *compiled_sys = (char_u *)"$where";
  
*** ../vim-7.1.175/src/version.c	Sun Dec  9 20:25:59 2007
--- src/version.c	Mon Dec 31 16:40:01 2007
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     176,
  /**/

-- 
E  M  A  C  S
s  e  l  o  h
c  t  t  n  i
a  a     t  f
p        r  t
e        o
         l

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: Patch 7.1.177
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.177
Problem:    Freeing memory twice when in debug mode while reading a script.
Solution:   Ignore script input while in debug mode.
Files:	    src/ex_cmds2.c, src/getchar.c, src/globals.h


*** ../vim-7.1.176/src/ex_cmds2.c	Thu May 10 20:55:46 2007
--- src/ex_cmds2.c	Tue Jan  1 14:13:41 2008
***************
*** 93,98 ****
--- 93,100 ----
      int		save_emsg_silent = emsg_silent;
      int		save_redir_off = redir_off;
      tasave_T	typeaheadbuf;
+     int		typeahead_saved = FALSE;
+     int		save_ignore_script;
  # ifdef FEAT_EX_EXTRA
      int		save_ex_normal_busy;
  # endif
***************
*** 159,176 ****
  	 * This makes sure we get input from the user here and don't interfere
  	 * with the commands being executed.  Reset "ex_normal_busy" to avoid
  	 * the side effects of using ":normal". Save the stuff buffer and make
! 	 * it empty. */
  # ifdef FEAT_EX_EXTRA
  	save_ex_normal_busy = ex_normal_busy;
  	ex_normal_busy = 0;
  # endif
  	if (!debug_greedy)
  	    save_typeahead(&typeaheadbuf);
  
  	cmdline = getcmdline_prompt('>', NULL, 0, EXPAND_NOTHING, NULL);
  
! 	if (!debug_greedy)
  	    restore_typeahead(&typeaheadbuf);
  # ifdef FEAT_EX_EXTRA
  	ex_normal_busy = save_ex_normal_busy;
  # endif
--- 161,186 ----
  	 * This makes sure we get input from the user here and don't interfere
  	 * with the commands being executed.  Reset "ex_normal_busy" to avoid
  	 * the side effects of using ":normal". Save the stuff buffer and make
! 	 * it empty. Set ignore_script to avoid reading from script input. */
  # ifdef FEAT_EX_EXTRA
  	save_ex_normal_busy = ex_normal_busy;
  	ex_normal_busy = 0;
  # endif
  	if (!debug_greedy)
+ 	{
  	    save_typeahead(&typeaheadbuf);
+ 	    typeahead_saved = TRUE;
+ 	    save_ignore_script = ignore_script;
+ 	    ignore_script = TRUE;
+ 	}
  
  	cmdline = getcmdline_prompt('>', NULL, 0, EXPAND_NOTHING, NULL);
  
! 	if (typeahead_saved)
! 	{
  	    restore_typeahead(&typeaheadbuf);
+ 	    ignore_script = save_ignore_script;
+ 	}
  # ifdef FEAT_EX_EXTRA
  	ex_normal_busy = save_ex_normal_busy;
  # endif
*** ../vim-7.1.176/src/getchar.c	Fri Dec  7 17:30:04 2007
--- src/getchar.c	Tue Jan  1 14:11:42 2008
***************
*** 1279,1286 ****
      void
  free_typebuf()
  {
!     vim_free(typebuf.tb_buf);
!     vim_free(typebuf.tb_noremap);
  }
  
  /*
--- 1279,1292 ----
      void
  free_typebuf()
  {
!     if (typebuf.tb_buf == typebuf_init)
! 	EMSG2(_(e_intern2), "Free typebuf 1");
!     else
! 	vim_free(typebuf.tb_buf);
!     if (typebuf.tb_buf == noremapbuf_init)
! 	EMSG2(_(e_intern2), "Free typebuf 2");
!     else
! 	vim_free(typebuf.tb_noremap);
  }
  
  /*
***************
*** 1359,1364 ****
--- 1365,1375 ----
  	EMSG(_(e_nesting));
  	return;
      }
+ #ifdef FEAT_EVAL
+     if (ignore_script)
+ 	/* Not reading from script, also don't open one.  Warning message? */
+ 	return;
+ #endif
  
      if (scriptin[curscript] != NULL)	/* already reading script */
  	++curscript;
***************
*** 2346,2352 ****
  						   current_menu->silent[idx]);
  				}
  			    }
! #endif /* FEAT_GUI */
  			    continue;	/* try mapping again */
  			}
  
--- 2357,2363 ----
  						   current_menu->silent[idx]);
  				}
  			    }
! #endif /* FEAT_GUI && FEAT_MENU */
  			    continue;	/* try mapping again */
  			}
  
***************
*** 2862,2872 ****
      undo_off = FALSE;		    /* restart undo now */
  
      /*
!      * first try script file
!      *	If interrupted: Stop reading script files.
       */
      script_char = -1;
!     while (scriptin[curscript] != NULL && script_char < 0)
      {
  	if (got_int || (script_char = getc(scriptin[curscript])) < 0)
  	{
--- 2873,2887 ----
      undo_off = FALSE;		    /* restart undo now */
  
      /*
!      * Get a character from a script file if there is one.
!      * If interrupted: Stop reading script files, close them all.
       */
      script_char = -1;
!     while (scriptin[curscript] != NULL && script_char < 0
! #ifdef FEAT_EVAL
! 	    && !ignore_script
! #endif
! 	    )
      {
  	if (got_int || (script_char = getc(scriptin[curscript])) < 0)
  	{
*** ../vim-7.1.176/src/globals.h	Sat Sep 29 14:15:00 2007
--- src/globals.h	Mon Dec 31 17:00:21 2007
***************
*** 954,959 ****
--- 954,962 ----
  EXTERN int	ex_normal_busy INIT(= 0); /* recursiveness of ex_normal() */
  EXTERN int	ex_normal_lock INIT(= 0); /* forbid use of ex_normal() */
  #endif
+ #ifdef FEAT_EVAL
+ EXTERN int	ignore_script INIT(= FALSE);  /* ignore script input */
+ #endif
  EXTERN int	stop_insert_mode;	/* for ":stopinsert" and 'insertmode' */
  
  EXTERN int	KeyTyped;		/* TRUE if user typed current char */
*** ../vim-7.1.176/src/version.c	Mon Dec 31 16:41:31 2007
--- src/version.c	Tue Jan  1 14:00:09 2008
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     177,
  /**/

-- 
Back up my hard drive?  I can't find the reverse switch!

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: Patch 7.1.178
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.178
Problem:    "%" doesn't work on "/* comment *//* comment */".
Solution:   Don't handle the "//" in "*//*" as a C++ comment. (Markus
	    Heidelberg)
Files:	    src/search.c


*** ../vim-7.1.177/src/search.c	Wed Aug  8 22:48:16 2007
--- src/search.c	Mon Dec 10 21:21:17 2007
***************
*** 2319,2325 ****
  #endif
      while ((p = vim_strchr(p, '/')) != NULL)
      {
! 	if (p[1] == '/')
  	    break;
  	++p;
      }
--- 2319,2327 ----
  #endif
      while ((p = vim_strchr(p, '/')) != NULL)
      {
! 	/* accept a double /, unless it's preceded with * and followed by *,
! 	 * because * / / * is an end and start of a C comment */
! 	if (p[1] == '/' && (p == line || p[-1] != '*' || p[2] != '*'))
  	    break;
  	++p;
      }
*** ../vim-7.1.177/src/version.c	Tue Jan  1 14:16:42 2008
--- src/version.c	Tue Jan  1 15:41:33 2008
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     178,
  /**/

-- 
I'd like to meet the man who invented sex and see what he's working on now.

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: Patch 7.1.179
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.179
Problem:    Need to check for TCL 8.5.
Solution:   Adjust configure script. (Alexey Froloff)
Files:	    src/configure.in, src/auto/configure


*** ../vim-7.1.178/src/configure.in	Sun Nov  4 15:35:23 2007
--- src/configure.in	Sun Dec 30 13:55:28 2007
***************
*** 759,773 ****
  
  if test "$enable_tclinterp" = "yes"; then
  
!   dnl on FreeBSD tclsh is a silly script, look for tclsh8.[420]
    AC_MSG_CHECKING(--with-tclsh argument)
    AC_ARG_WITH(tclsh, [  --with-tclsh=PATH       which tclsh to use (default: tclsh8.0)],
  	tclsh_name="$withval"; AC_MSG_RESULT($tclsh_name),
! 	tclsh_name="tclsh8.4"; AC_MSG_RESULT(no))
    AC_PATH_PROG(vi_cv_path_tcl, $tclsh_name)
    AC_SUBST(vi_cv_path_tcl)
  
!   dnl when no specific version specified, also try 8.2 and 8.0
    if test "X$vi_cv_path_tcl" = "X" -a $tclsh_name = "tclsh8.4"; then
      tclsh_name="tclsh8.2"
      AC_PATH_PROG(vi_cv_path_tcl, $tclsh_name)
--- 759,777 ----
  
  if test "$enable_tclinterp" = "yes"; then
  
!   dnl on FreeBSD tclsh is a silly script, look for tclsh8.[5420]
    AC_MSG_CHECKING(--with-tclsh argument)
    AC_ARG_WITH(tclsh, [  --with-tclsh=PATH       which tclsh to use (default: tclsh8.0)],
  	tclsh_name="$withval"; AC_MSG_RESULT($tclsh_name),
! 	tclsh_name="tclsh8.5"; AC_MSG_RESULT(no))
    AC_PATH_PROG(vi_cv_path_tcl, $tclsh_name)
    AC_SUBST(vi_cv_path_tcl)
  
!   dnl when no specific version specified, also try 8.4, 8.2 and 8.0
!   if test "X$vi_cv_path_tcl" = "X" -a $tclsh_name = "tclsh8.5"; then
!     tclsh_name="tclsh8.4"
!     AC_PATH_PROG(vi_cv_path_tcl, $tclsh_name)
!   fi
    if test "X$vi_cv_path_tcl" = "X" -a $tclsh_name = "tclsh8.4"; then
      tclsh_name="tclsh8.2"
      AC_PATH_PROG(vi_cv_path_tcl, $tclsh_name)
***************
*** 810,815 ****
--- 814,820 ----
  	AC_MSG_CHECKING(for location of tclConfig.sh script)
  	if test "x$MACOSX" != "xyes"; then
  	  tclcnf=`echo $tclinc | sed s/include/lib/g`
+ 	  tclcnf="$tclcnf `echo $tclinc | sed s/include/lib64/g`"
  	else
  	  dnl For Mac OS X 10.3, use the OS-provided framework location
  	  tclcnf="/System/Library/Frameworks/Tcl.framework"
***************
*** 830,835 ****
--- 835,841 ----
  	  AC_MSG_RESULT(<not found>)
  	  AC_MSG_CHECKING(for Tcl library by myself)
  	  tcllib=`echo $tclinc | sed s/include/lib/g`
+ 	  tcllib="$tcllib `echo $tclinc | sed s/include/lib64/g`"
  	  for ext in .so .a ; do
  	    for ver in "" $tclver ; do
  	      for try in $tcllib ; do
*** ../vim-7.1.178/src/auto/configure	Sun Nov  4 15:35:23 2007
--- src/auto/configure	Sun Dec 30 13:55:35 2007
***************
*** 4445,4451 ****
    tclsh_name="$withval"; echo "$as_me:$LINENO: result: $tclsh_name" >&5
  echo "${ECHO_T}$tclsh_name" >&6
  else
!   tclsh_name="tclsh8.4"; echo "$as_me:$LINENO: result: no" >&5
  echo "${ECHO_T}no" >&6
  fi;
    # Extract the first word of "$tclsh_name", so it can be a program name with args.
--- 4445,4451 ----
    tclsh_name="$withval"; echo "$as_me:$LINENO: result: $tclsh_name" >&5
  echo "${ECHO_T}$tclsh_name" >&6
  else
!   tclsh_name="tclsh8.5"; echo "$as_me:$LINENO: result: no" >&5
  echo "${ECHO_T}no" >&6
  fi;
    # Extract the first word of "$tclsh_name", so it can be a program name with args.
***************
*** 4489,4495 ****
  
  
  
!     if test "X$vi_cv_path_tcl" = "X" -a $tclsh_name = "tclsh8.4"; then
      tclsh_name="tclsh8.2"
      # Extract the first word of "$tclsh_name", so it can be a program name with args.
  set dummy $tclsh_name; ac_word=$2
--- 4489,4537 ----
  
  
  
!     if test "X$vi_cv_path_tcl" = "X" -a $tclsh_name = "tclsh8.5"; then
!     tclsh_name="tclsh8.4"
!     # Extract the first word of "$tclsh_name", so it can be a program name with args.
! set dummy $tclsh_name; ac_word=$2
! echo "$as_me:$LINENO: checking for $ac_word" >&5
! echo $ECHO_N "checking for $ac_word... $ECHO_C" >&6
! if test "${ac_cv_path_vi_cv_path_tcl+set}" = set; then
!   echo $ECHO_N "(cached) $ECHO_C" >&6
! else
!   case $vi_cv_path_tcl in
!   [\\/]* | ?:[\\/]*)
!   ac_cv_path_vi_cv_path_tcl="$vi_cv_path_tcl" # Let the user override the test with a path.
!   ;;
!   *)
!   as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
! for as_dir in $PATH
! do
!   IFS=$as_save_IFS
!   test -z "$as_dir" && as_dir=.
!   for ac_exec_ext in '' $ac_executable_extensions; do
!   if $as_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
!     ac_cv_path_vi_cv_path_tcl="$as_dir/$ac_word$ac_exec_ext"
!     echo "$as_me:$LINENO: found $as_dir/$ac_word$ac_exec_ext" >&5
!     break 2
!   fi
! done
! done
! 
!   ;;
! esac
! fi
! vi_cv_path_tcl=$ac_cv_path_vi_cv_path_tcl
! 
! if test -n "$vi_cv_path_tcl"; then
!   echo "$as_me:$LINENO: result: $vi_cv_path_tcl" >&5
! echo "${ECHO_T}$vi_cv_path_tcl" >&6
! else
!   echo "$as_me:$LINENO: result: no" >&5
! echo "${ECHO_T}no" >&6
! fi
! 
!   fi
!   if test "X$vi_cv_path_tcl" = "X" -a $tclsh_name = "tclsh8.4"; then
      tclsh_name="tclsh8.2"
      # Extract the first word of "$tclsh_name", so it can be a program name with args.
  set dummy $tclsh_name; ac_word=$2
***************
*** 4649,4654 ****
--- 4691,4697 ----
  echo $ECHO_N "checking for location of tclConfig.sh script... $ECHO_C" >&6
  	if test "x$MACOSX" != "xyes"; then
  	  tclcnf=`echo $tclinc | sed s/include/lib/g`
+ 	  tclcnf="$tclcnf `echo $tclinc | sed s/include/lib64/g`"
  	else
  	  	  tclcnf="/System/Library/Frameworks/Tcl.framework"
  	fi
***************
*** 4668,4673 ****
--- 4711,4717 ----
  	  echo "$as_me:$LINENO: checking for Tcl library by myself" >&5
  echo $ECHO_N "checking for Tcl library by myself... $ECHO_C" >&6
  	  tcllib=`echo $tclinc | sed s/include/lib/g`
+ 	  tcllib="$tcllib `echo $tclinc | sed s/include/lib64/g`"
  	  for ext in .so .a ; do
  	    for ver in "" $tclver ; do
  	      for try in $tcllib ; do
*** ../vim-7.1.178/src/version.c	Tue Jan  1 15:42:45 2008
--- src/version.c	Tue Jan  1 16:24:07 2008
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     179,
  /**/

-- 
Just think of all the things we haven't thought of yet.

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: Patch 7.1.180
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.180
Problem:    Regexp patterns not tested sufficiently.
Solution:   Add more checks to the regexp test.
Files:	    src/testdir/test64.in, src/testdir/test64.ok


*** ../vim-7.1.179/src/testdir/test64.in	Tue Sep 25 17:54:41 2007
--- src/testdir/test64.in	Mon Dec 31 14:20:23 2007
***************
*** 14,23 ****
--- 14,136 ----
  :"    etc.
  :"  When there is no match use only the first two items.
  :let tl = []
+ :call add(tl, ['ab', 'aab', 'ab'])
  :call add(tl, ['b', 'abcdef', 'b'])
  :call add(tl, ['bc*', 'abccccdef', 'bcccc'])
  :call add(tl, ['bc\{-}', 'abccccdef', 'b'])
  :call add(tl, ['bc\{-}\(d\)', 'abccccdef', 'bccccd', 'd'])
+ :call add(tl, ['bc*', 'abbdef', 'b'])
+ :call add(tl, ['c*', 'ccc', 'ccc'])
+ :call add(tl, ['bc*', 'abdef', 'b'])
+ :call add(tl, ['c*', 'abdef', ''])
+ :call add(tl, ['bc\+', 'abccccdef', 'bcccc'])
+ :call add(tl, ['bc\+', 'abdef']) "no match
+ :"
+ :"operator \|
+ :call add(tl, ['a\|ab', 'cabd', 'a']) "alternation is ordered
+ :"
+ :call add(tl, ['c\?', 'ccb', 'c'])
+ :call add(tl, ['bc\?', 'abd', 'b'])
+ :call add(tl, ['bc\?', 'abccd', 'bc'])
+ :"
+ :call add(tl, ['\va{1}', 'ab', 'a'])
+ :"
+ :call add(tl, ['\va{2}', 'aa', 'aa'])
+ :call add(tl, ['\va{2}', 'caad', 'aa'])
+ :call add(tl, ['\va{2}', 'aba'])
+ :call add(tl, ['\va{2}', 'ab'])
+ :call add(tl, ['\va{2}', 'abaa', 'aa'])
+ :call add(tl, ['\va{2}', 'aaa', 'aa'])
+ :"
+ :call add(tl, ['\vb{1}', 'abca', 'b'])
+ :call add(tl, ['\vba{2}', 'abaa', 'baa'])
+ :call add(tl, ['\vba{3}', 'aabaac'])
+ :"
+ :call add(tl, ['\v(ab){1}', 'ab', 'ab', 'ab'])
+ :call add(tl, ['\v(ab){1}', 'dabc', 'ab', 'ab'])
+ :call add(tl, ['\v(ab){1}', 'acb'])
+ :"
+ :call add(tl, ['\v(ab){0,2}', 'acb', "", ""])
+ :call add(tl, ['\v(ab){0,2}', 'ab', 'ab', 'ab'])
+ :call add(tl, ['\v(ab){1,2}', 'ab', 'ab', 'ab'])
+ :call add(tl, ['\v(ab){1,2}', 'ababc', 'abab', 'ab'])
+ :call add(tl, ['\v(ab){2,4}', 'ababcab', 'abab', 'ab'])
+ :call add(tl, ['\v(ab){2,4}', 'abcababa', 'abab', 'ab'])
+ :"
+ :call add(tl, ['\v(ab){2}', 'abab', 'abab', 'ab'])
+ :call add(tl, ['\v(ab){2}', 'cdababe', 'abab', 'ab'])
+ :call add(tl, ['\v(ab){2}', 'abac'])
+ :call add(tl, ['\v(ab){2}', 'abacabab', 'abab', 'ab'])
+ :call add(tl, ['\v((ab){2}){2}', 'abababab', 'abababab', 'abab', 'ab'])
+ :call add(tl, ['\v((ab){2}){2}', 'abacabababab', 'abababab', 'abab', 'ab'])
+ :"
+ :call add(tl, ['\v(a{1}){1}', 'a', 'a', 'a'])
+ :call add(tl, ['\v(a{2}){1}', 'aa', 'aa', 'aa'])
+ :call add(tl, ['\v(a{2}){1}', 'aaac', 'aa', 'aa'])
+ :call add(tl, ['\v(a{2}){1}', 'daaac', 'aa', 'aa'])
+ :call add(tl, ['\v(a{1}){2}', 'daaac', 'aa', 'a'])
+ :call add(tl, ['\v(a{1}){2}', 'aaa', 'aa', 'a'])
+ :call add(tl, ['\v(a{2})+', 'adaac', 'aa', 'aa'])
+ :call add(tl, ['\v(a{2})+', 'aa', 'aa', 'aa'])
+ :call add(tl, ['\v(a{2}){1}', 'aa', 'aa', 'aa'])
+ :call add(tl, ['\v(a{1}){2}', 'aa', 'aa', 'a'])
+ :call add(tl, ['\v(a{1}){1}', 'a', 'a', 'a'])
+ :call add(tl, ['\v(a{2}){2}', 'aaaa', 'aaaa', 'aa'])
+ :call add(tl, ['\v(a{2}){2}', 'aaabaaaa', 'aaaa', 'aa'])
+ :"
+ :call add(tl, ['\v(a+){2}', 'dadaac', 'aa', 'a'])
+ :call add(tl, ['\v(a{3}){2}', 'aaaaaaa', 'aaaaaa', 'aaa'])
+ :"
+ :call add(tl, ['\v(a{1,2}){2}', 'daaac', 'aaa', 'a'])
+ :call add(tl, ['\v(a{1,3}){2}', 'daaaac', 'aaaa', 'a'])
+ :call add(tl, ['\v(a{1,3}){2}', 'daaaaac', 'aaaaa', 'aa'])
+ :call add(tl, ['\v(a{1,3}){3}', 'daac'])
+ :call add(tl, ['\v(a{1,2}){2}', 'dac'])
+ :call add(tl, ['\v(a+)+', 'daac', 'aa', 'aa'])
+ :call add(tl, ['\v(a+)+', 'aaa', 'aaa', 'aaa'])
+ :call add(tl, ['\v(a+){1,2}', 'aaa', 'aaa', 'aaa'])
+ :call add(tl, ['\v(a+)(a+)', 'aaa', 'aaa', 'aa', 'a'])
+ :call add(tl, ['\v(a{3})+', 'daaaac', 'aaa', 'aaa'])
+ :call add(tl, ['\v(a|b|c)+', 'aacb', 'aacb', 'b'])
+ :call add(tl, ['\v(a|b|c){2}', 'abcb', 'ab', 'b'])
+ :call add(tl, ['\v(abc){2}', 'abcabd', ])
+ :call add(tl, ['\v(abc){2}', 'abdabcabc','abcabc', 'abc'])
+ :"
+ :call add(tl, ['a*', 'cc', ''])
+ :call add(tl, ['\v(a*)+', 'cc', ''])
+ :call add(tl, ['\v((ab)+)+', 'ab', 'ab', 'ab', 'ab'])
+ :call add(tl, ['\v(((ab)+)+)+', 'ab', 'ab', 'ab', 'ab', 'ab'])
+ :call add(tl, ['\v(((ab)+)+)+', 'dababc', 'abab', 'abab', 'abab', 'ab'])
+ :call add(tl, ['\v(a{0,2})+', 'cc', ''])
+ :call add(tl, ['\v(a*)+', '', ''])
+ :call add(tl, ['\v((a*)+)+', '', ''])
+ :call add(tl, ['\v((ab)*)+', '', ''])
+ :call add(tl, ['\va{1,3}', 'aab', 'aa'])
+ :call add(tl, ['\va{2,3}', 'abaa', 'aa'])
+ :"
+ :call add(tl, ['\v((ab)+|c*)+', 'abcccaba', 'abcccab', '', 'ab'])
+ :call add(tl, ['\v(a{2})|(b{3})', 'bbabbbb', 'bbb', '', 'bbb'])
+ :call add(tl, ['\va{2}|b{2}', 'abab'])
+ :call add(tl, ['\v(a)+|(c)+', 'bbacbaacbbb', 'a', 'a'])
+ :call add(tl, ['\vab{2,3}c', 'aabbccccccccccccc', 'abbc'])
+ :call add(tl, ['\vab{2,3}c', 'aabbbccccccccccccc', 'abbbc'])
+ :call add(tl, ['\vab{2,3}cd{2,3}e', 'aabbbcddee', 'abbbcdde'])
+ :call add(tl, ['\va(bc){2}d', 'aabcbfbc' ])
+ :call add(tl, ['\va*a{2}', 'a', ])
+ :call add(tl, ['\va*a{2}', 'aa', 'aa' ])
+ :call add(tl, ['\va*a{2}', 'aaa', 'aaa' ])
+ :call add(tl, ['\va*a{2}', 'bbbabcc', ])
+ :call add(tl, ['\va*b*|a*c*', 'a', 'a'])
+ :call add(tl, ['\va{1}b{1}|a{1}b{1}', ''])
+ :"
+ :"submatches
+ :call add(tl, ['\v(a)', 'ab', 'a', 'a'])
+ :call add(tl, ['\v(a)(b)', 'ab', 'ab', 'a', 'b'])
+ :call add(tl, ['\v(ab)(b)(c)', 'abbc', 'abbc', 'ab', 'b', 'c'])
+ :call add(tl, ['\v((a)(b))', 'ab', 'ab', 'ab', 'a', 'b'])
+ :call add(tl, ['\v(a)|(b)', 'ab', 'a', 'a'])
+ :"
+ :call add(tl, ['\v(a*)+', 'aaaa', 'aaaa', ''])
  :call add(tl, ['x', 'abcdef'])
  :"
  :for t in tl
*** ../vim-7.1.179/src/testdir/test64.ok	Tue Aug 14 17:28:14 2007
--- src/testdir/test64.ok	Mon Dec 31 14:20:26 2007
***************
*** 4,6 ****
--- 4,102 ----
  OK
  OK
  OK
+ OK
+ OK
+ OK
+ OK
+ OK
+ OK
+ OK
+ OK
+ OK
+ OK
+ OK
+ OK
+ OK
+ OK
+ OK
+ OK
+ OK
+ OK
+ OK
+ OK
+ OK
+ OK
+ OK
+ OK
+ OK
+ OK
+ OK
+ OK
+ OK
+ OK
+ OK
+ OK
+ OK
+ OK
+ OK
+ OK
+ OK
+ OK
+ OK
+ OK
+ OK
+ OK
+ OK
+ OK
+ OK
+ OK
+ OK
+ OK
+ OK
+ OK
+ OK
+ OK
+ OK
+ OK
+ OK
+ OK
+ OK
+ OK
+ OK
+ OK
+ OK
+ OK
+ OK
+ OK
+ OK
+ OK
+ OK
+ OK
+ OK
+ OK
+ OK
+ OK
+ OK
+ OK
+ OK
+ OK
+ OK
+ OK
+ OK
+ OK
+ OK
+ OK
+ OK
+ OK
+ OK
+ OK
+ OK
+ OK
+ OK
+ OK
+ OK
+ OK
+ OK
+ OK
+ OK
+ OK
*** ../vim-7.1.179/src/version.c	Tue Jan  1 16:25:33 2008
--- src/version.c	Tue Jan  1 17:34:32 2008
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     180,
  /**/

-- 
CONCORDE: Message for you, sir.
   He falls forward revealing the arrow with the note.
                 "Monty Python and the Holy Grail" PYTHON (MONTY) PICTURES LTD

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: Patch 7.1.181
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.181
Problem:    Accessing uninitialized memory in Farsi mode. (Dominuque Pelle)
Solution:   Only invoke lrF_sub() when there is something to do.
Files:	    src/ex_cmds.c


*** ../vim-7.1.180/src/ex_cmds.c	Sun Dec  9 19:37:37 2007
--- src/ex_cmds.c	Mon Dec 31 17:29:25 2007
***************
*** 4212,4222 ****
  	sub_nlines = 0;
      }
  
- #ifdef FEAT_FKMAP	/* reverse the flow of the Farsi characters */
-     if (p_altkeymap && curwin->w_p_rl)
- 	lrF_sub(cmd);
- #endif
- 
      if (eap->cmdidx == CMD_tilde)
  	which_pat = RE_LAST;	/* use last used regexp */
      else
--- 4212,4217 ----
***************
*** 4252,4257 ****
--- 4247,4256 ----
  	}
  	else		/* find the end of the regexp */
  	{
+ #ifdef FEAT_FKMAP	/* reverse the flow of the Farsi characters */
+ 	    if (p_altkeymap && curwin->w_p_rl)
+ 		lrF_sub(cmd);
+ #endif
  	    which_pat = RE_LAST;	    /* use last used regexp */
  	    delimiter = *cmd++;		    /* remember delimiter character */
  	    pat = cmd;			    /* remember start of search pat */
*** ../vim-7.1.180/src/version.c	Tue Jan  1 17:37:01 2008
--- src/version.c	Wed Jan  2 13:57:31 2008
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     181,
  /**/

-- 
Yah, well, we had to carve our electrons out of driftwood we'd
find.  In the winter.  Uphill.  Both ways.

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: Patch 7.1.182
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.182
Problem:    When using tab pages and an argument list the session file may
	    contain wrong "next" commands. (Alexander Bluem)
Solution:   Use "argu" commands and only when needed.
Files:	    src/ex_docmd.c


*** ../vim-7.1.181/src/ex_docmd.c	Sun Dec  9 19:37:37 2007
--- src/ex_docmd.c	Mon Dec 31 18:24:16 2007
***************
*** 372,378 ****
  static char_u	*arg_all __ARGS((void));
  #ifdef FEAT_SESSION
  static int	makeopens __ARGS((FILE *fd, char_u *dirnow));
! static int	put_view __ARGS((FILE *fd, win_T *wp, int add_edit, unsigned *flagp));
  static void	ex_loadview __ARGS((exarg_T *eap));
  static char_u	*get_view_file __ARGS((int c));
  static int	did_lcd;	/* whether ":lcd" was produced for a session */
--- 372,378 ----
  static char_u	*arg_all __ARGS((void));
  #ifdef FEAT_SESSION
  static int	makeopens __ARGS((FILE *fd, char_u *dirnow));
! static int	put_view __ARGS((FILE *fd, win_T *wp, int add_edit, unsigned *flagp, int current_arg_idx));
  static void	ex_loadview __ARGS((exarg_T *eap));
  static char_u	*get_view_file __ARGS((int c));
  static int	did_lcd;	/* whether ":lcd" was produced for a session */
***************
*** 8762,8768 ****
  	    }
  	    else
  	    {
! 		failed |= (put_view(fd, curwin, !using_vdir, flagp) == FAIL);
  	    }
  	    if (put_line(fd, "let &so = s:so_save | let &siso = s:siso_save")
  								      == FAIL)
--- 8762,8769 ----
  	    }
  	    else
  	    {
! 		failed |= (put_view(fd, curwin, !using_vdir, flagp,
! 								 -1) == FAIL);
  	    }
  	    if (put_line(fd, "let &so = s:so_save | let &siso = s:siso_save")
  								      == FAIL)
***************
*** 9761,9766 ****
--- 9762,9769 ----
      int		tabnr;
      win_T	*tab_firstwin;
      frame_T	*tab_topframe;
+     int		cur_arg_idx = 0;
+     int		next_arg_idx;
  
      if (ssop_flags & SSOP_BUFFERS)
  	only_save_windows = FALSE;		/* Save ALL buffers */
***************
*** 9976,9987 ****
  	{
  	    if (!ses_do_win(wp))
  		continue;
! 	    if (put_view(fd, wp, wp != edited_win, &ssop_flags) == FAIL)
  		return FAIL;
  	    if (nr > 1 && put_line(fd, "wincmd w") == FAIL)
  		return FAIL;
  	}
  
  	/*
  	 * Restore cursor to the current window if it's not the first one.
  	 */
--- 9979,9997 ----
  	{
  	    if (!ses_do_win(wp))
  		continue;
! 	    if (put_view(fd, wp, wp != edited_win, &ssop_flags,
! 							 cur_arg_idx) == FAIL)
  		return FAIL;
  	    if (nr > 1 && put_line(fd, "wincmd w") == FAIL)
  		return FAIL;
+ 	    next_arg_idx = wp->w_arg_idx;
  	}
  
+ 	/* The argument index in the first tab page is zero, need to set it in
+ 	 * each window.  For further tab pages it's the window where we do
+ 	 * "tabedit". */
+ 	cur_arg_idx = next_arg_idx;
+ 
  	/*
  	 * Restore cursor to the current window if it's not the first one.
  	 */
***************
*** 10190,10200 ****
   * Caller must make sure 'scrolloff' is zero.
   */
      static int
! put_view(fd, wp, add_edit, flagp)
      FILE	*fd;
      win_T	*wp;
      int		add_edit;	/* add ":edit" command to view */
      unsigned	*flagp;		/* vop_flags or ssop_flags */
  {
      win_T	*save_curwin;
      int		f;
--- 10200,10212 ----
   * Caller must make sure 'scrolloff' is zero.
   */
      static int
! put_view(fd, wp, add_edit, flagp, current_arg_idx)
      FILE	*fd;
      win_T	*wp;
      int		add_edit;	/* add ":edit" command to view */
      unsigned	*flagp;		/* vop_flags or ssop_flags */
+     int		current_arg_idx; /* current argument index of the window, use
+ 				  * -1 if unknown */
  {
      win_T	*save_curwin;
      int		f;
***************
*** 10224,10233 ****
  
      /* Only when part of a session: restore the argument index.  Some
       * arguments may have been deleted, check if the index is valid. */
!     if (wp->w_arg_idx != 0 && wp->w_arg_idx <= WARGCOUNT(wp)
  						      && flagp == &ssop_flags)
      {
! 	if (fprintf(fd, "%ldnext", (long)wp->w_arg_idx) < 0
  		|| put_eol(fd) == FAIL)
  	    return FAIL;
  	did_next = TRUE;
--- 10236,10245 ----
  
      /* Only when part of a session: restore the argument index.  Some
       * arguments may have been deleted, check if the index is valid. */
!     if (wp->w_arg_idx != current_arg_idx && wp->w_arg_idx <= WARGCOUNT(wp)
  						      && flagp == &ssop_flags)
      {
! 	if (fprintf(fd, "%ldargu", (long)wp->w_arg_idx + 1) < 0
  		|| put_eol(fd) == FAIL)
  	    return FAIL;
  	did_next = TRUE;
*** ../vim-7.1.181/src/version.c	Wed Jan  2 13:58:17 2008
--- src/version.c	Wed Jan  2 15:10:01 2008
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     182,
  /**/

-- 
You were lucky. We lived for three months in a brown paper bag in a 
septic tank. We used to have to get up at six o'clock in the morning, 
clean the bag, eat a crust of stale bread, go to work down mill for 
fourteen hours a day week in-week out. When we got home, our Dad
would thrash us to sleep with his belt!

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: Patch 7.1.183
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.183
Problem:    "Internal error" for ":echo matchstr('a', 'a\%[\&]')" (Mitanu
	    Paul)
Solution:   Inside "\%[]" detect \&, \| and \) as an error.
Files:	    src/regexp.c


*** ../vim-7.1.182/src/regexp.c	Sun Dec  9 19:25:35 2007
--- src/regexp.c	Wed Jan  2 15:02:37 2008
***************
*** 1288,1295 ****
  }
  
  /*
!  * regbranch - one alternative of an | operator
!  *
   * Implements the & operator.
   */
      static char_u *
--- 1288,1294 ----
  }
  
  /*
!  * Handle one alternative of an | operator.
   * Implements the & operator.
   */
      static char_u *
***************
*** 1330,1337 ****
  }
  
  /*
!  * regbranch - one alternative of an | or & operator
!  *
   * Implements the concatenation operator.
   */
      static char_u *
--- 1329,1335 ----
  }
  
  /*
!  * Handle one alternative of an | or & operator.
   * Implements the concatenation operator.
   */
      static char_u *
***************
*** 1708,1713 ****
--- 1706,1713 ----
        case Magic('|'):
        case Magic('&'):
        case Magic(')'):
+ 	if (one_exactly)
+ 	    EMSG_ONE_RET_NULL;
  	EMSG_RET_NULL(_(e_internal));	/* Supposed to be caught earlier. */
  	/* NOTREACHED */
  
***************
*** 3106,3112 ****
   * slow, we keep one allocated piece of memory and only re-allocate it when
   * it's too small.  It's freed in vim_regexec_both() when finished.
   */
! static char_u	*reg_tofree;
  static unsigned	reg_tofreelen;
  
  /*
--- 3106,3112 ----
   * slow, we keep one allocated piece of memory and only re-allocate it when
   * it's too small.  It's freed in vim_regexec_both() when finished.
   */
! static char_u	*reg_tofree = NULL;
  static unsigned	reg_tofreelen;
  
  /*
*** ../vim-7.1.182/src/version.c	Wed Jan  2 15:12:29 2008
--- src/version.c	Wed Jan  2 15:33:52 2008
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     183,
  /**/

-- 
Not too long ago, unzipping in public was illegal...

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: Patch 7.1.184
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.184
Problem:    Crash when deleting backwards over a line break in Insert mode.
Solution:   Don't advance the cursor when it's already on the NUL after a
	    line. (Matthew Wozniski)
Files:	    src/normal.c


*** ../vim-7.1.183/src/normal.c	Sun Oct 14 17:15:45 2007
--- src/normal.c	Tue Jan  1 16:40:24 2008
***************
*** 5849,5860 ****
  		/* When the NL before the first char has to be deleted we
  		 * put the cursor on the NUL after the previous line.
  		 * This is a very special case, be careful!
! 		 * don't adjust op_end now, otherwise it won't work */
  		if (	   (cap->oap->op_type == OP_DELETE
  			    || cap->oap->op_type == OP_CHANGE)
  			&& !lineempty(curwin->w_cursor.lnum))
  		{
! 		    ++curwin->w_cursor.col;
  		    cap->retval |= CA_NO_ADJ_OP_END;
  		}
  		continue;
--- 5849,5861 ----
  		/* When the NL before the first char has to be deleted we
  		 * put the cursor on the NUL after the previous line.
  		 * This is a very special case, be careful!
! 		 * Don't adjust op_end now, otherwise it won't work. */
  		if (	   (cap->oap->op_type == OP_DELETE
  			    || cap->oap->op_type == OP_CHANGE)
  			&& !lineempty(curwin->w_cursor.lnum))
  		{
! 		    if (*ml_get_cursor() != NUL)
! 			++curwin->w_cursor.col;
  		    cap->retval |= CA_NO_ADJ_OP_END;
  		}
  		continue;
*** ../vim-7.1.183/src/version.c	Wed Jan  2 15:34:48 2008
--- src/version.c	Wed Jan  2 16:24:19 2008
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     184,
  /**/

-- 
Not too long ago, cut and paste was done with scissors and glue...

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: Patch 7.1.185
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.185
Problem:    Using "gR" with a multi-byte encoding and typing a CR pushes
	    characters onto the replace stack incorrectly, resulting in BS
	    putting back the wrong characters. (Paul B. Mahol)
Solution:   Push multi-byte characters onto the replace stack in reverse byte
	    order.  Add replace_push_mb().
Files:	    src/edit.c, src/misc1.c, src/proto/edit.pro


*** ../vim-7.1.184/src/edit.c	Sun Dec  9 20:25:59 2007
--- src/edit.c	Tue Jan  1 17:28:07 2008
***************
*** 6939,6944 ****
--- 6939,6963 ----
      ++replace_stack_nr;
  }
  
+ #if defined(FEAT_MBYTE) || defined(PROTO)
+ /*
+  * Push a character onto the replace stack.  Handles a multi-byte character in
+  * reverse byte order, so that the first byte is popped off first.
+  * Return the number of bytes done (includes composing characters).
+  */
+     int
+ replace_push_mb(p)
+     char_u *p;
+ {
+     int l = (*mb_ptr2len)(p);
+     int j;
+ 
+     for (j = l - 1; j >= 0; --j)
+ 	replace_push(p[j]);
+     return l;
+ }
+ #endif
+ 
  #if 0
  /*
   * call replace_push(c) with replace_offset set to the first NUL.
*** ../vim-7.1.184/src/misc1.c	Wed Sep 26 22:35:06 2007
--- src/misc1.c	Wed Jan  2 17:48:00 2008
***************
*** 591,597 ****
  	replace_push(NUL);
  	p = saved_line + curwin->w_cursor.col;
  	while (*p != NUL)
! 	    replace_push(*p++);
  	saved_line[curwin->w_cursor.col] = NUL;
      }
  #endif
--- 592,605 ----
  	replace_push(NUL);
  	p = saved_line + curwin->w_cursor.col;
  	while (*p != NUL)
! 	{
! #ifdef FEAT_MBYTE
! 	    if (has_mbyte)
! 		p += replace_push_mb(p);
! 	    else
! #endif
! 		replace_push(*p++);
! 	}
  	saved_line[curwin->w_cursor.col] = NUL;
      }
  #endif
***************
*** 1914,1920 ****
      int		charlen;
  {
      int		c = buf[0];
-     int		l, j;
  #endif
      int		newlen;		/* nr of bytes inserted */
      int		oldlen;		/* nr of bytes deleted (0 when not replacing) */
--- 1922,1927 ----
***************
*** 2016,2028 ****
  	for (i = 0; i < oldlen; ++i)
  	{
  #ifdef FEAT_MBYTE
! 	    l = (*mb_ptr2len)(oldp + col + i) - 1;
! 	    for (j = l; j >= 0; --j)
! 		replace_push(oldp[col + i + j]);
! 	    i += l;
! #else
! 	    replace_push(oldp[col + i]);
  #endif
  	}
      }
  
--- 2023,2033 ----
  	for (i = 0; i < oldlen; ++i)
  	{
  #ifdef FEAT_MBYTE
! 	    if (has_mbyte)
! 		i += replace_push_mb(oldp + col + i) - 1;
! 	    else
  #endif
+ 		replace_push(oldp[col + i]);
  	}
      }
  
*** ../vim-7.1.184/src/proto/edit.pro	Sat May  5 20:21:34 2007
--- src/proto/edit.pro	Tue Jan  1 17:21:24 2008
***************
*** 32,37 ****
--- 32,38 ----
  char_u *get_last_insert __ARGS((void));
  char_u *get_last_insert_save __ARGS((void));
  void replace_push __ARGS((int c));
+ int replace_push_mb __ARGS((char_u *p));
  void fixthisline __ARGS((int (*get_the_indent)(void)));
  void fix_indent __ARGS((void));
  int in_cinkeys __ARGS((int keytyped, int when, int line_is_empty));
*** ../vim-7.1.184/src/version.c	Wed Jan  2 16:25:20 2008
--- src/version.c	Wed Jan  2 17:45:10 2008
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     185,
  /**/

-- 
Not too long ago, a keyboard was something to make music with...

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: Patch 7.1.186
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.186
Problem:    "expand('<afile>')" returns a bogus value after changing
	    directory. (Dave Fishburn)
Solution:   Copy "autocmd_fname" to allocated memory and expand to full
	    filename.  Shorten the path when expanding <afile>.
Files:	    src/ex_docmd.c, src/fileio.c


*** ../vim-7.1.185/src/ex_docmd.c	Wed Jan  2 15:12:29 2008
--- src/ex_docmd.c	Wed Jan  2 20:12:33 2008
***************
*** 7799,7804 ****
--- 7799,7805 ----
  free_cd_dir()
  {
      vim_free(prev_dir);
+     prev_dir = NULL;
  }
  #endif
  
***************
*** 9521,9526 ****
--- 9522,9528 ----
  		    *errormsg = (char_u *)_("E495: no autocommand file name to substitute for \"<afile>\"");
  		    return NULL;
  		}
+ 		result = shorten_fname1(result);
  		break;
  
  	case SPEC_ABUF:		/* buffer number for autocommand */
*** ../vim-7.1.185/src/fileio.c	Thu Nov  8 20:47:34 2007
--- src/fileio.c	Wed Jan  2 20:21:43 2008
***************
*** 5556,5562 ****
  #endif
  
  #if defined(FEAT_VIMINFO) || defined(FEAT_BROWSE) || \
!     defined(FEAT_QUICKFIX) || defined(PROTO)
  /*
   * Try to find a shortname by comparing the fullname with the current
   * directory.
--- 5556,5562 ----
  #endif
  
  #if defined(FEAT_VIMINFO) || defined(FEAT_BROWSE) || \
!     defined(FEAT_QUICKFIX) || defined(FEAT_AUTOCMD) || defined(PROTO)
  /*
   * Try to find a shortname by comparing the fullname with the current
   * directory.
***************
*** 8546,8551 ****
--- 8546,8553 ----
  
      /*
       * Set the file name to be used for <afile>.
+      * Make a copy to avoid that changing a buffer name or directory makes it
+      * invalid.
       */
      if (fname_io == NULL)
      {
***************
*** 8558,8563 ****
--- 8560,8567 ----
      }
      else
  	autocmd_fname = fname_io;
+     if (autocmd_fname != NULL)
+ 	autocmd_fname = FullName_save(autocmd_fname, FALSE);
  
      /*
       * Set the buffer number to be used for <abuf>.
***************
*** 8740,8745 ****
--- 8744,8750 ----
      vim_free(sourcing_name);
      sourcing_name = save_sourcing_name;
      sourcing_lnum = save_sourcing_lnum;
+     vim_free(autocmd_fname);
      autocmd_fname = save_autocmd_fname;
      autocmd_bufnr = save_autocmd_bufnr;
      autocmd_match = save_autocmd_match;
*** ../vim-7.1.185/src/version.c	Wed Jan  2 17:48:24 2008
--- src/version.c	Wed Jan  2 21:06:35 2008
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     186,
  /**/

-- 
   LAUNCELOT leaps into SHOT with a mighty cry and runs the GUARD through and
   hacks him to the floor.  Blood.  Swashbuckling music (perhaps).
   LAUNCELOT races through into the castle screaming.
SECOND SENTRY: Hey!
                 "Monty Python and the Holy Grail" PYTHON (MONTY) PICTURES LTD

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: Patch 7.1.187
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.187
Problem:    Win32 GUI: Custom completion using system() no longer works
	    after patch 7.1.104. (Erik Falor)
Solution:   Loop when safe_vgetc() returns K_IGNORE.
Files:	    src/ex_getln.c


*** ../vim-7.1.186/src/ex_getln.c	Fri Dec  7 20:28:13 2007
--- src/ex_getln.c	Wed Jan  2 21:42:51 2008
***************
*** 335,341 ****
  	quit_more = FALSE;	/* reset after CTRL-D which had a more-prompt */
  
  	cursorcmd();		/* set the cursor on the right spot */
! 	c = safe_vgetc();
  	if (KeyTyped)
  	{
  	    some_key_typed = TRUE;
--- 335,348 ----
  	quit_more = FALSE;	/* reset after CTRL-D which had a more-prompt */
  
  	cursorcmd();		/* set the cursor on the right spot */
! 
! 	/* Get a character.  Ignore K_IGNORE, it should not do anything, such
! 	 * as stop completion. */
! 	do
! 	{
! 	    c = safe_vgetc();
! 	} while (c == K_IGNORE);
! 
  	if (KeyTyped)
  	{
  	    some_key_typed = TRUE;
***************
*** 1209,1215 ****
  		goto cmdline_not_changed;
  
  	case K_IGNORE:
! 		goto cmdline_not_changed;	/* Ignore mouse */
  
  #ifdef FEAT_GUI_W32
  	    /* On Win32 ignore <M-F4>, we get it when closing the window was
--- 1216,1223 ----
  		goto cmdline_not_changed;
  
  	case K_IGNORE:
! 		/* Ignore mouse event or ex_window() result. */
! 		goto cmdline_not_changed;
  
  #ifdef FEAT_GUI_W32
  	    /* On Win32 ignore <M-F4>, we get it when closing the window was
*** ../vim-7.1.186/src/version.c	Wed Jan  2 21:07:32 2008
--- src/version.c	Wed Jan  2 21:53:24 2008
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     187,
  /**/

-- 
FATHER:    Who are you?
PRINCE:    I'm ... your son ...
FATHER:    Not you.
LAUNCELOT: I'm ... er ... Sir Launcelot, sir.
                 "Monty Python and the Holy Grail" PYTHON (MONTY) PICTURES LTD

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: Patch 7.1.188
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.188
Problem:    When 'showmode' is off the message for changing a readonly file is
	    given in the second column instead of the first.  (Payl B.  Mahol)
Solution:   Put the W10 message in the first column.
Files:	    src/edit.c


*** ../vim-7.1.187/src/edit.c	Wed Jan  2 17:48:24 2008
--- src/edit.c	Wed Jan  2 20:56:46 2008
***************
*** 550,556 ****
  	i = showmode();
  
      if (!p_im && did_restart_edit == 0)
! 	change_warning(i + 1);
  
  #ifdef CURSOR_SHAPE
      ui_cursor_shape();		/* may show different cursor shape */
--- 550,556 ----
  	i = showmode();
  
      if (!p_im && did_restart_edit == 0)
! 	change_warning(i == 0 ? 0 : i + 1);
  
  #ifdef CURSOR_SHAPE
      ui_cursor_shape();		/* may show different cursor shape */
*** ../vim-7.1.187/src/version.c	Wed Jan  2 21:54:33 2008
--- src/version.c	Wed Jan  2 22:06:19 2008
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     188,
  /**/

-- 
PRINCE:    He's come to rescue me, father.
LAUNCELOT: (embarrassed) Well, let's not jump to conclusions ...
                 "Monty Python and the Holy Grail" PYTHON (MONTY) PICTURES LTD

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: Patch 7.1.189
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.189 (after 7.1.104)
Problem:    Patch 7.1.104 was incomplete.
Solution:   Also call plain_vgetc() in ask_yesno().
Files:	    src/misc1.c


*** ../vim-7.1.188/src/misc1.c	Wed Jan  2 17:48:24 2008
--- src/misc1.c	Wed Jan  2 17:48:00 2008
***************
*** 222,231 ****
  	    *s++ = *p++;
  	    orig_char_len--;
  	}
  	/* Skip over any additional white space (useful when newindent is less
  	 * than old) */
  	while (vim_iswhite(*p))
! 	    (void)*p++;
  
      }
      else
--- 222,232 ----
  	    *s++ = *p++;
  	    orig_char_len--;
  	}
+ 
  	/* Skip over any additional white space (useful when newindent is less
  	 * than old) */
  	while (vim_iswhite(*p))
! 	    ++p;
  
      }
      else
***************
*** 3024,3030 ****
  	if (direct)
  	    r = get_keystroke();
  	else
! 	    r = safe_vgetc();
  	if (r == Ctrl_C || r == ESC)
  	    r = 'n';
  	msg_putchar(r);	    /* show what you typed */
--- 3025,3031 ----
  	if (direct)
  	    r = get_keystroke();
  	else
! 	    r = plain_vgetc();
  	if (r == Ctrl_C || r == ESC)
  	    r = 'n';
  	msg_putchar(r);	    /* show what you typed */
*** ../vim-7.1.188/src/version.c	Wed Jan  2 22:08:43 2008
--- src/version.c	Thu Jan  3 12:40:31 2008
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     189,
  /**/

-- 
Q: How does a UNIX Guru do Sex ?
A: unzip;strip;touch;finger;mount;fsck;more;yes;umount;sleep

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: Patch 7.1.190
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.190
Problem:    Cursor after end-of-line: "iA sentence.<Esc>)"
Solution:   Move cursor back and make motion inclusive.
Files:	    src/normal.c


*** ../vim-7.1.189/src/normal.c	Wed Jan  2 16:25:20 2008
--- src/normal.c	Wed Jan  2 22:04:38 2008
***************
*** 6564,6569 ****
--- 6564,6575 ----
  	clearopbeep(cap->oap);
      else
      {
+ 	/* Don't leave the cursor on the NUL past a line */
+ 	if (curwin->w_cursor.col > 0 && gchar_cursor() == NUL)
+ 	{
+ 	    --curwin->w_cursor.col;
+ 	    cap->oap->inclusive = TRUE;
+ 	}
  #ifdef FEAT_VIRTUALEDIT
  	curwin->w_cursor.coladd = 0;
  #endif
*** ../vim-7.1.189/src/version.c	Thu Jan  3 12:42:39 2008
--- src/version.c	Thu Jan  3 13:19:03 2008
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     190,
  /**/

-- 
    [clop clop]
GUARD #1:  Halt!  Who goes there?
ARTHUR:    It is I, Arthur, son of Uther Pendragon, from the castle of
           Camelot.  King of the Britons, defeator of the Saxons, sovereign of
           all England!
GUARD #1:  Pull the other one!
                                  The Quest for the Holy Grail (Monty Python)

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: Patch 7.1.191
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.191
Problem:    Win32 GUI: after patch 7.1.168 there is still a problem when
	    clicking in a scrollbar. (Juergen Jottkaerr)
Solution:   Don't check the input buffer when dragging the scrollbar.
Files:	    src/gui.c


*** ../vim-7.1.190/src/gui.c	Tue Nov  6 22:26:39 2007
--- src/gui.c	Thu Jan  3 13:16:29 2008
***************
*** 3734,3741 ****
      sb->value = value;
  
  #ifdef USE_ON_FLY_SCROLL
!     /* When not allowed to do the scrolling right now, return. */
!     if (dont_scroll || input_available())
  	return;
  #endif
  #ifdef FEAT_INS_EXPAND
--- 3734,3743 ----
      sb->value = value;
  
  #ifdef USE_ON_FLY_SCROLL
!     /* When not allowed to do the scrolling right now, return.
!      * This also checked input_available(), but that causes the first click in
!      * a scrollbar to be ignored when Vim doesn't have focus. */
!     if (dont_scroll)
  	return;
  #endif
  #ifdef FEAT_INS_EXPAND
*** ../vim-7.1.190/src/version.c	Thu Jan  3 13:19:50 2008
--- src/version.c	Thu Jan  3 16:13:23 2008
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     191,
  /**/

-- 
GUARD #1:  What -- a swallow carrying a coconut?
ARTHUR:    It could grip it by the husk!
GUARD #1:  It's not a question of where he grips it!  It's a simple question
           of weight ratios!  A five ounce bird could not carry a 1 pound
           coconut.
                                  The Quest for the Holy Grail (Monty Python)

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: Patch 7.1.192
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.192
Problem:    With Visual block selection, "s" and typing something, CTRL-C
	    doesn't stop Vim from repeating the replacement in other lines,
	    like happens for "I".
Solution:   Check for "got_int" to be set.
Files:	    src/ops.c


*** ../vim-7.1.191/src/ops.c	Sat Dec  1 21:12:23 2007
--- src/ops.c	Thu Jan  3 16:26:37 2008
***************
*** 2468,2476 ****
  
      edit(NUL, FALSE, (linenr_T)count1);
  
!     /* if user has moved off this line, we don't know what to do, so do
!      * nothing */
!     if (curwin->w_cursor.lnum != oap->start.lnum)
  	return;
  
      if (oap->block_mode)
--- 2468,2477 ----
  
      edit(NUL, FALSE, (linenr_T)count1);
  
!     /* If user has moved off this line, we don't know what to do, so do
!      * nothing.
!      * Also don't repeat the insert when Insert mode ended with CTRL-C. */
!     if (curwin->w_cursor.lnum != oap->start.lnum || got_int)
  	return;
  
      if (oap->block_mode)
***************
*** 2601,2608 ****
      /*
       * In Visual block mode, handle copying the new text to all lines of the
       * block.
       */
!     if (oap->block_mode && oap->start.lnum != oap->end.lnum)
      {
  	/* Auto-indenting may have changed the indent.  If the cursor was past
  	 * the indent, exclude that indent change from the inserted text. */
--- 2602,2610 ----
      /*
       * In Visual block mode, handle copying the new text to all lines of the
       * block.
+      * Don't repeat the insert when Insert mode ended with CTRL-C.
       */
!     if (oap->block_mode && oap->start.lnum != oap->end.lnum && !got_int)
      {
  	/* Auto-indenting may have changed the indent.  If the cursor was past
  	 * the indent, exclude that indent change from the inserted text. */
*** ../vim-7.1.191/src/version.c	Thu Jan  3 16:14:25 2008
--- src/version.c	Thu Jan  3 16:30:07 2008
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     192,
  /**/

-- 
"A mouse can be just as dangerous as a bullet or a bomb."
             (US Representative Lamar Smith, R-Texas)

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: Patch 7.1.193
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.193
Problem:    Some Vim 5.x digraphs are missing in Vim 7, even though the
	    character pairs are not used. (Philippe de Muyter)
Solution:   Add those Vim 5.x digraphs that don't conflict with others.
Files:	    src/digraph.c


*** ../vim-7.1.192/src/digraph.c	Thu Sep 13 18:25:08 2007
--- src/digraph.c	Thu Jan  3 17:48:47 2008
***************
*** 1978,1983 ****
--- 1978,2038 ----
  	{'f', 't', 0xfb05},
  	{'s', 't', 0xfb06},
  #      endif /* FEAT_MBYTE */
+ 
+ 	/* Vim 5.x compatible digraphs that don't conflict with the above */
+ 	{'~', '!', 161},	/*  */
+ 	{'c', '|', 162},	/*  */
+ 	{'$', '$', 163},	/*  */
+ 	{'o', 'x', 164},	/*  - currency symbol in ISO 8859-1 */
+ 	{'Y', '-', 165},	/*  */
+ 	{'|', '|', 166},	/*  */
+ 	{'c', 'O', 169},	/*  */
+ 	{'-', ',', 172},	/*  */
+ 	{'-', '=', 175},	/*  */
+ 	{'~', 'o', 176},	/*  */
+ 	{'2', '2', 178},	/*  */
+ 	{'3', '3', 179},	/*  */
+ 	{'p', 'p', 182},	/*  */
+ 	{'~', '.', 183},	/*  */
+ 	{'1', '1', 185},	/*  */
+ 	{'~', '?', 191},	/*  */
+ 	{'A', '`', 192},	/*  */
+ 	{'A', '^', 194},	/*  */
+ 	{'A', '~', 195},	/*  */
+ 	{'A', '"', 196},	/*  */
+ 	{'A', '@', 197},	/*  */
+ 	{'E', '`', 200},	/*  */
+ 	{'E', '^', 202},	/*  */
+ 	{'E', '"', 203},	/*  */
+ 	{'I', '`', 204},	/*  */
+ 	{'I', '^', 206},	/*  */
+ 	{'I', '"', 207},	/*  */
+ 	{'N', '~', 209},	/*  */
+ 	{'O', '`', 210},	/*  */
+ 	{'O', '^', 212},	/*  */
+ 	{'O', '~', 213},	/*  */
+ 	{'/', '\\', 215},	/*  - multiplication symbol in ISO 8859-1 */
+ 	{'U', '`', 217},	/*  */
+ 	{'U', '^', 219},	/*  */
+ 	{'I', 'p', 222},	/*  */
+ 	{'a', '`', 224},	/*  */
+ 	{'a', '^', 226},	/*  */
+ 	{'a', '~', 227},	/*  */
+ 	{'a', '"', 228},	/*  */
+ 	{'a', '@', 229},	/*  */
+ 	{'e', '`', 232},	/*  */
+ 	{'e', '^', 234},	/*  */
+ 	{'e', '"', 235},	/*  */
+ 	{'i', '`', 236},	/*  */
+ 	{'i', '^', 238},	/*  */
+ 	{'n', '~', 241},	/*  */
+ 	{'o', '`', 242},	/*  */
+ 	{'o', '^', 244},	/*  */
+ 	{'o', '~', 245},	/*  */
+ 	{'u', '`', 249},	/*  */
+ 	{'u', '^', 251},	/*  */
+ 	{'y', '"', 255},	/* x XX */
+ 
  	{NUL, NUL, NUL}
         };
  
*** ../vim-7.1.192/src/version.c	Thu Jan  3 16:31:17 2008
--- src/version.c	Thu Jan  3 17:52:51 2008
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     193,
  /**/

-- 
Futility Factor: No experiment is ever a complete failure - it can always
serve as a negative example.

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: Patch 7.1.194
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.194
Problem:    ":echo glob('~/{}')" results in /home/user//.
Solution:   Don't add a slash if there already is one.
Files:	    src/os_unix.c


*** ../vim-7.1.193/src/os_unix.c	Sat Dec  1 17:18:45 2007
--- src/os_unix.c	Thu Jan  3 18:52:22 2008
***************
*** 5482,5488 ****
  	{
  	    STRCPY(p, (*file)[i]);
  	    if (dir)
! 		STRCAT(p, "/");	    /* add '/' to a directory name */
  	    (*file)[j++] = p;
  	}
      }
--- 5482,5488 ----
  	{
  	    STRCPY(p, (*file)[i]);
  	    if (dir)
! 		add_pathsep(p);	    /* add '/' to a directory name */
  	    (*file)[j++] = p;
  	}
      }
*** ../vim-7.1.193/src/version.c	Thu Jan  3 17:53:41 2008
--- src/version.c	Thu Jan  3 18:54:41 2008
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     194,
  /**/

-- 
ARTHUR:    Will you ask your master if he wants to join my court at Camelot?!
GUARD #1:  But then of course African swallows are not migratory.
GUARD #2:  Oh, yeah...
GUARD #1:  So they couldn't bring a coconut back anyway...
                                  The Quest for the Holy Grail (Monty Python)

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: Patch 7.1.195
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.195
Problem:    '0 mark doesn't work for "~/foo ~ foo".
Solution:   Don't expand the whole file name, only "~/".
Files:	    src/mark.c


*** ../vim-7.1.194/src/mark.c	Thu May 10 18:48:03 2007
--- src/mark.c	Thu Jan  3 20:17:29 2008
***************
*** 505,513 ****
      {
  	/*
  	 * First expand "~/" in the file name to the home directory.
! 	 * Try to shorten the file name.
  	 */
! 	expand_env(fm->fname, NameBuff, MAXPATHL);
  	mch_dirname(IObuff, IOSIZE);
  	p = shorten_fname(NameBuff, IObuff);
  
--- 505,528 ----
      {
  	/*
  	 * First expand "~/" in the file name to the home directory.
! 	 * Don't expand the whole name, it may contain other '~' chars.
  	 */
! 	if (fm->fname[0] == '~' && (fm->fname[1] == '/'
! #ifdef BACKSLASH_IN_FILENAME
! 		    || fm->fname[1] == '\\'
! #endif
! 		    ))
! 	{
! 	    int len;
! 
! 	    expand_env((char_u *)"~/", NameBuff, MAXPATHL);
! 	    len = STRLEN(NameBuff);
! 	    vim_strncpy(NameBuff + len, fm->fname + 2, MAXPATHL - len - 1);
! 	}
! 	else
! 	    vim_strncpy(NameBuff, fm->fname, MAXPATHL - 1);
! 
! 	/* Try to shorten the file name. */
  	mch_dirname(IObuff, IOSIZE);
  	p = shorten_fname(NameBuff, IObuff);
  
*** ../vim-7.1.194/src/version.c	Thu Jan  3 18:55:21 2008
--- src/version.c	Thu Jan  3 20:10:16 2008
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     195,
  /**/

-- 
GUARD #2:  Wait a minute -- supposing two swallows carried it together?
GUARD #1:  No, they'd have to have it on a line.
GUARD #2:  Well, simple!  They'd just use a standard creeper!
GUARD #1:  What, held under the dorsal guiding feathers?
GUARD #2:  Well, why not?
                                  The Quest for the Holy Grail (Monty Python)

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: Patch 7.1.196 (extra)
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.196 (extra)
Problem:    Win32 GUI: "\n" in a tooltip doesn't cause a line break. (Erik
	    Falor)
Solution:   Use the TTM_SETMAXTIPWIDTH message.
Files:	    src/gui_w32.c


*** ../vim-7.1.195/src/gui_w32.c	Thu Aug 30 12:24:21 2007
--- src/gui_w32.c	Thu Jan  3 13:56:26 2008
***************
*** 987,992 ****
--- 987,997 ----
  			{
  			    LPNMTTDISPINFOW	lpdi = (LPNMTTDISPINFOW)lParam;
  
+ 			    /* Set the maximum width, this also enables using
+ 			     * \n for line break. */
+ 			    SendMessage(lpdi->hdr.hwndFrom, TTM_SETMAXTIPWIDTH,
+ 								      0, 500);
+ 
  			    tt_text = enc_to_ucs2(str, NULL);
  			    lpdi->lpszText = tt_text;
  			    /* can't show tooltip if failed */
***************
*** 996,1001 ****
--- 1001,1011 ----
  			{
  			    LPNMTTDISPINFO	lpdi = (LPNMTTDISPINFO)lParam;
  
+ 			    /* Set the maximum width, this also enables using
+ 			     * \n for line break. */
+ 			    SendMessage(lpdi->hdr.hwndFrom, TTM_SETMAXTIPWIDTH,
+ 								      0, 500);
+ 
  			    if (STRLEN(str) < sizeof(lpdi->szText)
  				    || ((tt_text = vim_strsave(str)) == NULL))
  				vim_strncpy(lpdi->szText, str,
***************
*** 4734,4745 ****
  	    cur_beval->showState = ShS_NEUTRAL;
  	    break;
  	case TTN_GETDISPINFO:
! 	{
! 	    /* if you get there then we have new common controls */
! 	    NMTTDISPINFO_NEW *info = (NMTTDISPINFO_NEW *)pnmh;
! 	    info->lpszText = (LPSTR)info->lParam;
! 	    info->uFlags |= TTF_DI_SETITEM;
! 	}
  	    break;
  	}
      }
--- 4744,4755 ----
  	    cur_beval->showState = ShS_NEUTRAL;
  	    break;
  	case TTN_GETDISPINFO:
! 	    {
! 		/* if you get there then we have new common controls */
! 		NMTTDISPINFO_NEW *info = (NMTTDISPINFO_NEW *)pnmh;
! 		info->lpszText = (LPSTR)info->lParam;
! 		info->uFlags |= TTF_DI_SETITEM;
! 	    }
  	    break;
  	}
      }
*** ../vim-7.1.195/src/version.c	Thu Jan  3 20:21:34 2008
--- src/version.c	Thu Jan  3 20:43:22 2008
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     196,
  /**/

-- 
Shit makes the flowers grow and that's beautiful

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: Patch 7.1.197
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.197
Problem:    Mac: "make install" doesn't work when prefix defined.
Solution:   Pass different arguments to "make installruntime".  (Jjgod Jiang)
Files:	    src/Makefile


*** ../vim-7.1.196/src/Makefile	Thu Jan  3 20:44:40 2008
--- src/Makefile	Thu Jan  3 18:30:02 2008
***************
*** 2559,2566 ****
  #	-mkdir $(DESTDIR)$(prefix)/$(APPDIR)/bin
  	srcdir=`pwd`; $(MAKE) -f Makefile installruntime \
  		VIMEXE=$$srcdir/$(VIMTARGET) \
! 		prefix=$(DESTDIR)$(prefix)/$(RESDIR)/vim \
! 		VIMRTLOC=$(DESTDIR)$(prefix)/$(RESDIR)/vim/runtime
  # Put the link back.
  	ln -s `pwd`/../runtime $(RESDIR)/vim
  # Copy rgb.txt, Mac doesn't always have X11
--- 2564,2574 ----
  #	-mkdir $(DESTDIR)$(prefix)/$(APPDIR)/bin
  	srcdir=`pwd`; $(MAKE) -f Makefile installruntime \
  		VIMEXE=$$srcdir/$(VIMTARGET) \
! 		prefix=$(DESTDIR)$(prefix)/$(RESDIR)$(VIMDIR) \
! 		exec_prefix=$(DESTDIR)$(prefix)/$(APPDIR)/Contents \
! 		BINDIR=$(DESTDIR)$(prefix)/$(APPDIR)/Contents/MacOS \
! 		VIMLOC=$(DESTDIR)$(prefix)/$(RESDIR)$(VIMDIR) \
! 		VIMRTLOC=$(DESTDIR)$(prefix)/$(RESDIR)$(VIMDIR)/runtime
  # Put the link back.
  	ln -s `pwd`/../runtime $(RESDIR)/vim
  # Copy rgb.txt, Mac doesn't always have X11
*** ../vim-7.1.196/src/version.c	Thu Jan  3 20:44:35 2008
--- src/version.c	Fri Jan  4 11:52:46 2008
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     197,
  /**/

-- 
CUSTOMER:     Well, can you hang around a couple of minutes?  He won't be
              long.
MORTICIAN:    Naaah, I got to go on to Robinson's -- they've lost nine today.
CUSTOMER:     Well, when is your next round?
MORTICIAN:    Thursday.
DEAD PERSON:  I think I'll go for a walk.
                                  The Quest for the Holy Grail (Monty Python)

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: Patch 7.1.198
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.198
Problem:    Hang when using ":s/\n//gn". (Burak Gorkemli)
Solution:   Set "skip_match".
Files:	    src/ex_cmds.c


*** ../vim-7.1.197/src/ex_cmds.c	Wed Jan  2 13:58:17 2008
--- src/ex_cmds.c	Fri Jan  4 14:46:34 2008
***************
*** 4575,4580 ****
--- 4575,4581 ----
  		    {
  			matchcol = (colnr_T)STRLEN(sub_firstline);
  			nmatch = 1;
+ 			skip_match = TRUE;
  		    }
  		    sub_nsubs++;
  		    did_sub = TRUE;
*** ../vim-7.1.197/src/version.c	Fri Jan  4 11:54:11 2008
--- src/version.c	Fri Jan  4 14:52:09 2008
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     198,
  /**/

-- 
    [clop clop]
ARTHUR:  Old woman!
DENNIS:  Man!
ARTHUR:  Man, sorry.  What knight lives in that castle over there?
DENNIS:  I'm thirty seven.
ARTHUR:  What?
DENNIS:  I'm thirty seven -- I'm not old!
                                  The Quest for the Holy Grail (Monty Python)

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: Patch 7.1.199
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.199
Problem:    Can't do command line completion for a specific file name
	    extension.
Solution:   When the pattern ends in "$" don't add a star for completion and
	    remove the "$" before matching with file names.
Files:	    runtime/doc/cmdline.txt, src/ex_getln.c


*** ../vim-7.1.198/runtime/doc/cmdline.txt	Sat May 12 15:38:39 2007
--- runtime/doc/cmdline.txt	Fri Jan  4 15:13:06 2008
***************
*** 1,4 ****
! *cmdline.txt*   For Vim version 7.1.  Last change: 2006 Jul 18
  
  
  		  VIM REFERENCE MANUAL    by Bram Moolenaar
--- 1,4 ----
! *cmdline.txt*   For Vim version 7.1.  Last change: 2008 Jan 04
  
  
  		  VIM REFERENCE MANUAL    by Bram Moolenaar
***************
*** 316,322 ****
  command-line is shown.  (Note: the shifted arrow keys do not work on all
  terminals)
  
! 							*his* *:history*
  :his[tory]	Print the history of last entered commands.
  		{not in Vi}
  		{not available when compiled without the |+cmdline_hist|
--- 316,322 ----
  command-line is shown.  (Note: the shifted arrow keys do not work on all
  terminals)
  
! 							*:his* *:history*
  :his[tory]	Print the history of last entered commands.
  		{not in Vi}
  		{not available when compiled without the |+cmdline_hist|
***************
*** 447,452 ****
--- 447,457 ----
  
  To completely ignore files with some extension use 'wildignore'.
  
+ To match only files that end at the end of the typed text append a "$".  For
+ example, to match only files that end in ".c": >
+ 	:e *.c$
+ This will not match a file ending in ".cpp".  Without the "$" it does match.
+ 
  The old value of an option can be obtained by hitting 'wildchar' just after
  the '='.  For example, typing 'wildchar' after ":set dir=" will insert the
  current value of 'dir'.  This overrules file name completion for the options
*** ../vim-7.1.198/src/ex_getln.c	Wed Jan  2 21:54:33 2008
--- src/ex_getln.c	Fri Jan  4 15:05:31 2008
***************
*** 4078,4083 ****
--- 4078,4084 ----
  	     * ~ would be at the start of the file name, but not the tail.
  	     * $ could be anywhere in the tail.
  	     * ` could be anywhere in the file name.
+ 	     * When the name ends in '$' don't add a star, remove the '$'.
  	     */
  	    tail = gettail(retval);
  	    if ((*retval != '~' || tail != retval)
***************
*** 4085,4090 ****
--- 4086,4093 ----
  		    && vim_strchr(tail, '$') == NULL
  		    && vim_strchr(retval, '`') == NULL)
  		retval[len++] = '*';
+ 	    else if (len > 0 && retval[len - 1] == '$')
+ 		--len;
  	    retval[len] = NUL;
  	}
      }
*** ../vim-7.1.198/src/version.c	Fri Jan  4 14:52:14 2008
--- src/version.c	Fri Jan  4 15:14:29 2008
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     199,
  /**/

-- 
ARTHUR:  Well, I can't just call you `Man'.
DENNIS:  Well, you could say `Dennis'.
ARTHUR:  Well, I didn't know you were called `Dennis.'
DENNIS:  Well, you didn't bother to find out, did you?
                                  The Quest for the Holy Grail (Monty Python)

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
To: vim-dev@vim.org
Subject: Patch 7.1.200
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 7.1.200 (after 7.1.177 and 7.1.182)
Problem:    Compiler warnings for uninitialized variables.
Solution:   Init variables.
Files:	    src/ex_cmds2.c, src/ex_docmd.c


*** ../vim-7.1.199/src/ex_cmds2.c	Tue Jan  1 14:16:42 2008
--- src/ex_cmds2.c	Fri Jan  4 15:55:54 2008
***************
*** 94,100 ****
      int		save_redir_off = redir_off;
      tasave_T	typeaheadbuf;
      int		typeahead_saved = FALSE;
!     int		save_ignore_script;
  # ifdef FEAT_EX_EXTRA
      int		save_ex_normal_busy;
  # endif
--- 94,100 ----
      int		save_redir_off = redir_off;
      tasave_T	typeaheadbuf;
      int		typeahead_saved = FALSE;
!     int		save_ignore_script = 0;
  # ifdef FEAT_EX_EXTRA
      int		save_ex_normal_busy;
  # endif
*** ../vim-7.1.199/src/ex_docmd.c	Wed Jan  2 21:07:32 2008
--- src/ex_docmd.c	Fri Jan  4 15:57:28 2008
***************
*** 9765,9771 ****
      win_T	*tab_firstwin;
      frame_T	*tab_topframe;
      int		cur_arg_idx = 0;
!     int		next_arg_idx;
  
      if (ssop_flags & SSOP_BUFFERS)
  	only_save_windows = FALSE;		/* Save ALL buffers */
--- 9766,9772 ----
      win_T	*tab_firstwin;
      frame_T	*tab_topframe;
      int		cur_arg_idx = 0;
!     int		next_arg_idx = 0;
  
      if (ssop_flags & SSOP_BUFFERS)
  	only_save_windows = FALSE;		/* Save ALL buffers */
*** ../vim-7.1.199/src/version.c	Fri Jan  4 15:16:57 2008
--- src/version.c	Fri Jan  4 15:59:46 2008
***************
*** 668,669 ****
--- 668,671 ----
  {   /* Add new patch number below this line */
+ /**/
+     200,
  /**/

-- 
ARTHUR:  I did say sorry about the `old woman,' but from the behind you
         looked--
DENNIS:  What I object to is you automatically treat me like an inferior!
ARTHUR:  Well, I AM king...
                                  The Quest for the Holy Grail (Monty Python)

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\        download, build and distribute -- http://www.A-A-P.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
