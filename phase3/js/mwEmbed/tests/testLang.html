<html>
<head>
<title>Test Plural Conversions (should match php) </title>
<script type="text/javascript" src="../mwEmbed.js"></script>
<style>
td{
	border:solid thin black;
}
</style>
<script type="text/javascript" >

mw.ready( function(){
	//for just setting one or two to test at a time for debug
	var langTestSet = [ 'es' ]; //pl
	//var langTestSet = mw.getConfig( 'languageCodeList' );
	
	//do mauall script loaders calls to test multiple languages:
	function doLangTable( langSet ){		
		//build table output: 
		var msgTestSet = { 												
			'undelete_short' : [ 0, 1, 2, 5, 21, 30 ],			
			//category-subcat-count' has two params:
			'category-subcat-count' : [ 
				[0,10], 
				[1,2], 
				[3,30] 
			],
			'contributions-title' : [0,1,2]
		};
		// Set-up base convert plural and gender (to restore if no language class is set) 
		var baseConvertPlural = mw.lang.convertPlural;
		var baseGender = mw.lang.gender; 
					
		var passTest=0;
		var failTest=0;
		var testCount=0;	

		/**
		* proccess a language key test set
		*/
		function doProcLangKey( langKey ){
			mw.log(" doProcLangKey: " + langKey );
			// Clear out the old digitTransformTable
			mw.lang.digitTransformTable = null;
			// Load the current language js file if it has a langKey 
			if( mw.hasLangTransform (langKey ) ){
				var langName = 'Language' +	langKey.substr(0,1).toUpperCase() + langKey.substr( 1,langKey.length ); 
				$j.getScript( '../languages/classes/' + langName + '.js' , function(){
					doLangTest();
				});			
			} else { 
				doLangTest();
			}
			function doLangTest(){
				// Get the current language mw.testLang js
				$j.getScript( '../../../mwScriptLoader.php?class=mw.testLang&debug=true&uselang='+langKey, function(){						
					var o='';
					o+='<tr><td colspan="6" height="20" style="font-size:large"><b>Lang:' + langKey + '</b></td></tr>';		
					//now for each langage msg: 
					$j.each(msgTestSet, function(mKey, mTestSet){
						//output table names:
						o+='<tr>'+
								'<td>$1[,$2]</td>'+
								'<td width="14%">Msg key</td>'+
								'<td width="34%">Msg text</td>'+
								'<td width="24%">Msg Transform JS</td>'+
								'<td width="24%">Msg Transform Mw</td>'+
							'</tr>';
					
						//for each number value
						for(var i in mTestSet){
							var numVal = mTestSet[i];						
							var numKey = (typeof numVal== 'object')? numVal.join( '_' ).replace('/ /', '_') : numVal;
							var tkey = mKey + '_' + numKey + '_' + langKey; 											
							o+='<tr>'+
									'<td>' + numVal + '</td>' + 
									'<td>' + mKey + '</td>' + 
									'<td>' + mw.lang.msgNoTrans( mKey ) + '</td>' + 
									'<td id="' + tkey + '_js">' + gM( mKey, numVal ) + '</td>';
							//show mw col:						
							if( mKey.substr(0, 5) == 'test_' ){
								o+='<td> (test msg) </td>';
							}else{  
								o+='<td id="' + tkey + '">loading...</td>';					
								
								//get transform from mw (& compare and highlight)
								function doPopWmMsg(mKey, numVal, numKey){ 
									//set the local tkey:
									var tkey = mKey + '_' + numKey + '_' + langKey;
									testCount++;
									$j('#score_card').html('Running Tests <span id="perc_done">0</sapn>% done');	
									var msgparam = (typeof numVal== 'object')? numVal.join( '|' ) : numVal;
									var request = {
										'action' : 'query',
										'meta' : 'allmessages',
										'ammessages' : mKey,
										'amlang' : langKey,
										'amargs' : msgparam,
										'amenableparser' : true
									};		
									mw.getJSON('../../../api.php', request, function( data ) {		
										var t =	'#'+ tkey;				
										var $target = $j( t ) ; 								
										if( data.query && data.query.allmessages && data.query.allmessages[0]){
											var msgText = data.query.allmessages && data.query.allmessages[0]['*'];
											if( msgText == '' ) 
												msgText = ' %missing% ';
											$target.html( msgText );										
											var js_txt = $j.trim( $j(t + '_js').text().replace('\n', '') );
											var php_txt = $j.trim( msgText );											
											// Just get the part in the <p> to compare with js version
											if( js_txt != php_txt ){															
												$target.css('color', 'red');
												failTest++;
											}else{
												$target.css('color', 'green');
												passTest++;
											}
											var perc = ( failTest + passTest ) / testCount
											if( perc != 1){
												$j('#perc_done').html( Math.round(perc*1000)/1000 + '%');
											}else{
												var failHtlm = (failTest == 0)?failTest: '<span style="color:red">'+ failTest+'</span>';
												$j('#score_card').html( 
													'Passed: <span style="color:green">' + passTest + '</span> Failed:' + failHtlm );
													
												//done with this lang... call outer function if we have lang keys left to proccess:
												if( langSet.length !=0 )
													doProcLangKey( langSet.pop() );		
											}			
										}else{
											$target.html(' error ').css('color', 'red');
										}
									});
								};
								//pop off an anonymous function call
								doPopWmMsg(mKey, numVal, numKey);
							} 
							o+='</tr>';										
						}
						//output a spacer:
						o+='<tr><td colspan="6" height="20"> </td></tr>';			
					});
					//put the output into the page: 
					$j('#table_out').append( o );								
				});			
			}
		}//procc lang key:
		
		doProcLangKey( langSet.pop() );
	}
	//by default run the "debug" set:
	doLangTable( langTestSet );
});

</script>
</head>
<body>
<h3>Test Javascript plural msg transformations</h3>
<div id="score_card" style="font-size:large"></div>
<table id="table_out"></table>


</body>
</html>
